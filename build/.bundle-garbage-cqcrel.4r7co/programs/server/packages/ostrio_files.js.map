{"version":3,"sources":["meteor://ðŸ’»app/packages/ostrio:files/server.js","meteor://ðŸ’»app/packages/ostrio:files/core.js","meteor://ðŸ’»app/packages/ostrio:files/cursor.js","meteor://ðŸ’»app/packages/ostrio:files/lib.js","meteor://ðŸ’»app/packages/ostrio:files/write-stream.js"],"names":["module","export","FilesCollection","Mongo","link","v","WebApp","Meteor","Random","Cookies","WriteStream","default","check","Match","FilesCollectionCore","fixJSONParse","fixJSONStringify","helpers","fs","nodeQs","request","fileType","nodePath","bound","bindEnvironment","callback","NOOP","constructor","config","storagePath","debug","schema","public","strict","chunkSize","protected","collection","permissions","cacheControl","downloadRoute","onAfterUpload","onAfterRemove","disableUpload","onBeforeRemove","integrityCheck","collectionName","onBeforeUpload","namingFunction","responseHeaders","disableDownload","allowClientCode","downloadCallback","onInitiateUpload","interceptDownload","continueUploadTTL","parentDirPermissions","_preCollection","_preCollectionName","self","isBoolean","Math","floor","isString","Collection","_name","filesCollection","String","Error","replace","isFunction","isNumber","parseInt","isObject","_currentUploads","responseCode","fileRef","versionRef","headers","Pragma","Trailer","size","Connection","type","sep","sp","apply","arguments","normalize","_debug","mkdirs","mode","error","Boolean","Number","Function","OneOf","Object","_ensureIndex","createdAt","expireAfterSeconds","background","_preCollectionCursor","find","fields","_id","isFinished","observe","changed","doc","remove","removed","stop","end","count","abort","_createStream","path","opts","fileLength","_continueUpload","file","aborted","ended","contUpld","findOne","_checkAccess","http","result","user","userId","_getUser","params","call","assign","rc","text","response","headersSent","writeHead","length","finished","_methodNames","_Abort","_Write","_Start","_Remove","on","_handleUpload","_finishUpload","_handleUploadSync","wrapAsync","bind","connectHandlers","use","httpReq","httpResp","next","_parsedUrl","indexOf","method","handleError","_error","console","warn","trace","toString","JSON","stringify","body","data","_getUserId","fileId","eof","binData","Buffer","from","chunkId","_prepareUpload","meta","emit","parse","jsonErr","___s","name","clone","Date","maxLength","insert","omit","returnMeta","uploadRoute","httpRespErr","uri","uris","substring","split","query","version","download","_file","_methods","selector","userFuncs","users","cursor","FSName","Optional","e","_opts","unblock","handleUploadErr","unlink","methods","transport","ctx","fileName","_getFileName","extension","extensionWithDot","_getExt","ext","_dataToSchema","isUploadAllowed","cb","chmod","_getMimeType","_updateFileTypes","colInsert","update","$set","preUpdateError","write","fileData","mime","buf","alloc","fd","openSync","br","readSync","close","slice","xmtok","server","sessions","Map","has","get","mtok","cookie","buffer","_callback","_proceedAfterUpload","proceedAfterUpload","id","stream","createWriteStream","flags","streamErr","insertErr","load","url","pathParts","storeResult","stat","stats","versions","original","pipe","addFile","statErr","isFile","_storagePath","files","forEach","docs","fetch","deny","rules","allow","denyClient","allowClient","vKey","_404","originalUrl","vRef","responseType","serve","readableStream","_responseType","force200","partiral","reqRange","dispositionType","start","take","dispositionName","encodeURI","encodeURIComponent","dispositionEncoding","setHeader","range","array","isNaN","play","streamErrorHandler","key","respond","code","destroy","createReadStream","EventEmitter","formatFleURL","FilesCursor","FileCursor","info","log","pop","toLowerCase","isVideo","test","isAudio","isImage","isText","isJSON","isPDF","ds","_downloadRoute","_collectionName","options","URIBase","__helpers","optional","blackbox","updatedAt","_fileRef","_collection","property","with","_selector","_current","hasNext","hasPrevious","previous","first","last","context","each","map","current","callbacks","observeChanges","isUndefined","obj","isArray","Array","prototype","isEmpty","isDate","keys","_obj","hasOwnProperty","i","clear","now","throttle","func","wait","timeout","that","args","later","leading","throttled","remaining","clearTimeout","trailing","setTimeout","cancel","_helpers","_URIBase","__meteor_runtime_config__","ROOT_URL","_root","fdCache","writtenChunks","ensureFile","efError","open","oError","num","chunk","written","ceil"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAAA,MAAM,CAACC,MAAP,CAAc;AAACC,iBAAe,EAAC,MAAIA;AAArB,CAAd;AAAqD,IAAIC,KAAJ;AAAUH,MAAM,CAACI,IAAP,CAAY,cAAZ,EAA2B;AAACD,OAAK,CAACE,CAAD,EAAG;AAACF,SAAK,GAACE,CAAN;AAAQ;;AAAlB,CAA3B,EAA+C,CAA/C;AAAkD,IAAIC,MAAJ;AAAWN,MAAM,CAACI,IAAP,CAAY,eAAZ,EAA4B;AAACE,QAAM,CAACD,CAAD,EAAG;AAACC,UAAM,GAACD,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAIE,MAAJ;AAAWP,MAAM,CAACI,IAAP,CAAY,eAAZ,EAA4B;AAACG,QAAM,CAACF,CAAD,EAAG;AAACE,UAAM,GAACF,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAIG,MAAJ;AAAWR,MAAM,CAACI,IAAP,CAAY,eAAZ,EAA4B;AAACI,QAAM,CAACH,CAAD,EAAG;AAACG,UAAM,GAACH,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAII,OAAJ;AAAYT,MAAM,CAACI,IAAP,CAAY,uBAAZ,EAAoC;AAACK,SAAO,CAACJ,CAAD,EAAG;AAACI,WAAO,GAACJ,CAAR;AAAU;;AAAtB,CAApC,EAA4D,CAA5D;AAA+D,IAAIK,WAAJ;AAAgBV,MAAM,CAACI,IAAP,CAAY,mBAAZ,EAAgC;AAACO,SAAO,CAACN,CAAD,EAAG;AAACK,eAAW,GAACL,CAAZ;AAAc;;AAA1B,CAAhC,EAA4D,CAA5D;AAA+D,IAAIO,KAAJ,EAAUC,KAAV;AAAgBb,MAAM,CAACI,IAAP,CAAY,cAAZ,EAA2B;AAACQ,OAAK,CAACP,CAAD,EAAG;AAACO,SAAK,GAACP,CAAN;AAAQ,GAAlB;;AAAmBQ,OAAK,CAACR,CAAD,EAAG;AAACQ,SAAK,GAACR,CAAN;AAAQ;;AAApC,CAA3B,EAAiE,CAAjE;AAAoE,IAAIS,mBAAJ;AAAwBd,MAAM,CAACI,IAAP,CAAY,WAAZ,EAAwB;AAACO,SAAO,CAACN,CAAD,EAAG;AAACS,uBAAmB,GAACT,CAApB;AAAsB;;AAAlC,CAAxB,EAA4D,CAA5D;AAA+D,IAAIU,YAAJ,EAAiBC,gBAAjB,EAAkCC,OAAlC;AAA0CjB,MAAM,CAACI,IAAP,CAAY,UAAZ,EAAuB;AAACW,cAAY,CAACV,CAAD,EAAG;AAACU,gBAAY,GAACV,CAAb;AAAe,GAAhC;;AAAiCW,kBAAgB,CAACX,CAAD,EAAG;AAACW,oBAAgB,GAACX,CAAjB;AAAmB,GAAxE;;AAAyEY,SAAO,CAACZ,CAAD,EAAG;AAACY,WAAO,GAACZ,CAAR;AAAU;;AAA9F,CAAvB,EAAuH,CAAvH;AAA0H,IAAIa,EAAJ;AAAOlB,MAAM,CAACI,IAAP,CAAY,UAAZ,EAAuB;AAACO,SAAO,CAACN,CAAD,EAAG;AAACa,MAAE,GAACb,CAAH;AAAK;;AAAjB,CAAvB,EAA0C,CAA1C;AAA6C,IAAIc,MAAJ;AAAWnB,MAAM,CAACI,IAAP,CAAY,aAAZ,EAA0B;AAACO,SAAO,CAACN,CAAD,EAAG;AAACc,UAAM,GAACd,CAAP;AAAS;;AAArB,CAA1B,EAAiD,EAAjD;AAAqD,IAAIe,OAAJ;AAAYpB,MAAM,CAACI,IAAP,CAAY,SAAZ,EAAsB;AAACO,SAAO,CAACN,CAAD,EAAG;AAACe,WAAO,GAACf,CAAR;AAAU;;AAAtB,CAAtB,EAA8C,EAA9C;AAAkD,IAAIgB,QAAJ;AAAarB,MAAM,CAACI,IAAP,CAAY,WAAZ,EAAwB;AAACO,SAAO,CAACN,CAAD,EAAG;AAACgB,YAAQ,GAAChB,CAAT;AAAW;;AAAvB,CAAxB,EAAiD,EAAjD;AAAqD,IAAIiB,QAAJ;AAAatB,MAAM,CAACI,IAAP,CAAY,MAAZ,EAAmB;AAACO,SAAO,CAACN,CAAD,EAAG;AAACiB,YAAQ,GAACjB,CAAT;AAAW;;AAAvB,CAAnB,EAA4C,EAA5C;;AAgB3hC;;;;AAIA,MAAMkB,KAAK,GAAGhB,MAAM,CAACiB,eAAP,CAAuBC,QAAQ,IAAIA,QAAQ,EAA3C,CAAd;;AACA,MAAMC,IAAI,GAAI,MAAM,CAAI,CAAxB;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA0CO,MAAMxB,eAAN,SAA8BY,mBAA9B,CAAkD;AACvDa,aAAW,CAACC,MAAD,EAAS;AAClB;AACA,QAAIC,WAAJ;;AACA,QAAID,MAAJ,EAAY;AACV,OAAC;AACCC,mBADD;AAECC,aAAK,EAAE,KAAKA,KAFb;AAGCC,cAAM,EAAE,KAAKA,MAHd;AAICC,cAAM,EAAE,KAAKA,MAJd;AAKCC,cAAM,EAAE,KAAKA,MALd;AAMCC,iBAAS,EAAE,KAAKA,SANjB;AAOCC,iBAAS,EAAE,KAAKA,SAPjB;AAQCC,kBAAU,EAAE,KAAKA,UARlB;AASCC,mBAAW,EAAE,KAAKA,WATnB;AAUCC,oBAAY,EAAE,KAAKA,YAVpB;AAWCC,qBAAa,EAAE,KAAKA,aAXrB;AAYCC,qBAAa,EAAE,KAAKA,aAZrB;AAaCC,qBAAa,EAAE,KAAKA,aAbrB;AAcCC,qBAAa,EAAE,KAAKA,aAdrB;AAeCC,sBAAc,EAAE,KAAKA,cAftB;AAgBCC,sBAAc,EAAE,KAAKA,cAhBtB;AAiBCC,sBAAc,EAAE,KAAKA,cAjBtB;AAkBCC,sBAAc,EAAE,KAAKA,cAlBtB;AAmBCC,sBAAc,EAAE,KAAKA,cAnBtB;AAoBCC,uBAAe,EAAE,KAAKA,eApBvB;AAqBCC,uBAAe,EAAE,KAAKA,eArBvB;AAsBCC,uBAAe,EAAE,KAAKA,eAtBvB;AAuBCC,wBAAgB,EAAE,KAAKA,gBAvBxB;AAwBCC,wBAAgB,EAAE,KAAKA,gBAxBxB;AAyBCC,yBAAiB,EAAE,KAAKA,iBAzBzB;AA0BCC,yBAAiB,EAAE,KAAKA,iBA1BzB;AA2BCC,4BAAoB,EAAE,KAAKA,oBA3B5B;AA4BCC,sBAAc,EAAE,KAAKA,cA5BtB;AA6BCC,0BAAkB,EAAE,KAAKA;AA7B1B,UA8BG7B,MA9BJ;AA+BD;;AAED,UAAM8B,IAAI,GAAK,IAAf;AACA,QAAIjD,OAAJ;;AAEA,QAAI,CAACQ,OAAO,CAAC0C,SAAR,CAAkB,KAAK7B,KAAvB,CAAL,EAAoC;AAClC,WAAKA,KAAL,GAAa,KAAb;AACD;;AAED,QAAI,CAACb,OAAO,CAAC0C,SAAR,CAAkB,KAAK3B,MAAvB,CAAL,EAAqC;AACnC,WAAKA,MAAL,GAAc,KAAd;AACD;;AAED,QAAI,CAAC,KAAKG,SAAV,EAAqB;AACnB,WAAKA,SAAL,GAAiB,KAAjB;AACD;;AAED,QAAI,CAAC,KAAKD,SAAV,EAAqB;AACnB,WAAKA,SAAL,GAAiB,OAAO,GAAxB;AACD;;AAED,SAAKA,SAAL,GAAiB0B,IAAI,CAACC,KAAL,CAAW,KAAK3B,SAAL,GAAiB,CAA5B,IAAiC,CAAlD;;AAEA,QAAI,CAACjB,OAAO,CAAC6C,QAAR,CAAiB,KAAKjB,cAAtB,CAAD,IAA0C,CAAC,KAAKT,UAApD,EAAgE;AAC9D,WAAKS,cAAL,GAAsB,mBAAtB;AACD;;AAED,QAAI,CAAC,KAAKT,UAAV,EAAsB;AACpB,WAAKA,UAAL,GAAkB,IAAIjC,KAAK,CAAC4D,UAAV,CAAqB,KAAKlB,cAA1B,CAAlB;AACD,KAFD,MAEO;AACL,WAAKA,cAAL,GAAsB,KAAKT,UAAL,CAAgB4B,KAAtC;AACD;;AAED,SAAK5B,UAAL,CAAgB6B,eAAhB,GAAkC,IAAlC;AACArD,SAAK,CAAC,KAAKiC,cAAN,EAAsBqB,MAAtB,CAAL;;AAEA,QAAI,KAAKlC,MAAL,IAAe,CAAC,KAAKO,aAAzB,EAAwC;AACtC,YAAM,IAAIhC,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAuB,oBAAmB,KAAKtB,cAAe,mKAA9D,CAAN;AACD;;AAED,QAAI,CAAC5B,OAAO,CAAC6C,QAAR,CAAiB,KAAKvB,aAAtB,CAAL,EAA2C;AACzC,WAAKA,aAAL,GAAqB,cAArB;AACD;;AAED,SAAKA,aAAL,GAAqB,KAAKA,aAAL,CAAmB6B,OAAnB,CAA2B,KAA3B,EAAkC,EAAlC,CAArB;;AAEA,QAAI,CAACnD,OAAO,CAACoD,UAAR,CAAmB,KAAKtB,cAAxB,CAAL,EAA8C;AAC5C,WAAKA,cAAL,GAAsB,KAAtB;AACD;;AAED,QAAI,CAAC9B,OAAO,CAACoD,UAAR,CAAmB,KAAKvB,cAAxB,CAAL,EAA8C;AAC5C,WAAKA,cAAL,GAAsB,KAAtB;AACD;;AAED,QAAI,CAAC7B,OAAO,CAAC0C,SAAR,CAAkB,KAAKT,eAAvB,CAAL,EAA8C;AAC5C,WAAKA,eAAL,GAAuB,IAAvB;AACD;;AAED,QAAI,CAACjC,OAAO,CAACoD,UAAR,CAAmB,KAAKjB,gBAAxB,CAAL,EAAgD;AAC9C,WAAKA,gBAAL,GAAwB,KAAxB;AACD;;AAED,QAAI,CAACnC,OAAO,CAACoD,UAAR,CAAmB,KAAKhB,iBAAxB,CAAL,EAAiD;AAC/C,WAAKA,iBAAL,GAAyB,KAAzB;AACD;;AAED,QAAI,CAACpC,OAAO,CAAC0C,SAAR,CAAkB,KAAK1B,MAAvB,CAAL,EAAqC;AACnC,WAAKA,MAAL,GAAc,IAAd;AACD;;AAED,QAAI,CAAChB,OAAO,CAACqD,QAAR,CAAiB,KAAKjC,WAAtB,CAAL,EAAyC;AACvC,WAAKA,WAAL,GAAmBkC,QAAQ,CAAC,KAAD,EAAQ,CAAR,CAA3B;AACD;;AAED,QAAI,CAACtD,OAAO,CAACqD,QAAR,CAAiB,KAAKf,oBAAtB,CAAL,EAAkD;AAChD,WAAKA,oBAAL,GAA4BgB,QAAQ,CAAC,KAAD,EAAQ,CAAR,CAApC;AACD;;AAED,QAAI,CAACtD,OAAO,CAAC6C,QAAR,CAAiB,KAAKxB,YAAtB,CAAL,EAA0C;AACxC,WAAKA,YAAL,GAAoB,6CAApB;AACD;;AAED,QAAI,CAACrB,OAAO,CAACoD,UAAR,CAAmB,KAAK7B,aAAxB,CAAL,EAA6C;AAC3C,WAAKA,aAAL,GAAqB,KAArB;AACD;;AAED,QAAI,CAACvB,OAAO,CAAC0C,SAAR,CAAkB,KAAKjB,aAAvB,CAAL,EAA4C;AAC1C,WAAKA,aAAL,GAAqB,KAArB;AACD;;AAED,QAAI,CAACzB,OAAO,CAACoD,UAAR,CAAmB,KAAK5B,aAAxB,CAAL,EAA6C;AAC3C,WAAKA,aAAL,GAAqB,KAArB;AACD;;AAED,QAAI,CAACxB,OAAO,CAACoD,UAAR,CAAmB,KAAK1B,cAAxB,CAAL,EAA8C;AAC5C,WAAKA,cAAL,GAAsB,KAAtB;AACD;;AAED,QAAI,CAAC1B,OAAO,CAAC0C,SAAR,CAAkB,KAAKf,cAAvB,CAAL,EAA6C;AAC3C,WAAKA,cAAL,GAAsB,IAAtB;AACD;;AAED,QAAI,CAAC3B,OAAO,CAAC0C,SAAR,CAAkB,KAAKV,eAAvB,CAAL,EAA8C;AAC5C,WAAKA,eAAL,GAAuB,KAAvB;AACD;;AAED,QAAI,CAAChC,OAAO,CAACuD,QAAR,CAAiB,KAAKC,eAAtB,CAAL,EAA6C;AAC3C,WAAKA,eAAL,GAAuB,EAAvB;AACD;;AAED,QAAI,CAACxD,OAAO,CAACoD,UAAR,CAAmB,KAAKlB,gBAAxB,CAAL,EAAgD;AAC9C,WAAKA,gBAAL,GAAwB,KAAxB;AACD;;AAED,QAAI,CAAClC,OAAO,CAACqD,QAAR,CAAiB,KAAKhB,iBAAtB,CAAL,EAA+C;AAC7C,WAAKA,iBAAL,GAAyB,KAAzB;AACD;;AAED,QAAI,CAACrC,OAAO,CAACoD,UAAR,CAAmB,KAAKrB,eAAxB,CAAL,EAA+C;AAC7C,WAAKA,eAAL,GAAuB,CAAC0B,YAAD,EAAeC,OAAf,EAAwBC,UAAxB,KAAuC;AAC5D,cAAMC,OAAO,GAAG,EAAhB;;AAEA,gBAAQH,YAAR;AACA,eAAK,KAAL;AACEG,mBAAO,CAACC,MAAR,GAA+B,SAA/B;AACAD,mBAAO,CAACE,OAAR,GAA+B,SAA/B;AACAF,mBAAO,CAAC,mBAAD,CAAP,GAA+B,SAA/B;AACA;;AACF,eAAK,KAAL;AACEA,mBAAO,CAAC,eAAD,CAAP,GAA+B,UAA/B;AACA;;AACF,eAAK,KAAL;AACEA,mBAAO,CAAC,eAAD,CAAP,GAAgC,WAAUD,UAAU,CAACI,IAAK,EAA1D;AACA;;AACF;AACE;AAbF;;AAgBAH,eAAO,CAACI,UAAR,GAA2B,YAA3B;AACAJ,eAAO,CAAC,cAAD,CAAP,GAA2BD,UAAU,CAACM,IAAX,IAAmB,0BAA9C;AACAL,eAAO,CAAC,eAAD,CAAP,GAA2B,OAA3B;AACA,eAAOA,OAAP;AACD,OAvBD;AAwBD;;AAED,QAAI,KAAK7C,MAAL,IAAe,CAACH,WAApB,EAAiC;AAC/B,YAAM,IAAItB,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAuB,oBAAmB,KAAKtB,cAAe,+IAA9D,CAAN;AACD;;AAED,QAAI,CAAChB,WAAL,EAAkB;AAChBA,iBAAW,GAAG,YAAY;AACxB,eAAQ,SAAQP,QAAQ,CAAC6D,GAAI,MAAK7D,QAAQ,CAAC6D,GAAI,UAAS7D,QAAQ,CAAC6D,GAAI,GAAEzB,IAAI,CAACb,cAAe,EAA3F;AACD,OAFD;AAGD;;AAED,QAAI5B,OAAO,CAAC6C,QAAR,CAAiBjC,WAAjB,CAAJ,EAAmC;AACjC,WAAKA,WAAL,GAAmB,MAAMA,WAAzB;AACD,KAFD,MAEO;AACL,WAAKA,WAAL,GAAmB,YAAY;AAC7B,YAAIuD,EAAE,GAAGvD,WAAW,CAACwD,KAAZ,CAAkB3B,IAAlB,EAAwB4B,SAAxB,CAAT;;AACA,YAAI,CAACrE,OAAO,CAAC6C,QAAR,CAAiBsB,EAAjB,CAAL,EAA2B;AACzB,gBAAM,IAAI7E,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAuB,oBAAmBT,IAAI,CAACb,cAAe,gDAA9D,CAAN;AACD;;AACDuC,UAAE,GAAGA,EAAE,CAAChB,OAAH,CAAW,KAAX,EAAkB,EAAlB,CAAL;AACA,eAAO9C,QAAQ,CAACiE,SAAT,CAAmBH,EAAnB,CAAP;AACD,OAPD;AAQD;;AAED,SAAKI,MAAL,CAAY,uCAAZ,EAAqD,KAAK3D,WAAL,CAAiB,EAAjB,CAArD;;AAEAX,MAAE,CAACuE,MAAH,CAAU,KAAK5D,WAAL,CAAiB,EAAjB,CAAV,EAAgC;AAAE6D,UAAI,EAAE,KAAKnC;AAAb,KAAhC,EAAsEoC,KAAD,IAAW;AAC9E,UAAIA,KAAJ,EAAW;AACT,cAAM,IAAIpF,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAuB,oBAAmBT,IAAI,CAACb,cAAe,WAAU,KAAKhB,WAAL,CAAiB,EAAjB,CAAqB,sBAAqB8D,KAAM,EAAxH,CAAN;AACD;AACF,KAJD;AAMA/E,SAAK,CAAC,KAAKqB,MAAN,EAAc2D,OAAd,CAAL;AACAhF,SAAK,CAAC,KAAKyB,WAAN,EAAmBwD,MAAnB,CAAL;AACAjF,SAAK,CAAC,KAAKiB,WAAN,EAAmBiE,QAAnB,CAAL;AACAlF,SAAK,CAAC,KAAK0B,YAAN,EAAoB4B,MAApB,CAAL;AACAtD,SAAK,CAAC,KAAK6B,aAAN,EAAqB5B,KAAK,CAACkF,KAAN,CAAY,KAAZ,EAAmBD,QAAnB,CAArB,CAAL;AACAlF,SAAK,CAAC,KAAK4B,aAAN,EAAqB3B,KAAK,CAACkF,KAAN,CAAY,KAAZ,EAAmBD,QAAnB,CAArB,CAAL;AACAlF,SAAK,CAAC,KAAK8B,aAAN,EAAqBkD,OAArB,CAAL;AACAhF,SAAK,CAAC,KAAKgC,cAAN,EAAsBgD,OAAtB,CAAL;AACAhF,SAAK,CAAC,KAAK+B,cAAN,EAAsB9B,KAAK,CAACkF,KAAN,CAAY,KAAZ,EAAmBD,QAAnB,CAAtB,CAAL;AACAlF,SAAK,CAAC,KAAKqC,eAAN,EAAuB2C,OAAvB,CAAL;AACAhF,SAAK,CAAC,KAAKuC,gBAAN,EAAwBtC,KAAK,CAACkF,KAAN,CAAY,KAAZ,EAAmBD,QAAnB,CAAxB,CAAL;AACAlF,SAAK,CAAC,KAAKyC,iBAAN,EAAyBxC,KAAK,CAACkF,KAAN,CAAY,KAAZ,EAAmBD,QAAnB,CAAzB,CAAL;AACAlF,SAAK,CAAC,KAAK0C,iBAAN,EAAyBuC,MAAzB,CAAL;AACAjF,SAAK,CAAC,KAAKoC,eAAN,EAAuBnC,KAAK,CAACkF,KAAN,CAAYC,MAAZ,EAAoBF,QAApB,CAAvB,CAAL;;AAEA,QAAI,CAAC,KAAKpD,aAAV,EAAyB;AACvB,UAAI,CAACzB,OAAO,CAAC6C,QAAR,CAAiB,KAAKL,kBAAtB,CAAD,IAA8C,CAAC,KAAKD,cAAxD,EAAwE;AACtE,aAAKC,kBAAL,GAA2B,SAAQ,KAAKZ,cAAe,EAAvD;AACD;;AAED,UAAI,CAAC,KAAKW,cAAV,EAA0B;AACxB,aAAKA,cAAL,GAAsB,IAAIrD,KAAK,CAAC4D,UAAV,CAAqB,KAAKN,kBAA1B,CAAtB;AACD,OAFD,MAEO;AACL,aAAKA,kBAAL,GAA0B,KAAKD,cAAL,CAAoBQ,KAA9C;AACD;;AACDpD,WAAK,CAAC,KAAK6C,kBAAN,EAA0BS,MAA1B,CAAL;;AAEA,WAAKV,cAAL,CAAoByC,YAApB,CAAiC;AAAEC,iBAAS,EAAE;AAAb,OAAjC,EAAmD;AAAEC,0BAAkB,EAAE,KAAK7C,iBAA3B;AAA8C8C,kBAAU,EAAE;AAA1D,OAAnD;;AACA,YAAMC,oBAAoB,GAAG,KAAK7C,cAAL,CAAoB8C,IAApB,CAAyB,EAAzB,EAA6B;AACxDC,cAAM,EAAE;AACNC,aAAG,EAAE,CADC;AAENC,oBAAU,EAAE;AAFN;AADgD,OAA7B,CAA7B;;AAOAJ,0BAAoB,CAACK,OAArB,CAA6B;AAC3BC,eAAO,CAACC,GAAD,EAAM;AACX,cAAIA,GAAG,CAACH,UAAR,EAAoB;AAClB/C,gBAAI,CAAC8B,MAAL,CAAa,+DAA8DoB,GAAG,CAACJ,GAAI,EAAnF;;AACA9C,gBAAI,CAACF,cAAL,CAAoBqD,MAApB,CAA2B;AAACL,iBAAG,EAAEI,GAAG,CAACJ;AAAV,aAA3B,EAA2C9E,IAA3C;AACD;AACF,SAN0B;;AAO3BoF,eAAO,CAACF,GAAD,EAAM;AACX;AACA;AACAlD,cAAI,CAAC8B,MAAL,CAAa,+DAA8DoB,GAAG,CAACJ,GAAI,EAAnF;;AACA,cAAIvF,OAAO,CAACuD,QAAR,CAAiBd,IAAI,CAACe,eAAL,CAAqBmC,GAAG,CAACJ,GAAzB,CAAjB,CAAJ,EAAqD;AACnD9C,gBAAI,CAACe,eAAL,CAAqBmC,GAAG,CAACJ,GAAzB,EAA8BO,IAA9B;;AACArD,gBAAI,CAACe,eAAL,CAAqBmC,GAAG,CAACJ,GAAzB,EAA8BQ,GAA9B,GAFmD,CAInD;AACA;;;AACA,gBAAI,CAACJ,GAAG,CAACH,UAAL,IAAmB/C,IAAI,CAACtB,UAAL,CAAgBkE,IAAhB,CAAqB;AAAEE,iBAAG,EAAEI,GAAG,CAACJ;AAAX,aAArB,EAAuCS,KAAvC,OAAmD,CAA1E,EAA6E;AAC3EvD,kBAAI,CAAC8B,MAAL,CAAa,8EAA6EoB,GAAG,CAACJ,GAAI,EAAlG;;AACA9C,kBAAI,CAACe,eAAL,CAAqBmC,GAAG,CAACJ,GAAzB,EAA8BU,KAA9B;AACD;;AAED,mBAAOxD,IAAI,CAACe,eAAL,CAAqBmC,GAAG,CAACJ,GAAzB,CAAP;AACD;AACF;;AAxB0B,OAA7B;;AA2BA,WAAKW,aAAL,GAAqB,CAACX,GAAD,EAAMY,IAAN,EAAYC,IAAZ,KAAqB;AACxC,aAAK5C,eAAL,CAAqB+B,GAArB,IAA4B,IAAI9F,WAAJ,CAAgB0G,IAAhB,EAAsBC,IAAI,CAACC,UAA3B,EAAuCD,IAAvC,EAA6C,KAAKhF,WAAlD,CAA5B;AACD,OAFD,CA/CuB,CAmDvB;AACA;;;AACA,WAAKkF,eAAL,GAAwBf,GAAD,IAAS;AAC9B,YAAI,KAAK/B,eAAL,CAAqB+B,GAArB,KAA6B,KAAK/B,eAAL,CAAqB+B,GAArB,EAA0BgB,IAA3D,EAAiE;AAC/D,cAAI,CAAC,KAAK/C,eAAL,CAAqB+B,GAArB,EAA0BiB,OAA3B,IAAsC,CAAC,KAAKhD,eAAL,CAAqB+B,GAArB,EAA0BkB,KAArE,EAA4E;AAC1E,mBAAO,KAAKjD,eAAL,CAAqB+B,GAArB,EAA0BgB,IAAjC;AACD;;AACD,eAAKL,aAAL,CAAmBX,GAAnB,EAAwB,KAAK/B,eAAL,CAAqB+B,GAArB,EAA0BgB,IAA1B,CAA+BA,IAA/B,CAAoCJ,IAA5D,EAAkE,KAAK3C,eAAL,CAAqB+B,GAArB,EAA0BgB,IAA5F;;AACA,iBAAO,KAAK/C,eAAL,CAAqB+B,GAArB,EAA0BgB,IAAjC;AACD;;AACD,cAAMG,QAAQ,GAAG,KAAKnE,cAAL,CAAoBoE,OAApB,CAA4B;AAACpB;AAAD,SAA5B,CAAjB;;AACA,YAAImB,QAAJ,EAAc;AACZ,eAAKR,aAAL,CAAmBX,GAAnB,EAAwBmB,QAAQ,CAACH,IAAT,CAAcJ,IAAtC,EAA4CO,QAA5C;;AACA,iBAAO,KAAKlD,eAAL,CAAqB+B,GAArB,EAA0BgB,IAAjC;AACD;;AACD,eAAO,KAAP;AACD,OAdD;AAeD;;AAED,QAAI,CAAC,KAAKzF,MAAV,EAAkB;AAChB,WAAKA,MAAL,GAAcjB,mBAAmB,CAACiB,MAAlC;AACD;;AAEDnB,SAAK,CAAC,KAAKkB,KAAN,EAAa8D,OAAb,CAAL;AACAhF,SAAK,CAAC,KAAKmB,MAAN,EAAciE,MAAd,CAAL;AACApF,SAAK,CAAC,KAAKoB,MAAN,EAAc4D,OAAd,CAAL;AACAhF,SAAK,CAAC,KAAKuB,SAAN,EAAiBtB,KAAK,CAACkF,KAAN,CAAYH,OAAZ,EAAqBE,QAArB,CAAjB,CAAL;AACAlF,SAAK,CAAC,KAAKsB,SAAN,EAAiB2D,MAAjB,CAAL;AACAjF,SAAK,CAAC,KAAK2B,aAAN,EAAqB2B,MAArB,CAAL;AACAtD,SAAK,CAAC,KAAKmC,cAAN,EAAsBlC,KAAK,CAACkF,KAAN,CAAY,KAAZ,EAAmBD,QAAnB,CAAtB,CAAL;AACAlF,SAAK,CAAC,KAAKkC,cAAN,EAAsBjC,KAAK,CAACkF,KAAN,CAAY,KAAZ,EAAmBD,QAAnB,CAAtB,CAAL;AACAlF,SAAK,CAAC,KAAKwC,gBAAN,EAAwBvC,KAAK,CAACkF,KAAN,CAAY,KAAZ,EAAmBD,QAAnB,CAAxB,CAAL;AACAlF,SAAK,CAAC,KAAKsC,eAAN,EAAuB0C,OAAvB,CAAL;;AAEA,QAAI,KAAK5D,MAAL,IAAe,KAAKG,SAAxB,EAAmC;AACjC,YAAM,IAAI5B,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAuB,oBAAmB,KAAKtB,cAAe,4DAA9D,CAAN;AACD;;AAED,SAAKgF,YAAL,GAAqBC,IAAD,IAAU;AAC5B,UAAI,KAAK3F,SAAT,EAAoB;AAClB,YAAI4F,MAAJ;;AACA,cAAM;AAACC,cAAD;AAAOC;AAAP,YAAiB,KAAKC,QAAL,CAAcJ,IAAd,CAAvB;;AAEA,YAAI7G,OAAO,CAACoD,UAAR,CAAmB,KAAKlC,SAAxB,CAAJ,EAAwC;AACtC,cAAIwC,OAAJ;;AACA,cAAI1D,OAAO,CAACuD,QAAR,CAAiBsD,IAAI,CAACK,MAAtB,KAAkCL,IAAI,CAACK,MAAL,CAAY3B,GAAlD,EAAuD;AACrD7B,mBAAO,GAAG,KAAKvC,UAAL,CAAgBwF,OAAhB,CAAwBE,IAAI,CAACK,MAAL,CAAY3B,GAApC,CAAV;AACD;;AAEDuB,gBAAM,GAAGD,IAAI,GAAG,KAAK3F,SAAL,CAAeiG,IAAf,CAAoBpC,MAAM,CAACqC,MAAP,CAAcP,IAAd,EAAoB;AAACE,gBAAD;AAAOC;AAAP,WAApB,CAApB,EAA0DtD,OAAO,IAAI,IAArE,CAAH,GAAiF,KAAKxC,SAAL,CAAeiG,IAAf,CAAoB;AAACJ,gBAAD;AAAOC;AAAP,WAApB,EAAqCtD,OAAO,IAAI,IAAhD,CAA9F;AACD,SAPD,MAOO;AACLoD,gBAAM,GAAG,CAAC,CAACE,MAAX;AACD;;AAED,YAAKH,IAAI,IAAKC,MAAM,KAAK,IAArB,IAA+B,CAACD,IAApC,EAA0C;AACxC,iBAAO,IAAP;AACD;;AAED,cAAMQ,EAAE,GAAGrH,OAAO,CAACqD,QAAR,CAAiByD,MAAjB,IAA2BA,MAA3B,GAAoC,GAA/C;;AACA,aAAKvC,MAAL,CAAY,qDAAZ;;AACA,YAAIsC,IAAJ,EAAU;AACR,gBAAMS,IAAI,GAAG,gBAAb;;AACA,cAAI,CAACT,IAAI,CAACU,QAAL,CAAcC,WAAnB,EAAgC;AAC9BX,gBAAI,CAACU,QAAL,CAAcE,SAAd,CAAwBJ,EAAxB,EAA4B;AAC1B,8BAAgB,YADU;AAE1B,gCAAkBC,IAAI,CAACI;AAFG,aAA5B;AAID;;AAED,cAAI,CAACb,IAAI,CAACU,QAAL,CAAcI,QAAnB,EAA6B;AAC3Bd,gBAAI,CAACU,QAAL,CAAcxB,GAAd,CAAkBuB,IAAlB;AACD;AACF;;AAED,eAAO,KAAP;AACD;;AACD,aAAO,IAAP;AACD,KAvCD;;AAyCA,SAAKM,YAAL,GAAoB;AAClBC,YAAM,EAAG,yBAAwB,KAAKjG,cAAe,EADnC;AAElBkG,YAAM,EAAG,yBAAwB,KAAKlG,cAAe,EAFnC;AAGlBmG,YAAM,EAAG,yBAAwB,KAAKnG,cAAe,EAHnC;AAIlBoG,aAAO,EAAG,0BAAyB,KAAKpG,cAAe;AAJrC,KAApB;AAOA,SAAKqG,EAAL,CAAQ,eAAR,EAAyB,KAAKC,aAA9B;AACA,SAAKD,EAAL,CAAQ,eAAR,EAAyB,KAAKE,aAA9B;AACA,SAAKC,iBAAL,GAAyB9I,MAAM,CAAC+I,SAAP,CAAiB,KAAKH,aAAL,CAAmBI,IAAnB,CAAwB,IAAxB,CAAjB,CAAzB;;AAEA,QAAI,KAAK7G,aAAL,IAAsB,KAAKO,eAA/B,EAAgD;AAC9C;AACD;;AACD3C,UAAM,CAACkJ,eAAP,CAAuBC,GAAvB,CAA2B,CAACC,OAAD,EAAUC,QAAV,EAAoBC,IAApB,KAA6B;AACtD,UAAI,CAAC,KAAKlH,aAAN,IAAuB,CAAC,CAAC,CAACgH,OAAO,CAACG,UAAR,CAAmBzC,IAAnB,CAAwB0C,OAAxB,CAAiC,GAAE,KAAKvH,aAAc,IAAG,KAAKM,cAAe,WAA7E,CAA9B,EAAwH;AACtH,YAAI6G,OAAO,CAACK,MAAR,KAAmB,MAAvB,EAA+B;AAC7B,gBAAMC,WAAW,GAAIC,MAAD,IAAY;AAC9B,gBAAItE,KAAK,GAAGsE,MAAZ;AACAC,mBAAO,CAACC,IAAR,CAAa,8CAAb,EAA6DxE,KAA7D;AACAuE,mBAAO,CAACE,KAAR;;AAEA,gBAAI,CAACT,QAAQ,CAAClB,WAAd,EAA2B;AACzBkB,sBAAQ,CAACjB,SAAT,CAAmB,GAAnB;AACD;;AAED,gBAAI,CAACiB,QAAQ,CAACf,QAAd,EAAwB;AACtB,kBAAI3H,OAAO,CAACuD,QAAR,CAAiBmB,KAAjB,KAA2B1E,OAAO,CAACoD,UAAR,CAAmBsB,KAAK,CAAC0E,QAAzB,CAA/B,EAAmE;AACjE1E,qBAAK,GAAGA,KAAK,CAAC0E,QAAN,EAAR;AACD;;AAED,kBAAI,CAACpJ,OAAO,CAAC6C,QAAR,CAAiB6B,KAAjB,CAAL,EAA8B;AAC5BA,qBAAK,GAAG,mBAAR;AACD;;AAEDgE,sBAAQ,CAAC3C,GAAT,CAAasD,IAAI,CAACC,SAAL,CAAe;AAAE5E;AAAF,eAAf,CAAb;AACD;AACF,WApBD;;AAsBA,cAAI6E,IAAI,GAAG,EAAX;AACAd,iBAAO,CAACR,EAAR,CAAW,MAAX,EAAoBuB,IAAD,IAAUlJ,KAAK,CAAC,MAAM;AACvCiJ,gBAAI,IAAIC,IAAR;AACD,WAFiC,CAAlC;AAIAf,iBAAO,CAACR,EAAR,CAAW,KAAX,EAAkB,MAAM3H,KAAK,CAAC,MAAM;AAClC,gBAAI;AACF,kBAAI8F,IAAJ;AACA,kBAAIU,MAAJ;AACA,kBAAIC,IAAJ;;AAEA,kBAAI0B,OAAO,CAAC7E,OAAR,CAAgB,QAAhB,KAA6B,KAAK6F,UAAL,CAAgBhB,OAAO,CAAC7E,OAAR,CAAgB,QAAhB,CAAhB,CAAjC,EAA6E;AAC3EmD,oBAAI,GAAG;AACLC,wBAAM,EAAE,KAAKyC,UAAL,CAAgBhB,OAAO,CAAC7E,OAAR,CAAgB,QAAhB,CAAhB;AADH,iBAAP;AAGD,eAJD,MAIO;AACLmD,oBAAI,GAAG,KAAKE,QAAL,CAAc;AAAC9G,yBAAO,EAAEsI,OAAV;AAAmBlB,0BAAQ,EAAEmB;AAA7B,iBAAd,CAAP;AACD;;AAED,kBAAID,OAAO,CAAC7E,OAAR,CAAgB,SAAhB,MAA+B,GAAnC,EAAwC;AACtCwC,oBAAI,GAAG;AACLsD,wBAAM,EAAEjB,OAAO,CAAC7E,OAAR,CAAgB,UAAhB;AADH,iBAAP;;AAIA,oBAAI6E,OAAO,CAAC7E,OAAR,CAAgB,OAAhB,MAA6B,GAAjC,EAAsC;AACpCwC,sBAAI,CAACuD,GAAL,GAAW,IAAX;AACD,iBAFD,MAEO;AACLvD,sBAAI,CAACwD,OAAL,GAAeC,MAAM,CAACC,IAAP,CAAYP,IAAZ,EAAkB,QAAlB,CAAf;AACAnD,sBAAI,CAAC2D,OAAL,GAAezG,QAAQ,CAACmF,OAAO,CAAC7E,OAAR,CAAgB,WAAhB,CAAD,CAAvB;AACD;;AAED,sBAAM0C,eAAe,GAAG,KAAKA,eAAL,CAAqBF,IAAI,CAACsD,MAA1B,CAAxB;;AACA,oBAAI,CAACpD,eAAL,EAAsB;AACpB,wBAAM,IAAIhH,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAsB,8DAAtB,CAAN;AACD;;AAED,iBAAC;AAAC4D,wBAAD;AAASV;AAAT,oBAAkB,KAAK4D,cAAL,CAAoBjF,MAAM,CAACqC,MAAP,CAAchB,IAAd,EAAoBE,eAApB,CAApB,EAA0DS,IAAI,CAACC,MAA/D,EAAuE,MAAvE,CAAnB;;AAEA,oBAAIZ,IAAI,CAACuD,GAAT,EAAc;AACZ,uBAAKzB,aAAL,CAAmBpB,MAAnB,EAA2BV,IAA3B,EAAkC4C,MAAD,IAAY;AAC3C,wBAAItE,KAAK,GAAGsE,MAAZ;;AACA,wBAAItE,KAAJ,EAAW;AACT,0BAAI,CAACgE,QAAQ,CAAClB,WAAd,EAA2B;AACzBkB,gCAAQ,CAACjB,SAAT,CAAmB,GAAnB;AACD;;AAED,0BAAI,CAACiB,QAAQ,CAACf,QAAd,EAAwB;AACtB,4BAAI3H,OAAO,CAACuD,QAAR,CAAiBmB,KAAjB,KAA2B1E,OAAO,CAACoD,UAAR,CAAmBsB,KAAK,CAAC0E,QAAzB,CAA/B,EAAmE;AACjE1E,+BAAK,GAAGA,KAAK,CAAC0E,QAAN,EAAR;AACD;;AAED,4BAAI,CAACpJ,OAAO,CAAC6C,QAAR,CAAiB6B,KAAjB,CAAL,EAA8B;AAC5BA,+BAAK,GAAG,mBAAR;AACD;;AAEDgE,gCAAQ,CAAC3C,GAAT,CAAasD,IAAI,CAACC,SAAL,CAAe;AAAE5E;AAAF,yBAAf,CAAb;AACD;AACF;;AAED,wBAAI,CAACgE,QAAQ,CAAClB,WAAd,EAA2B;AACzBkB,8BAAQ,CAACjB,SAAT,CAAmB,GAAnB;AACD;;AAED,wBAAIzH,OAAO,CAACuD,QAAR,CAAiBuD,MAAM,CAACP,IAAxB,KAAiCO,MAAM,CAACP,IAAP,CAAY0D,IAAjD,EAAuD;AACrDnD,4BAAM,CAACP,IAAP,CAAY0D,IAAZ,GAAmBlK,gBAAgB,CAAC+G,MAAM,CAACP,IAAP,CAAY0D,IAAb,CAAnC;AACD;;AAED,wBAAI,CAACvB,QAAQ,CAACf,QAAd,EAAwB;AACtBe,8BAAQ,CAAC3C,GAAT,CAAasD,IAAI,CAACC,SAAL,CAAexC,MAAf,CAAb;AACD;AACF,mBA/BD;;AAgCA;AACD;;AAED,qBAAKoD,IAAL,CAAU,eAAV,EAA2BpD,MAA3B,EAAmCV,IAAnC,EAAyC3F,IAAzC;;AAEA,oBAAI,CAACiI,QAAQ,CAAClB,WAAd,EAA2B;AACzBkB,0BAAQ,CAACjB,SAAT,CAAmB,GAAnB;AACD;;AACD,oBAAI,CAACiB,QAAQ,CAACf,QAAd,EAAwB;AACtBe,0BAAQ,CAAC3C,GAAT;AACD;AACF,eA/DD,MA+DO;AACL,oBAAI;AACFK,sBAAI,GAAGiD,IAAI,CAACc,KAAL,CAAWZ,IAAX,CAAP;AACD,iBAFD,CAEE,OAAOa,OAAP,EAAgB;AAChBnB,yBAAO,CAACvE,KAAR,CAAc,uFAAd,EAAuG0F,OAAvG;AACAhE,sBAAI,GAAG;AAACG,wBAAI,EAAE;AAAP,mBAAP;AACD;;AAED,oBAAI,CAACvG,OAAO,CAACuD,QAAR,CAAiB6C,IAAI,CAACG,IAAtB,CAAL,EAAkC;AAChCH,sBAAI,CAACG,IAAL,GAAY,EAAZ;AACD;;AAEDH,oBAAI,CAACiE,IAAL,GAAY,IAAZ;;AACA,qBAAK9F,MAAL,CAAa,uCAAsC6B,IAAI,CAACG,IAAL,CAAU+D,IAAV,IAAkB,WAAY,MAAKlE,IAAI,CAACsD,MAAO,EAAlG;;AACA,oBAAI1J,OAAO,CAACuD,QAAR,CAAiB6C,IAAI,CAACG,IAAtB,KAA+BH,IAAI,CAACG,IAAL,CAAU0D,IAA7C,EAAmD;AACjD7D,sBAAI,CAACG,IAAL,CAAU0D,IAAV,GAAiBnK,YAAY,CAACsG,IAAI,CAACG,IAAL,CAAU0D,IAAX,CAA7B;AACD;;AAED,iBAAC;AAACnD;AAAD,oBAAW,KAAKkD,cAAL,CAAoBhK,OAAO,CAACuK,KAAR,CAAcnE,IAAd,CAApB,EAAyCW,IAAI,CAACC,MAA9C,EAAsD,mBAAtD,CAAZ;;AAEA,oBAAI,KAAK7F,UAAL,CAAgBwF,OAAhB,CAAwBG,MAAM,CAACvB,GAA/B,CAAJ,EAAyC;AACvC,wBAAM,IAAIjG,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAsB,kDAAtB,CAAN;AACD;;AAEDkD,oBAAI,CAACb,GAAL,GAAiBa,IAAI,CAACsD,MAAtB;AACAtD,oBAAI,CAACnB,SAAL,GAAiB,IAAIuF,IAAJ,EAAjB;AACApE,oBAAI,CAACqE,SAAL,GAAiBrE,IAAI,CAACC,UAAtB;;AACA,qBAAK9D,cAAL,CAAoBmI,MAApB,CAA2B1K,OAAO,CAAC2K,IAAR,CAAavE,IAAb,EAAmB,MAAnB,CAA3B;;AACA,qBAAKF,aAAL,CAAmBY,MAAM,CAACvB,GAA1B,EAA+BuB,MAAM,CAACX,IAAtC,EAA4CnG,OAAO,CAAC2K,IAAR,CAAavE,IAAb,EAAmB,MAAnB,CAA5C;;AAEA,oBAAIA,IAAI,CAACwE,UAAT,EAAqB;AACnB,sBAAI,CAAClC,QAAQ,CAAClB,WAAd,EAA2B;AACzBkB,4BAAQ,CAACjB,SAAT,CAAmB,GAAnB;AACD;;AAED,sBAAI,CAACiB,QAAQ,CAACf,QAAd,EAAwB;AACtBe,4BAAQ,CAAC3C,GAAT,CAAasD,IAAI,CAACC,SAAL,CAAe;AAC1BuB,iCAAW,EAAG,GAAE,KAAKvJ,aAAc,IAAG,KAAKM,cAAe,WADhC;AAE1B2E,0BAAI,EAAEO;AAFoB,qBAAf,CAAb;AAID;AACF,iBAXD,MAWO;AACL,sBAAI,CAAC4B,QAAQ,CAAClB,WAAd,EAA2B;AACzBkB,4BAAQ,CAACjB,SAAT,CAAmB,GAAnB;AACD;;AAED,sBAAI,CAACiB,QAAQ,CAACf,QAAd,EAAwB;AACtBe,4BAAQ,CAAC3C,GAAT;AACD;AACF;AACF;AACF,aA/HD,CA+HE,OAAO+E,WAAP,EAAoB;AACpB/B,yBAAW,CAAC+B,WAAD,CAAX;AACD;AACF,WAnI4B,CAA7B;AAoID,SAhKD,MAgKO;AACLnC,cAAI;AACL;;AACD;AACD;;AAED,UAAI,CAAC,KAAK3G,eAAV,EAA2B;AACzB,YAAI6E,IAAJ;AACA,YAAIK,MAAJ;AACA,YAAI6D,GAAJ;AACA,YAAIC,IAAJ;;AAEA,YAAI,CAAC,KAAKjK,MAAV,EAAkB;AAChB,cAAI,CAAC,CAAC,CAAC0H,OAAO,CAACG,UAAR,CAAmBzC,IAAnB,CAAwB0C,OAAxB,CAAiC,GAAE,KAAKvH,aAAc,IAAG,KAAKM,cAAe,EAA7E,CAAP,EAAwF;AACtFmJ,eAAG,GAAGtC,OAAO,CAACG,UAAR,CAAmBzC,IAAnB,CAAwBhD,OAAxB,CAAiC,GAAE,KAAK7B,aAAc,IAAG,KAAKM,cAAe,EAA7E,EAAgF,EAAhF,CAAN;;AACA,gBAAImJ,GAAG,CAAClC,OAAJ,CAAY,GAAZ,MAAqB,CAAzB,EAA4B;AAC1BkC,iBAAG,GAAGA,GAAG,CAACE,SAAJ,CAAc,CAAd,CAAN;AACD;;AAEDD,gBAAI,GAAGD,GAAG,CAACG,KAAJ,CAAU,GAAV,CAAP;;AACA,gBAAIF,IAAI,CAACtD,MAAL,KAAgB,CAApB,EAAuB;AACrBR,oBAAM,GAAG;AACP3B,mBAAG,EAAEyF,IAAI,CAAC,CAAD,CADF;AAEPG,qBAAK,EAAE1C,OAAO,CAACG,UAAR,CAAmBuC,KAAnB,GAA2BjL,MAAM,CAACiK,KAAP,CAAa1B,OAAO,CAACG,UAAR,CAAmBuC,KAAhC,CAA3B,GAAoE,EAFpE;AAGPb,oBAAI,EAAEU,IAAI,CAAC,CAAD,CAAJ,CAAQE,KAAR,CAAc,GAAd,EAAmB,CAAnB,CAHC;AAIPE,uBAAO,EAAEJ,IAAI,CAAC,CAAD;AAJN,eAAT;AAOAnE,kBAAI,GAAG;AAAC1G,uBAAO,EAAEsI,OAAV;AAAmBlB,wBAAQ,EAAEmB,QAA7B;AAAuCxB;AAAvC,eAAP;;AACA,kBAAI,KAAKN,YAAL,CAAkBC,IAAlB,CAAJ,EAA6B;AAC3B,qBAAKwE,QAAL,CAAcxE,IAAd,EAAoBmE,IAAI,CAAC,CAAD,CAAxB,EAA6B,KAAK7J,UAAL,CAAgBwF,OAAhB,CAAwBqE,IAAI,CAAC,CAAD,CAA5B,CAA7B;AACD;AACF,aAZD,MAYO;AACLrC,kBAAI;AACL;AACF,WAtBD,MAsBO;AACLA,gBAAI;AACL;AACF,SA1BD,MA0BO;AACL,cAAI,CAAC,CAAC,CAACF,OAAO,CAACG,UAAR,CAAmBzC,IAAnB,CAAwB0C,OAAxB,CAAiC,GAAE,KAAKvH,aAAc,EAAtD,CAAP,EAAiE;AAC/DyJ,eAAG,GAAGtC,OAAO,CAACG,UAAR,CAAmBzC,IAAnB,CAAwBhD,OAAxB,CAAiC,GAAE,KAAK7B,aAAc,EAAtD,EAAyD,EAAzD,CAAN;;AACA,gBAAIyJ,GAAG,CAAClC,OAAJ,CAAY,GAAZ,MAAqB,CAAzB,EAA4B;AAC1BkC,iBAAG,GAAGA,GAAG,CAACE,SAAJ,CAAc,CAAd,CAAN;AACD;;AAEDD,gBAAI,GAAID,GAAG,CAACG,KAAJ,CAAU,GAAV,CAAR;AACA,gBAAII,KAAK,GAAGN,IAAI,CAACA,IAAI,CAACtD,MAAL,GAAc,CAAf,CAAhB;;AACA,gBAAI4D,KAAJ,EAAW;AACT,kBAAIF,OAAJ;;AACA,kBAAI,CAAC,CAAC,CAACE,KAAK,CAACzC,OAAN,CAAc,GAAd,CAAP,EAA2B;AACzBuC,uBAAO,GAAGE,KAAK,CAACJ,KAAN,CAAY,GAAZ,EAAiB,CAAjB,CAAV;AACAI,qBAAK,GAAKA,KAAK,CAACJ,KAAN,CAAY,GAAZ,EAAiB,CAAjB,EAAoBA,KAApB,CAA0B,GAA1B,EAA+B,CAA/B,CAAV;AACD,eAHD,MAGO;AACLE,uBAAO,GAAG,UAAV;AACAE,qBAAK,GAAKA,KAAK,CAACJ,KAAN,CAAY,GAAZ,EAAiB,CAAjB,CAAV;AACD;;AAEDhE,oBAAM,GAAG;AACPiE,qBAAK,EAAE1C,OAAO,CAACG,UAAR,CAAmBuC,KAAnB,GAA2BjL,MAAM,CAACiK,KAAP,CAAa1B,OAAO,CAACG,UAAR,CAAmBuC,KAAhC,CAA3B,GAAoE,EADpE;AAEP5E,oBAAI,EAAE+E,KAFC;AAGP/F,mBAAG,EAAE+F,KAAK,CAACJ,KAAN,CAAY,GAAZ,EAAiB,CAAjB,CAHE;AAIPE,uBAJO;AAKPd,oBAAI,EAAEgB;AALC,eAAT;AAOAzE,kBAAI,GAAG;AAAC1G,uBAAO,EAAEsI,OAAV;AAAmBlB,wBAAQ,EAAEmB,QAA7B;AAAuCxB;AAAvC,eAAP;AACA,mBAAKmE,QAAL,CAAcxE,IAAd,EAAoBuE,OAApB,EAA6B,KAAKjK,UAAL,CAAgBwF,OAAhB,CAAwBO,MAAM,CAAC3B,GAA/B,CAA7B;AACD,aAnBD,MAmBO;AACLoD,kBAAI;AACL;AACF,WA9BD,MA8BO;AACLA,gBAAI;AACL;AACF;;AACD;AACD;;AACDA,UAAI;AACL,KA9OD;;AAgPA,QAAI,CAAC,KAAKlH,aAAV,EAAyB;AACvB,YAAM8J,QAAQ,GAAG,EAAjB,CADuB,CAGvB;AACA;;AACAA,cAAQ,CAAC,KAAK3D,YAAL,CAAkBI,OAAnB,CAAR,GAAsC,UAAUwD,QAAV,EAAoB;AACxD7L,aAAK,CAAC6L,QAAD,EAAW5L,KAAK,CAACkF,KAAN,CAAY7B,MAAZ,EAAoB8B,MAApB,CAAX,CAAL;;AACAtC,YAAI,CAAC8B,MAAL,CAAa,8CAA6CiH,QAAS,IAAnE;;AAEA,YAAI/I,IAAI,CAACR,eAAT,EAA0B;AACxB,cAAIQ,IAAI,CAACf,cAAL,IAAuB1B,OAAO,CAACoD,UAAR,CAAmBX,IAAI,CAACf,cAAxB,CAA3B,EAAoE;AAClE,kBAAMsF,MAAM,GAAG,KAAKA,MAApB;AACA,kBAAMyE,SAAS,GAAG;AAChBzE,oBAAM,EAAE,KAAKA,MADG;;AAEhBD,kBAAI,GAAG;AACL,oBAAIzH,MAAM,CAACoM,KAAX,EAAkB;AAChB,yBAAOpM,MAAM,CAACoM,KAAP,CAAa/E,OAAb,CAAqBK,MAArB,CAAP;AACD;;AACD,uBAAO,IAAP;AACD;;AAPe,aAAlB;;AAUA,gBAAI,CAACvE,IAAI,CAACf,cAAL,CAAoByF,IAApB,CAAyBsE,SAAzB,EAAqChJ,IAAI,CAAC4C,IAAL,CAAUmG,QAAV,KAAuB,IAA5D,CAAL,EAAyE;AACvE,oBAAM,IAAIlM,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAsB,2CAAtB,CAAN;AACD;AACF;;AAED,gBAAMyI,MAAM,GAAGlJ,IAAI,CAAC4C,IAAL,CAAUmG,QAAV,CAAf;;AACA,cAAIG,MAAM,CAAC3F,KAAP,KAAiB,CAArB,EAAwB;AACtBvD,gBAAI,CAACmD,MAAL,CAAY4F,QAAZ;AACA,mBAAO,IAAP;AACD;;AACD,gBAAM,IAAIlM,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAsB,sCAAtB,CAAN;AACD,SAxBD,MAwBO;AACL,gBAAM,IAAI5D,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAsB,iEAAtB,CAAN;AACD;AACF,OA/BD,CALuB,CAuCvB;AACA;AACA;AACA;AACA;AACA;;;AACAqI,cAAQ,CAAC,KAAK3D,YAAL,CAAkBG,MAAnB,CAAR,GAAqC,UAAU3B,IAAV,EAAgBwE,UAAhB,EAA4B;AAC/DjL,aAAK,CAACyG,IAAD,EAAO;AACVG,cAAI,EAAExB,MADI;AAEV2E,gBAAM,EAAEzG,MAFE;AAGV2I,gBAAM,EAAEhM,KAAK,CAACiM,QAAN,CAAe5I,MAAf,CAHE;AAIVhC,mBAAS,EAAE2D,MAJD;AAKVyB,oBAAU,EAAEzB;AALF,SAAP,CAAL;AAQAjF,aAAK,CAACiL,UAAD,EAAahL,KAAK,CAACiM,QAAN,CAAelH,OAAf,CAAb,CAAL;;AAEAlC,YAAI,CAAC8B,MAAL,CAAa,yCAAwC6B,IAAI,CAACG,IAAL,CAAU+D,IAAK,MAAKlE,IAAI,CAACsD,MAAO,EAArF;;AACAtD,YAAI,CAACiE,IAAL,GAAY,IAAZ;;AACA,cAAM;AAAEvD;AAAF,YAAarE,IAAI,CAACuH,cAAL,CAAoBhK,OAAO,CAACuK,KAAR,CAAcnE,IAAd,CAApB,EAAyC,KAAKY,MAA9C,EAAsD,kBAAtD,CAAnB;;AAEA,YAAIvE,IAAI,CAACtB,UAAL,CAAgBwF,OAAhB,CAAwBG,MAAM,CAACvB,GAA/B,CAAJ,EAAyC;AACvC,gBAAM,IAAIjG,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAsB,kDAAtB,CAAN;AACD;;AAEDkD,YAAI,CAACb,GAAL,GAAiBa,IAAI,CAACsD,MAAtB;AACAtD,YAAI,CAACnB,SAAL,GAAiB,IAAIuF,IAAJ,EAAjB;AACApE,YAAI,CAACqE,SAAL,GAAiBrE,IAAI,CAACC,UAAtB;;AACA,YAAI;AACF5D,cAAI,CAACF,cAAL,CAAoBmI,MAApB,CAA2B1K,OAAO,CAAC2K,IAAR,CAAavE,IAAb,EAAmB,MAAnB,CAA3B;;AACA3D,cAAI,CAACyD,aAAL,CAAmBY,MAAM,CAACvB,GAA1B,EAA+BuB,MAAM,CAACX,IAAtC,EAA4CnG,OAAO,CAAC2K,IAAR,CAAavE,IAAb,EAAmB,MAAnB,CAA5C;AACD,SAHD,CAGE,OAAO0F,CAAP,EAAU;AACVrJ,cAAI,CAAC8B,MAAL,CAAa,sDAAqD6B,IAAI,CAACG,IAAL,CAAU+D,IAAK,MAAKlE,IAAI,CAACsD,MAAO,EAAlG,EAAqGoC,CAArG;;AACA,gBAAM,IAAIxM,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAsB,cAAtB,CAAN;AACD;;AAED,YAAI0H,UAAJ,EAAgB;AACd,iBAAO;AACLC,uBAAW,EAAG,GAAEpI,IAAI,CAACnB,aAAc,IAAGmB,IAAI,CAACb,cAAe,WADrD;AAEL2E,gBAAI,EAAEO;AAFD,WAAP;AAID;;AACD,eAAO,IAAP;AACD,OArCD,CA7CuB,CAqFvB;AACA;AACA;;;AACAyE,cAAQ,CAAC,KAAK3D,YAAL,CAAkBE,MAAnB,CAAR,GAAqC,UAAUiE,KAAV,EAAiB;AACpD,YAAI3F,IAAI,GAAG2F,KAAX;AACA,YAAIjF,MAAJ;AACAnH,aAAK,CAACyG,IAAD,EAAO;AACVuD,aAAG,EAAE/J,KAAK,CAACiM,QAAN,CAAelH,OAAf,CADK;AAEV+E,gBAAM,EAAEzG,MAFE;AAGV2G,iBAAO,EAAEhK,KAAK,CAACiM,QAAN,CAAe5I,MAAf,CAHC;AAIV8G,iBAAO,EAAEnK,KAAK,CAACiM,QAAN,CAAejH,MAAf;AAJC,SAAP,CAAL;;AAOA,YAAIwB,IAAI,CAACwD,OAAT,EAAkB;AAChBxD,cAAI,CAACwD,OAAL,GAAeC,MAAM,CAACC,IAAP,CAAY1D,IAAI,CAACwD,OAAjB,EAA0B,QAA1B,CAAf;AACD;;AAED,cAAMtD,eAAe,GAAG7D,IAAI,CAAC6D,eAAL,CAAqBF,IAAI,CAACsD,MAA1B,CAAxB;;AACA,YAAI,CAACpD,eAAL,EAAsB;AACpB,gBAAM,IAAIhH,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAsB,8DAAtB,CAAN;AACD;;AAED,aAAK8I,OAAL;AACA,SAAC;AAAClF,gBAAD;AAASV;AAAT,YAAiB3D,IAAI,CAACuH,cAAL,CAAoBjF,MAAM,CAACqC,MAAP,CAAchB,IAAd,EAAoBE,eAApB,CAApB,EAA0D,KAAKU,MAA/D,EAAuE,KAAvE,CAAlB;;AAEA,YAAIZ,IAAI,CAACuD,GAAT,EAAc;AACZ,cAAI;AACF,mBAAOlH,IAAI,CAAC2F,iBAAL,CAAuBtB,MAAvB,EAA+BV,IAA/B,CAAP;AACD,WAFD,CAEE,OAAO6F,eAAP,EAAwB;AACxBxJ,gBAAI,CAAC8B,MAAL,CAAY,mDAAZ,EAAiE0H,eAAjE;;AACA,kBAAMA,eAAN;AACD;AACF,SAPD,MAOO;AACLxJ,cAAI,CAACyH,IAAL,CAAU,eAAV,EAA2BpD,MAA3B,EAAmCV,IAAnC,EAAyC3F,IAAzC;AACD;;AACD,eAAO,IAAP;AACD,OAjCD,CAxFuB,CA2HvB;AACA;AACA;AACA;AACA;;;AACA8K,cAAQ,CAAC,KAAK3D,YAAL,CAAkBC,MAAnB,CAAR,GAAqC,UAAUtC,GAAV,EAAe;AAClD5F,aAAK,CAAC4F,GAAD,EAAMtC,MAAN,CAAL;;AAEA,cAAMqD,eAAe,GAAG7D,IAAI,CAAC6D,eAAL,CAAqBf,GAArB,CAAxB;;AACA9C,YAAI,CAAC8B,MAAL,CAAa,qCAAoCgB,GAAI,MAAMvF,OAAO,CAACuD,QAAR,CAAiB+C,eAAe,CAACC,IAAjC,IAAyCD,eAAe,CAACC,IAAhB,CAAqBJ,IAA9D,GAAqE,EAAI,EAApI;;AAEA,YAAI1D,IAAI,CAACe,eAAL,IAAwBf,IAAI,CAACe,eAAL,CAAqB+B,GAArB,CAA5B,EAAuD;AACrD9C,cAAI,CAACe,eAAL,CAAqB+B,GAArB,EAA0BO,IAA1B;;AACArD,cAAI,CAACe,eAAL,CAAqB+B,GAArB,EAA0BU,KAA1B;AACD;;AAED,YAAIK,eAAJ,EAAqB;AACnB7D,cAAI,CAACF,cAAL,CAAoBqD,MAApB,CAA2B;AAACL;AAAD,WAA3B;;AACA9C,cAAI,CAACmD,MAAL,CAAY;AAACL;AAAD,WAAZ;;AACA,cAAIvF,OAAO,CAACuD,QAAR,CAAiB+C,eAAe,CAACC,IAAjC,KAA0CD,eAAe,CAACC,IAAhB,CAAqBJ,IAAnE,EAAyE;AACvE1D,gBAAI,CAACyJ,MAAL,CAAY;AAAC3G,iBAAD;AAAMY,kBAAI,EAAEG,eAAe,CAACC,IAAhB,CAAqBJ;AAAjC,aAAZ;AACD;AACF;;AACD,eAAO,IAAP;AACD,OAnBD;;AAqBA7G,YAAM,CAAC6M,OAAP,CAAeZ,QAAf;AACD;AACF;AAED;;;;;;;;;AAOAvB,gBAAc,CAAC5D,IAAI,GAAG,EAAR,EAAYY,MAAZ,EAAoBoF,SAApB,EAA+B;AAC3C,QAAIC,GAAJ;;AACA,QAAI,CAACrM,OAAO,CAAC0C,SAAR,CAAkB0D,IAAI,CAACuD,GAAvB,CAAL,EAAkC;AAChCvD,UAAI,CAACuD,GAAL,GAAW,KAAX;AACD;;AAED,QAAI,CAACvD,IAAI,CAACwD,OAAV,EAAmB;AACjBxD,UAAI,CAACwD,OAAL,GAAe,KAAf;AACD;;AAED,QAAI,CAAC5J,OAAO,CAACqD,QAAR,CAAiB+C,IAAI,CAAC2D,OAAtB,CAAL,EAAqC;AACnC3D,UAAI,CAAC2D,OAAL,GAAe,CAAC,CAAhB;AACD;;AAED,QAAI,CAAC/J,OAAO,CAAC6C,QAAR,CAAiBuD,IAAI,CAACwF,MAAtB,CAAL,EAAoC;AAClCxF,UAAI,CAACwF,MAAL,GAAcxF,IAAI,CAACsD,MAAnB;AACD;;AAED,SAAKnF,MAAL,CAAa,+BAA8B6H,SAAU,UAAShG,IAAI,CAAC2D,OAAQ,IAAG3D,IAAI,CAACC,UAAW,iBAAgBD,IAAI,CAACG,IAAL,CAAU+D,IAAV,IAAkBlE,IAAI,CAACG,IAAL,CAAU+F,QAAS,EAAnJ;;AAEA,UAAMA,QAAQ,GAAG,KAAKC,YAAL,CAAkBnG,IAAI,CAACG,IAAvB,CAAjB;;AACA,UAAM;AAACiG,eAAD;AAAYC;AAAZ,QAAgC,KAAKC,OAAL,CAAaJ,QAAb,CAAtC;;AAEA,QAAI,CAACtM,OAAO,CAACuD,QAAR,CAAiB6C,IAAI,CAACG,IAAL,CAAU0D,IAA3B,CAAL,EAAuC;AACrC7D,UAAI,CAACG,IAAL,CAAU0D,IAAV,GAAiB,EAAjB;AACD;;AAED,QAAInD,MAAM,GAASV,IAAI,CAACG,IAAxB;AACAO,UAAM,CAACwD,IAAP,GAAmBgC,QAAnB;AACAxF,UAAM,CAACmD,IAAP,GAAmB7D,IAAI,CAACG,IAAL,CAAU0D,IAA7B;AACAnD,UAAM,CAAC0F,SAAP,GAAmBA,SAAnB;AACA1F,UAAM,CAAC6F,GAAP,GAAmBH,SAAnB;AACA1F,UAAM,CAACvB,GAAP,GAAmBa,IAAI,CAACsD,MAAxB;AACA5C,UAAM,CAACE,MAAP,GAAmBA,MAAM,IAAI,IAA7B;AACAZ,QAAI,CAACwF,MAAL,GAAmBxF,IAAI,CAACwF,MAAL,CAAYzI,OAAZ,CAAoB,oBAApB,EAA0C,GAA1C,CAAnB;AACA2D,UAAM,CAACX,IAAP,GAAoB,GAAE,KAAKvF,WAAL,CAAiBkG,MAAjB,CAAyB,GAAEzG,QAAQ,CAAC6D,GAAI,GAAEkC,IAAI,CAACwF,MAAO,GAAEa,gBAAiB,EAA/F;AACA3F,UAAM,GAAa/B,MAAM,CAACqC,MAAP,CAAcN,MAAd,EAAsB,KAAK8F,aAAL,CAAmB9F,MAAnB,CAAtB,CAAnB;;AAEA,QAAI,KAAKjF,cAAL,IAAuB7B,OAAO,CAACoD,UAAR,CAAmB,KAAKvB,cAAxB,CAA3B,EAAoE;AAClEwK,SAAG,GAAGtH,MAAM,CAACqC,MAAP,CAAc;AAClBb,YAAI,EAAEH,IAAI,CAACG;AADO,OAAd,EAEH;AACDwD,eAAO,EAAE3D,IAAI,CAAC2D,OADb;AAED/C,cAAM,EAAEF,MAAM,CAACE,MAFd;;AAGDD,YAAI,GAAG;AACL,cAAIzH,MAAM,CAACoM,KAAP,IAAgB5E,MAAM,CAACE,MAA3B,EAAmC;AACjC,mBAAO1H,MAAM,CAACoM,KAAP,CAAa/E,OAAb,CAAqBG,MAAM,CAACE,MAA5B,CAAP;AACD;;AACD,iBAAO,IAAP;AACD,SARA;;AASD2C,WAAG,EAAEvD,IAAI,CAACuD;AATT,OAFG,CAAN;AAaA,YAAMkD,eAAe,GAAG,KAAKhL,cAAL,CAAoBsF,IAApB,CAAyBkF,GAAzB,EAA8BvF,MAA9B,CAAxB;;AAEA,UAAI+F,eAAe,KAAK,IAAxB,EAA8B;AAC5B,cAAM,IAAIvN,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAsBlD,OAAO,CAAC6C,QAAR,CAAiBgK,eAAjB,IAAoCA,eAApC,GAAsD,kCAA5E,CAAN;AACD,OAFD,MAEO;AACL,YAAKzG,IAAI,CAACiE,IAAL,KAAc,IAAf,IAAwB,KAAKlI,gBAA7B,IAAiDnC,OAAO,CAACoD,UAAR,CAAmB,KAAKjB,gBAAxB,CAArD,EAAgG;AAC9F,eAAKA,gBAAL,CAAsBgF,IAAtB,CAA2BkF,GAA3B,EAAgCvF,MAAhC;AACD;AACF;AACF,KAvBD,MAuBO,IAAKV,IAAI,CAACiE,IAAL,KAAc,IAAf,IAAwB,KAAKlI,gBAA7B,IAAiDnC,OAAO,CAACoD,UAAR,CAAmB,KAAKjB,gBAAxB,CAArD,EAAgG;AACrGkK,SAAG,GAAGtH,MAAM,CAACqC,MAAP,CAAc;AAClBb,YAAI,EAAEH,IAAI,CAACG;AADO,OAAd,EAEH;AACDwD,eAAO,EAAE3D,IAAI,CAAC2D,OADb;AAED/C,cAAM,EAAEF,MAAM,CAACE,MAFd;;AAGDD,YAAI,GAAG;AACL,cAAIzH,MAAM,CAACoM,KAAP,IAAgB5E,MAAM,CAACE,MAA3B,EAAmC;AACjC,mBAAO1H,MAAM,CAACoM,KAAP,CAAa/E,OAAb,CAAqBG,MAAM,CAACE,MAA5B,CAAP;AACD;;AACD,iBAAO,IAAP;AACD,SARA;;AASD2C,WAAG,EAAEvD,IAAI,CAACuD;AATT,OAFG,CAAN;AAaA,WAAKxH,gBAAL,CAAsBgF,IAAtB,CAA2BkF,GAA3B,EAAgCvF,MAAhC;AACD;;AAED,WAAO;AAACA,YAAD;AAASV;AAAT,KAAP;AACD;AAED;;;;;;;;;AAOA+B,eAAa,CAACrB,MAAD,EAASV,IAAT,EAAe0G,EAAf,EAAmB;AAC9B,SAAKvI,MAAL,CAAa,qDAAoDuC,MAAM,CAACX,IAAK,EAA7E;;AACAlG,MAAE,CAAC8M,KAAH,CAASjG,MAAM,CAACX,IAAhB,EAAsB,KAAK/E,WAA3B,EAAwCX,IAAxC;AACAqG,UAAM,CAAC7C,IAAP,GAAgB,KAAK+I,YAAL,CAAkB5G,IAAI,CAACG,IAAvB,CAAhB;AACAO,UAAM,CAAC/F,MAAP,GAAgB,KAAKA,MAArB;;AACA,SAAKkM,gBAAL,CAAsBnG,MAAtB;;AAEA,SAAK3F,UAAL,CAAgBuJ,MAAhB,CAAuB1K,OAAO,CAACuK,KAAR,CAAczD,MAAd,CAAvB,EAA8C,CAACoG,SAAD,EAAY3H,GAAZ,KAAoB;AAChE,UAAI2H,SAAJ,EAAe;AACbJ,UAAE,IAAIA,EAAE,CAACI,SAAD,CAAR;;AACA,aAAK3I,MAAL,CAAY,4DAAZ,EAA0E2I,SAA1E;AACD,OAHD,MAGO;AACL,aAAK3K,cAAL,CAAoB4K,MAApB,CAA2B;AAAC5H,aAAG,EAAEa,IAAI,CAACsD;AAAX,SAA3B,EAA+C;AAAC0D,cAAI,EAAE;AAAC5H,sBAAU,EAAE;AAAb;AAAP,SAA/C,EAA4E6H,cAAD,IAAoB;AAC7F,cAAIA,cAAJ,EAAoB;AAClBP,cAAE,IAAIA,EAAE,CAACO,cAAD,CAAR;;AACA,iBAAK9I,MAAL,CAAY,4DAAZ,EAA0E8I,cAA1E;AACD,WAHD,MAGO;AACLvG,kBAAM,CAACvB,GAAP,GAAaA,GAAb;;AACA,iBAAKhB,MAAL,CAAa,oDAAmDuC,MAAM,CAACX,IAAK,EAA5E;;AACA,iBAAK5E,aAAL,IAAsB,KAAKA,aAAL,CAAmB4F,IAAnB,CAAwB,IAAxB,EAA8BL,MAA9B,CAAtB;AACA,iBAAKoD,IAAL,CAAU,aAAV,EAAyBpD,MAAzB;AACAgG,cAAE,IAAIA,EAAE,CAAC,IAAD,EAAOhG,MAAP,CAAR;AACD;AACF,SAXD;AAYD;AACF,KAlBD;AAmBD;AAED;;;;;;;;;AAOAoB,eAAa,CAACpB,MAAD,EAASV,IAAT,EAAe0G,EAAf,EAAmB;AAC9B,QAAI;AACF,UAAI1G,IAAI,CAACuD,GAAT,EAAc;AACZ,aAAKnG,eAAL,CAAqBsD,MAAM,CAACvB,GAA5B,EAAiCQ,GAAjC,CAAqC,MAAM;AACzC,eAAKmE,IAAL,CAAU,eAAV,EAA2BpD,MAA3B,EAAmCV,IAAnC,EAAyC0G,EAAzC;AACD,SAFD;AAGD,OAJD,MAIO;AACL,aAAKtJ,eAAL,CAAqBsD,MAAM,CAACvB,GAA5B,EAAiC+H,KAAjC,CAAuClH,IAAI,CAAC2D,OAA5C,EAAqD3D,IAAI,CAACwD,OAA1D,EAAmEkD,EAAnE;AACD;AACF,KARD,CAQE,OAAOhB,CAAP,EAAU;AACV,WAAKvH,MAAL,CAAY,8BAAZ,EAA4CuH,CAA5C;;AACAgB,QAAE,IAAIA,EAAE,CAAChB,CAAD,CAAR;AACD;AACF;AAED;;;;;;;;;;AAQAkB,cAAY,CAACO,QAAD,EAAW;AACrB,QAAIC,IAAJ;AACA7N,SAAK,CAAC4N,QAAD,EAAWxI,MAAX,CAAL;;AACA,QAAI/E,OAAO,CAACuD,QAAR,CAAiBgK,QAAjB,KAA8BA,QAAQ,CAACtJ,IAA3C,EAAiD;AAC/CuJ,UAAI,GAAGD,QAAQ,CAACtJ,IAAhB;AACD;;AAED,QAAIsJ,QAAQ,CAACpH,IAAT,KAAkB,CAACqH,IAAD,IAAS,CAACxN,OAAO,CAAC6C,QAAR,CAAiB2K,IAAjB,CAA5B,CAAJ,EAAyD;AACvD,UAAI;AACF,YAAIC,GAAG,GAAI5D,MAAM,CAAC6D,KAAP,CAAa,GAAb,CAAX;AACA,cAAMC,EAAE,GAAG1N,EAAE,CAAC2N,QAAH,CAAYL,QAAQ,CAACpH,IAArB,EAA2B,GAA3B,CAAX;AACA,cAAM0H,EAAE,GAAG5N,EAAE,CAAC6N,QAAH,CAAYH,EAAZ,EAAgBF,GAAhB,EAAqB,CAArB,EAAwB,GAAxB,EAA6B,CAA7B,CAAX;AACAxN,UAAE,CAAC8N,KAAH,CAASJ,EAAT,EAAalN,IAAb;;AACA,YAAIoN,EAAE,GAAG,GAAT,EAAc;AACZJ,aAAG,GAAGA,GAAG,CAACO,KAAJ,CAAU,CAAV,EAAaH,EAAb,CAAN;AACD;;AACD,SAAC;AAACL;AAAD,YAASpN,QAAQ,CAACqN,GAAD,CAAlB;AACD,OATD,CASE,OAAO3B,CAAP,EAAU,CACV;AACD;AACF;;AAED,QAAI,CAAC0B,IAAD,IAAS,CAACxN,OAAO,CAAC6C,QAAR,CAAiB2K,IAAjB,CAAd,EAAsC;AACpCA,UAAI,GAAG,0BAAP;AACD;;AACD,WAAOA,IAAP;AACD;AAED;;;;;;;;;AAOA/D,YAAU,CAACwE,KAAD,EAAQ;AAChB,QAAI,CAACA,KAAL,EAAY,OAAO,IAAP,CADI,CAGhB;;AACA,QAAI,CAAC3O,MAAM,CAAC4O,MAAP,CAAcC,QAAf,YAAmCC,GAAnC,IAA0C,CAACpO,OAAO,CAACuD,QAAR,CAAiBjE,MAAM,CAAC4O,MAAP,CAAcC,QAA/B,CAA/C,EAAyF;AACvF,YAAM,IAAIjL,KAAJ,CAAU,sDAAV,CAAN;AACD;;AAED,QAAI5D,MAAM,CAAC4O,MAAP,CAAcC,QAAd,YAAkCC,GAAlC,IAAyC9O,MAAM,CAAC4O,MAAP,CAAcC,QAAd,CAAuBE,GAAvB,CAA2BJ,KAA3B,CAAzC,IAA8EjO,OAAO,CAACuD,QAAR,CAAiBjE,MAAM,CAAC4O,MAAP,CAAcC,QAAd,CAAuBG,GAAvB,CAA2BL,KAA3B,CAAjB,CAAlF,EAAuI;AACrI;AACA,aAAO3O,MAAM,CAAC4O,MAAP,CAAcC,QAAd,CAAuBG,GAAvB,CAA2BL,KAA3B,EAAkCjH,MAAzC;AACD,KAHD,MAGO,IAAIhH,OAAO,CAACuD,QAAR,CAAiBjE,MAAM,CAAC4O,MAAP,CAAcC,QAA/B,KAA4CF,KAAK,IAAI3O,MAAM,CAAC4O,MAAP,CAAcC,QAAnE,IAA+EnO,OAAO,CAACuD,QAAR,CAAiBjE,MAAM,CAAC4O,MAAP,CAAcC,QAAd,CAAuBF,KAAvB,CAAjB,CAAnF,EAAoI;AACzI;AACA,aAAO3O,MAAM,CAAC4O,MAAP,CAAcC,QAAd,CAAuBF,KAAvB,EAA8BjH,MAArC;AACD;;AAED,WAAO,IAAP;AACD;AAED;;;;;;;;;AAOAC,UAAQ,CAACJ,IAAD,EAAO;AACb,UAAMC,MAAM,GAAG;AACbC,UAAI,GAAG;AAAE,eAAO,IAAP;AAAc,OADV;;AAEbC,YAAM,EAAE;AAFK,KAAf;;AAKA,QAAIH,IAAJ,EAAU;AACR,UAAI0H,IAAI,GAAG,IAAX;;AACA,UAAI1H,IAAI,CAAC1G,OAAL,CAAayD,OAAb,CAAqB,QAArB,CAAJ,EAAoC;AAClC2K,YAAI,GAAG1H,IAAI,CAAC1G,OAAL,CAAayD,OAAb,CAAqB,QAArB,CAAP;AACD,OAFD,MAEO;AACL,cAAM4K,MAAM,GAAG3H,IAAI,CAAC1G,OAAL,CAAaX,OAA5B;;AACA,YAAIgP,MAAM,CAACH,GAAP,CAAW,QAAX,CAAJ,EAA0B;AACxBE,cAAI,GAAGC,MAAM,CAACF,GAAP,CAAW,QAAX,CAAP;AACD;AACF;;AAED,UAAIC,IAAJ,EAAU;AACR,cAAMvH,MAAM,GAAG,KAAKyC,UAAL,CAAgB8E,IAAhB,CAAf;;AAEA,YAAIvH,MAAJ,EAAY;AACVF,gBAAM,CAACC,IAAP,GAAgB,MAAMzH,MAAM,CAACoM,KAAP,CAAa/E,OAAb,CAAqBK,MAArB,CAAtB;;AACAF,gBAAM,CAACE,MAAP,GAAgBA,MAAhB;AACD;AACF;AACF;;AAED,WAAOF,MAAP;AACD;AAED;;;;;;;;;;;;;;;;;;AAgBAwG,OAAK,CAACmB,MAAD,EAAS1C,KAAK,GAAG,EAAjB,EAAqB2C,SAArB,EAAgCC,mBAAhC,EAAqD;AACxD,SAAKpK,MAAL,CAAY,6BAAZ;;AACA,QAAI6B,IAAI,GAAG2F,KAAX;AACA,QAAIvL,QAAQ,GAAGkO,SAAf;AACA,QAAIE,kBAAkB,GAAGD,mBAAzB;;AAEA,QAAI3O,OAAO,CAACoD,UAAR,CAAmBgD,IAAnB,CAAJ,EAA8B;AAC5BwI,wBAAkB,GAAGpO,QAArB;AACAA,cAAQ,GAAG4F,IAAX;AACAA,UAAI,GAAO,EAAX;AACD,KAJD,MAIO,IAAIpG,OAAO,CAAC0C,SAAR,CAAkBlC,QAAlB,CAAJ,EAAiC;AACtCoO,wBAAkB,GAAGpO,QAArB;AACD,KAFM,MAEA,IAAIR,OAAO,CAAC0C,SAAR,CAAkB0D,IAAlB,CAAJ,EAA6B;AAClCwI,wBAAkB,GAAGxI,IAArB;AACD;;AAEDzG,SAAK,CAACyG,IAAD,EAAOxG,KAAK,CAACiM,QAAN,CAAe9G,MAAf,CAAP,CAAL;AACApF,SAAK,CAACa,QAAD,EAAWZ,KAAK,CAACiM,QAAN,CAAehH,QAAf,CAAX,CAAL;AACAlF,SAAK,CAACiP,kBAAD,EAAqBhP,KAAK,CAACiM,QAAN,CAAelH,OAAf,CAArB,CAAL;AAEA,UAAM+E,MAAM,GAAKtD,IAAI,CAACsD,MAAL,IAAenK,MAAM,CAACsP,EAAP,EAAhC;AACA,UAAMjD,MAAM,GAAK,KAAK9J,cAAL,GAAsB,KAAKA,cAAL,CAAoBsE,IAApB,CAAtB,GAAkDsD,MAAnE;AACA,UAAM4C,QAAQ,GAAIlG,IAAI,CAACkE,IAAL,IAAalE,IAAI,CAACkG,QAAnB,GAAgClG,IAAI,CAACkE,IAAL,IAAalE,IAAI,CAACkG,QAAlD,GAA8DV,MAA/E;;AAEA,UAAM;AAACY,eAAD;AAAYC;AAAZ,QAAgC,KAAKC,OAAL,CAAaJ,QAAb,CAAtC;;AAEAlG,QAAI,CAACD,IAAL,GAAa,GAAE,KAAKvF,WAAL,CAAiBwF,IAAjB,CAAuB,GAAE/F,QAAQ,CAAC6D,GAAI,GAAE0H,MAAO,GAAEa,gBAAiB,EAAjF;AACArG,QAAI,CAACnC,IAAL,GAAY,KAAK+I,YAAL,CAAkB5G,IAAlB,CAAZ;;AACA,QAAI,CAACpG,OAAO,CAACuD,QAAR,CAAiB6C,IAAI,CAAC6D,IAAtB,CAAL,EAAkC;AAChC7D,UAAI,CAAC6D,IAAL,GAAY,EAAZ;AACD;;AAED,QAAI,CAACjK,OAAO,CAACqD,QAAR,CAAiB+C,IAAI,CAACrC,IAAtB,CAAL,EAAkC;AAChCqC,UAAI,CAACrC,IAAL,GAAY0K,MAAM,CAAC/G,MAAnB;AACD;;AAED,UAAMZ,MAAM,GAAG,KAAK8F,aAAL,CAAmB;AAChCtC,UAAI,EAAEgC,QAD0B;AAEhCnG,UAAI,EAAEC,IAAI,CAACD,IAFqB;AAGhC8D,UAAI,EAAE7D,IAAI,CAAC6D,IAHqB;AAIhChG,UAAI,EAAEmC,IAAI,CAACnC,IAJqB;AAKhCF,UAAI,EAAEqC,IAAI,CAACrC,IALqB;AAMhCiD,YAAM,EAAEZ,IAAI,CAACY,MANmB;AAOhCwF;AAPgC,KAAnB,CAAf;;AAUA1F,UAAM,CAACvB,GAAP,GAAamE,MAAb;AAEA,UAAMoF,MAAM,GAAG7O,EAAE,CAAC8O,iBAAH,CAAqB3I,IAAI,CAACD,IAA1B,EAAgC;AAAC6I,WAAK,EAAE,GAAR;AAAavK,UAAI,EAAE,KAAKrD;AAAxB,KAAhC,CAAf;AACA0N,UAAM,CAAC/I,GAAP,CAAW0I,MAAX,EAAoBQ,SAAD,IAAe3O,KAAK,CAAC,MAAM;AAC5C,UAAI2O,SAAJ,EAAe;AACbzO,gBAAQ,IAAIA,QAAQ,CAACyO,SAAD,CAApB;AACD,OAFD,MAEO;AACL,aAAK9N,UAAL,CAAgBuJ,MAAhB,CAAuB5D,MAAvB,EAA+B,CAACoI,SAAD,EAAY3J,GAAZ,KAAoB;AACjD,cAAI2J,SAAJ,EAAe;AACb1O,oBAAQ,IAAIA,QAAQ,CAAC0O,SAAD,CAApB;;AACA,iBAAK3K,MAAL,CAAa,6CAA4C+H,QAAS,OAAM,KAAK1K,cAAe,EAA5F,EAA+FsN,SAA/F;AACD,WAHD,MAGO;AACL,kBAAMxL,OAAO,GAAG,KAAKvC,UAAL,CAAgBwF,OAAhB,CAAwBpB,GAAxB,CAAhB;AACA/E,oBAAQ,IAAIA,QAAQ,CAAC,IAAD,EAAOkD,OAAP,CAApB;;AACA,gBAAIkL,kBAAkB,KAAK,IAA3B,EAAiC;AAC/B,mBAAKrN,aAAL,IAAsB,KAAKA,aAAL,CAAmB4F,IAAnB,CAAwB,IAAxB,EAA8BzD,OAA9B,CAAtB;AACA,mBAAKwG,IAAL,CAAU,aAAV,EAAyBxG,OAAzB;AACD;;AACD,iBAAKa,MAAL,CAAa,8BAA6B+H,QAAS,OAAM,KAAK1K,cAAe,EAA7E;AACD;AACF,SAbD;AAcD;AACF,KAnBsC,CAAvC;AAoBA,WAAO,IAAP;AACD;AAED;;;;;;;;;;;;;;;;;;;AAiBAuN,MAAI,CAACC,GAAD,EAAMrD,KAAK,GAAG,EAAd,EAAkB2C,SAAlB,EAA6BC,mBAA7B,EAAkD;AACpD,SAAKpK,MAAL,CAAa,2BAA0B6K,GAAI,KAAI/F,IAAI,CAACC,SAAL,CAAeyC,KAAf,CAAsB,cAArE;;AACA,QAAI3F,IAAI,GAAG2F,KAAX;AACA,QAAIvL,QAAQ,GAAGkO,SAAf;AACA,QAAIE,kBAAkB,GAAGD,mBAAzB;;AAEA,QAAI3O,OAAO,CAACoD,UAAR,CAAmBgD,IAAnB,CAAJ,EAA8B;AAC5BwI,wBAAkB,GAAGpO,QAArB;AACAA,cAAQ,GAAG4F,IAAX;AACAA,UAAI,GAAO,EAAX;AACD,KAJD,MAIO,IAAIpG,OAAO,CAAC0C,SAAR,CAAkBlC,QAAlB,CAAJ,EAAiC;AACtCoO,wBAAkB,GAAGpO,QAArB;AACD,KAFM,MAEA,IAAIR,OAAO,CAAC0C,SAAR,CAAkB0D,IAAlB,CAAJ,EAA6B;AAClCwI,wBAAkB,GAAGxI,IAArB;AACD;;AAEDzG,SAAK,CAACyP,GAAD,EAAMnM,MAAN,CAAL;AACAtD,SAAK,CAACyG,IAAD,EAAOxG,KAAK,CAACiM,QAAN,CAAe9G,MAAf,CAAP,CAAL;AACApF,SAAK,CAACa,QAAD,EAAWZ,KAAK,CAACiM,QAAN,CAAehH,QAAf,CAAX,CAAL;AACAlF,SAAK,CAACiP,kBAAD,EAAqBhP,KAAK,CAACiM,QAAN,CAAelH,OAAf,CAArB,CAAL;;AAEA,QAAI,CAAC3E,OAAO,CAACuD,QAAR,CAAiB6C,IAAjB,CAAL,EAA6B;AAC3BA,UAAI,GAAG,EAAP;AACD;;AAED,UAAMsD,MAAM,GAAMtD,IAAI,CAACsD,MAAL,IAAenK,MAAM,CAACsP,EAAP,EAAjC;AACA,UAAMjD,MAAM,GAAM,KAAK9J,cAAL,GAAsB,KAAKA,cAAL,CAAoBsE,IAApB,CAAtB,GAAkDsD,MAApE;AACA,UAAM2F,SAAS,GAAGD,GAAG,CAAClE,KAAJ,CAAU,GAAV,CAAlB;AACA,UAAMoB,QAAQ,GAAKlG,IAAI,CAACkE,IAAL,IAAalE,IAAI,CAACkG,QAAnB,GAAgClG,IAAI,CAACkE,IAAL,IAAalE,IAAI,CAACkG,QAAlD,GAA8D+C,SAAS,CAACA,SAAS,CAAC3H,MAAV,GAAmB,CAApB,CAAT,IAAmCkE,MAAnH;;AAEA,UAAM;AAACY,eAAD;AAAYC;AAAZ,QAAgC,KAAKC,OAAL,CAAaJ,QAAb,CAAtC;;AACAlG,QAAI,CAACD,IAAL,GAAc,GAAE,KAAKvF,WAAL,CAAiBwF,IAAjB,CAAuB,GAAE/F,QAAQ,CAAC6D,GAAI,GAAE0H,MAAO,GAAEa,gBAAiB,EAAlF;;AAEA,UAAM6C,WAAW,GAAG,CAACxI,MAAD,EAASgG,EAAT,KAAgB;AAClChG,YAAM,CAACvB,GAAP,GAAamE,MAAb;AAEA,WAAKvI,UAAL,CAAgBuJ,MAAhB,CAAuB5D,MAAvB,EAA+B,CAACpC,KAAD,EAAQa,GAAR,KAAgB;AAC7C,YAAIb,KAAJ,EAAW;AACToI,YAAE,IAAIA,EAAE,CAACpI,KAAD,CAAR;;AACA,eAAKH,MAAL,CAAa,4CAA2C+H,QAAS,OAAM,KAAK1K,cAAe,EAA3F,EAA8F8C,KAA9F;AACD,SAHD,MAGO;AACL,gBAAMhB,OAAO,GAAG,KAAKvC,UAAL,CAAgBwF,OAAhB,CAAwBpB,GAAxB,CAAhB;AACAuH,YAAE,IAAIA,EAAE,CAAC,IAAD,EAAOpJ,OAAP,CAAR;;AACA,cAAIkL,kBAAkB,KAAK,IAA3B,EAAiC;AAC/B,iBAAKrN,aAAL,IAAsB,KAAKA,aAAL,CAAmB4F,IAAnB,CAAwB,IAAxB,EAA8BzD,OAA9B,CAAtB;AACA,iBAAKwG,IAAL,CAAU,aAAV,EAAyBxG,OAAzB;AACD;;AACD,eAAKa,MAAL,CAAa,qCAAoC+H,QAAS,OAAM,KAAK1K,cAAe,EAApF;AACD;AACF,OAbD;AAcD,KAjBD;;AAmBAzB,WAAO,CAACmO,GAAR,CAAY;AACVc,SADU;AAEVxL,aAAO,EAAEwC,IAAI,CAACxC,OAAL,IAAgB;AAFf,KAAZ,EAGGqE,EAHH,CAGM,OAHN,EAGgBvD,KAAD,IAAWpE,KAAK,CAAC,MAAM;AACpCE,cAAQ,IAAIA,QAAQ,CAACkE,KAAD,CAApB;;AACA,WAAKH,MAAL,CAAa,yCAAwC6K,GAAI,WAAzD,EAAqE1K,KAArE;AACD,KAH8B,CAH/B,EAMIuD,EANJ,CAMO,UANP,EAMoBV,QAAD,IAAcjH,KAAK,CAAC,MAAM;AAC3CiH,cAAQ,CAACU,EAAT,CAAY,KAAZ,EAAmB,MAAM3H,KAAK,CAAC,MAAM;AACnC,aAAKiE,MAAL,CAAa,sCAAqC6K,GAAI,EAAtD;;AACA,cAAMtI,MAAM,GAAG,KAAK8F,aAAL,CAAmB;AAChCtC,cAAI,EAAEgC,QAD0B;AAEhCnG,cAAI,EAAEC,IAAI,CAACD,IAFqB;AAGhC8D,cAAI,EAAE7D,IAAI,CAAC6D,IAHqB;AAIhChG,cAAI,EAAEmC,IAAI,CAACnC,IAAL,IAAasD,QAAQ,CAAC3D,OAAT,CAAiB,cAAjB,CAAb,IAAiD,KAAKoJ,YAAL,CAAkB;AAAC7G,gBAAI,EAAEC,IAAI,CAACD;AAAZ,WAAlB,CAJvB;AAKhCpC,cAAI,EAAEqC,IAAI,CAACrC,IAAL,IAAaT,QAAQ,CAACiE,QAAQ,CAAC3D,OAAT,CAAiB,gBAAjB,KAAsC,CAAvC,CALK;AAMhCoD,gBAAM,EAAEZ,IAAI,CAACY,MANmB;AAOhCwF;AAPgC,SAAnB,CAAf;;AAUA,YAAI,CAAC1F,MAAM,CAAC/C,IAAZ,EAAkB;AAChB9D,YAAE,CAACsP,IAAH,CAAQnJ,IAAI,CAACD,IAAb,EAAmB,CAACzB,KAAD,EAAQ8K,KAAR,KAAkBlP,KAAK,CAAC,MAAM;AAC/C,gBAAIoE,KAAJ,EAAW;AACTlE,sBAAQ,IAAIA,QAAQ,CAACkE,KAAD,CAApB;AACD,aAFD,MAEO;AACLoC,oBAAM,CAAC2I,QAAP,CAAgBC,QAAhB,CAAyB3L,IAAzB,GAAiC+C,MAAM,CAAC/C,IAAP,GAAcyL,KAAK,CAACzL,IAArD;AACAuL,yBAAW,CAACxI,MAAD,EAAStG,QAAT,CAAX;AACD;AACF,WAPyC,CAA1C;AAQD,SATD,MASO;AACL8O,qBAAW,CAACxI,MAAD,EAAStG,QAAT,CAAX;AACD;AACF,OAxB6B,CAA9B;AAyBD,KA1BqC,CANtC,EAgCImP,IAhCJ,CAgCS1P,EAAE,CAAC8O,iBAAH,CAAqB3I,IAAI,CAACD,IAA1B,EAAgC;AAAC6I,WAAK,EAAE,GAAR;AAAavK,UAAI,EAAE,KAAKrD;AAAxB,KAAhC,CAhCT;AAkCA,WAAO,IAAP;AACD;AAED;;;;;;;;;;;;;;;;;;AAgBAwO,SAAO,CAACzJ,IAAD,EAAO4F,KAAK,GAAG,EAAf,EAAmB2C,SAAnB,EAA8BC,mBAA9B,EAAmD;AACxD,SAAKpK,MAAL,CAAa,8BAA6B4B,IAAK,IAA/C;;AACA,QAAIC,IAAI,GAAG2F,KAAX;AACA,QAAIvL,QAAQ,GAAGkO,SAAf;AACA,QAAIE,kBAAkB,GAAGD,mBAAzB;;AAEA,QAAI3O,OAAO,CAACoD,UAAR,CAAmBgD,IAAnB,CAAJ,EAA8B;AAC5BwI,wBAAkB,GAAGpO,QAArB;AACAA,cAAQ,GAAG4F,IAAX;AACAA,UAAI,GAAO,EAAX;AACD,KAJD,MAIO,IAAIpG,OAAO,CAAC0C,SAAR,CAAkBlC,QAAlB,CAAJ,EAAiC;AACtCoO,wBAAkB,GAAGpO,QAArB;AACD,KAFM,MAEA,IAAIR,OAAO,CAAC0C,SAAR,CAAkB0D,IAAlB,CAAJ,EAA6B;AAClCwI,wBAAkB,GAAGxI,IAArB;AACD;;AAED,QAAI,KAAKrF,MAAT,EAAiB;AACf,YAAM,IAAIzB,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAsB,kHAAtB,CAAN;AACD;;AAEDvD,SAAK,CAACwG,IAAD,EAAOlD,MAAP,CAAL;AACAtD,SAAK,CAACyG,IAAD,EAAOxG,KAAK,CAACiM,QAAN,CAAe9G,MAAf,CAAP,CAAL;AACApF,SAAK,CAACa,QAAD,EAAWZ,KAAK,CAACiM,QAAN,CAAehH,QAAf,CAAX,CAAL;AACAlF,SAAK,CAACiP,kBAAD,EAAqBhP,KAAK,CAACiM,QAAN,CAAelH,OAAf,CAArB,CAAL;AAEA1E,MAAE,CAACsP,IAAH,CAAQpJ,IAAR,EAAc,CAAC0J,OAAD,EAAUL,KAAV,KAAoBlP,KAAK,CAAC,MAAM;AAC5C,UAAIuP,OAAJ,EAAa;AACXrP,gBAAQ,IAAIA,QAAQ,CAACqP,OAAD,CAApB;AACD,OAFD,MAEO,IAAIL,KAAK,CAACM,MAAN,EAAJ,EAAoB;AACzB,YAAI,CAAC9P,OAAO,CAACuD,QAAR,CAAiB6C,IAAjB,CAAL,EAA6B;AAC3BA,cAAI,GAAG,EAAP;AACD;;AACDA,YAAI,CAACD,IAAL,GAAaA,IAAb;;AAEA,YAAI,CAACC,IAAI,CAACkG,QAAV,EAAoB;AAClB,gBAAM+C,SAAS,GAAGlJ,IAAI,CAAC+E,KAAL,CAAW7K,QAAQ,CAAC6D,GAApB,CAAlB;AACAkC,cAAI,CAACkG,QAAL,GAAkBnG,IAAI,CAAC+E,KAAL,CAAW7K,QAAQ,CAAC6D,GAApB,EAAyBmL,SAAS,CAAC3H,MAAV,GAAmB,CAA5C,CAAlB;AACD;;AAED,cAAM;AAAC8E;AAAD,YAAc,KAAKE,OAAL,CAAatG,IAAI,CAACkG,QAAlB,CAApB;;AAEA,YAAI,CAACtM,OAAO,CAAC6C,QAAR,CAAiBuD,IAAI,CAACnC,IAAtB,CAAL,EAAkC;AAChCmC,cAAI,CAACnC,IAAL,GAAY,KAAK+I,YAAL,CAAkB5G,IAAlB,CAAZ;AACD;;AAED,YAAI,CAACpG,OAAO,CAACuD,QAAR,CAAiB6C,IAAI,CAAC6D,IAAtB,CAAL,EAAkC;AAChC7D,cAAI,CAAC6D,IAAL,GAAY,EAAZ;AACD;;AAED,YAAI,CAACjK,OAAO,CAACqD,QAAR,CAAiB+C,IAAI,CAACrC,IAAtB,CAAL,EAAkC;AAChCqC,cAAI,CAACrC,IAAL,GAAYyL,KAAK,CAACzL,IAAlB;AACD;;AAED,cAAM+C,MAAM,GAAG,KAAK8F,aAAL,CAAmB;AAChCtC,cAAI,EAAElE,IAAI,CAACkG,QADqB;AAEhCnG,cAFgC;AAGhC8D,cAAI,EAAE7D,IAAI,CAAC6D,IAHqB;AAIhChG,cAAI,EAAEmC,IAAI,CAACnC,IAJqB;AAKhCF,cAAI,EAAEqC,IAAI,CAACrC,IALqB;AAMhCiD,gBAAM,EAAEZ,IAAI,CAACY,MANmB;AAOhCwF,mBAPgC;AAQhCuD,sBAAY,EAAE5J,IAAI,CAAChD,OAAL,CAAc,GAAE9C,QAAQ,CAAC6D,GAAI,GAAEkC,IAAI,CAACkG,QAAS,EAA7C,EAAgD,EAAhD,CARkB;AAShC5C,gBAAM,EAAEtD,IAAI,CAACsD,MAAL,IAAe;AATS,SAAnB,CAAf;;AAaA,aAAKvI,UAAL,CAAgBuJ,MAAhB,CAAuB5D,MAAvB,EAA+B,CAACoI,SAAD,EAAY3J,GAAZ,KAAoB;AACjD,cAAI2J,SAAJ,EAAe;AACb1O,oBAAQ,IAAIA,QAAQ,CAAC0O,SAAD,CAApB;;AACA,iBAAK3K,MAAL,CAAa,+CAA8CuC,MAAM,CAACwD,IAAK,OAAM,KAAK1I,cAAe,EAAjG,EAAoGsN,SAApG;AACD,WAHD,MAGO;AACL,kBAAMxL,OAAO,GAAG,KAAKvC,UAAL,CAAgBwF,OAAhB,CAAwBpB,GAAxB,CAAhB;AACA/E,oBAAQ,IAAIA,QAAQ,CAAC,IAAD,EAAOkD,OAAP,CAApB;;AACA,gBAAIkL,kBAAkB,KAAK,IAA3B,EAAiC;AAC/B,mBAAKrN,aAAL,IAAsB,KAAKA,aAAL,CAAmB4F,IAAnB,CAAwB,IAAxB,EAA8BzD,OAA9B,CAAtB;AACA,mBAAKwG,IAAL,CAAU,aAAV,EAAyBxG,OAAzB;AACD;;AACD,iBAAKa,MAAL,CAAa,gCAA+BuC,MAAM,CAACwD,IAAK,OAAM,KAAK1I,cAAe,EAAlF;AACD;AACF,SAbD;AAcD,OApDM,MAoDA;AACLpB,gBAAQ,IAAIA,QAAQ,CAAC,IAAIlB,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAuB,8BAA6BiD,IAAK,yBAAzD,CAAD,CAApB;AACD;AACF,KA1DsC,CAAvC;AA2DA,WAAO,IAAP;AACD;AAED;;;;;;;;;;;AASAP,QAAM,CAAC4F,QAAD,EAAWhL,QAAX,EAAqB;AACzB,SAAK+D,MAAL,CAAa,6BAA4B8E,IAAI,CAACC,SAAL,CAAekC,QAAf,CAAyB,IAAlE;;AACA,QAAIA,QAAQ,KAAK,KAAK,CAAtB,EAAyB;AACvB,aAAO,CAAP;AACD;;AACD7L,SAAK,CAACa,QAAD,EAAWZ,KAAK,CAACiM,QAAN,CAAehH,QAAf,CAAX,CAAL;AAEA,UAAMmL,KAAK,GAAG,KAAK7O,UAAL,CAAgBkE,IAAhB,CAAqBmG,QAArB,CAAd;;AACA,QAAIwE,KAAK,CAAChK,KAAN,KAAgB,CAApB,EAAuB;AACrBgK,WAAK,CAACC,OAAN,CAAe1J,IAAD,IAAU;AACtB,aAAK2F,MAAL,CAAY3F,IAAZ;AACD,OAFD;AAGD,KAJD,MAIO;AACL/F,cAAQ,IAAIA,QAAQ,CAAC,IAAIlB,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAsB,sCAAtB,CAAD,CAApB;AACA,aAAO,IAAP;AACD;;AAED,QAAI,KAAK1B,aAAT,EAAwB;AACtB,YAAM0O,IAAI,GAAGF,KAAK,CAACG,KAAN,EAAb;AACA,YAAM1N,IAAI,GAAG,IAAb;AACA,WAAKtB,UAAL,CAAgByE,MAAhB,CAAuB4F,QAAvB,EAAiC,YAAY;AAC3ChL,gBAAQ,IAAIA,QAAQ,CAAC4D,KAAT,CAAe,IAAf,EAAqBC,SAArB,CAAZ;AACA5B,YAAI,CAACjB,aAAL,CAAmB0O,IAAnB;AACD,OAHD;AAID,KAPD,MAOO;AACL,WAAK/O,UAAL,CAAgByE,MAAhB,CAAuB4F,QAAvB,EAAkChL,QAAQ,IAAIC,IAA9C;AACD;;AACD,WAAO,IAAP;AACD;AAED;;;;;;;;;;;AASA2P,MAAI,CAACC,KAAD,EAAQ;AACV,SAAKlP,UAAL,CAAgBiP,IAAhB,CAAqBC,KAArB;AACA,WAAO,KAAKlP,UAAZ;AACD;AAED;;;;;;;;;;;AASAmP,OAAK,CAACD,KAAD,EAAQ;AACX,SAAKlP,UAAL,CAAgBmP,KAAhB,CAAsBD,KAAtB;AACA,WAAO,KAAKlP,UAAZ;AACD;AAED;;;;;;;;;;AAQAoP,YAAU,GAAG;AACX,SAAKpP,UAAL,CAAgBiP,IAAhB,CAAqB;AACnB1F,YAAM,GAAG;AAAE,eAAO,IAAP;AAAc,OADN;;AAEnByC,YAAM,GAAG;AAAE,eAAO,IAAP;AAAc,OAFN;;AAGnBvH,YAAM,GAAG;AAAE,eAAO,IAAP;AAAc;;AAHN,KAArB;AAKA,WAAO,KAAKzE,UAAZ;AACD;AAED;;;;;;;;;;AAQAqP,aAAW,GAAG;AACZ,SAAKrP,UAAL,CAAgBmP,KAAhB,CAAsB;AACpB5F,YAAM,GAAG;AAAE,eAAO,IAAP;AAAc,OADL;;AAEpByC,YAAM,GAAG;AAAE,eAAO,IAAP;AAAc,OAFL;;AAGpBvH,YAAM,GAAG;AAAE,eAAO,IAAP;AAAc;;AAHL,KAAtB;AAKA,WAAO,KAAKzE,UAAZ;AACD;AAGD;;;;;;;;;;;;AAUA+K,QAAM,CAACxI,OAAD,EAAU0H,OAAV,EAAmB5K,QAAnB,EAA6B;AACjC,SAAK+D,MAAL,CAAa,6BAA4Bb,OAAO,CAAC6B,GAAI,KAAI6F,OAAQ,IAAjE;;AACA,QAAIA,OAAJ,EAAa;AACX,UAAIpL,OAAO,CAACuD,QAAR,CAAiBG,OAAO,CAAC+L,QAAzB,KAAsCzP,OAAO,CAACuD,QAAR,CAAiBG,OAAO,CAAC+L,QAAR,CAAiBrE,OAAjB,CAAjB,CAAtC,IAAqF1H,OAAO,CAAC+L,QAAR,CAAiBrE,OAAjB,EAA0BjF,IAAnH,EAAyH;AACvHlG,UAAE,CAACiM,MAAH,CAAUxI,OAAO,CAAC+L,QAAR,CAAiBrE,OAAjB,EAA0BjF,IAApC,EAA2C3F,QAAQ,IAAIC,IAAvD;AACD;AACF,KAJD,MAIO;AACL,UAAIT,OAAO,CAACuD,QAAR,CAAiBG,OAAO,CAAC+L,QAAzB,CAAJ,EAAwC;AACtC,aAAI,IAAIgB,IAAR,IAAgB/M,OAAO,CAAC+L,QAAxB,EAAkC;AAChC,cAAI/L,OAAO,CAAC+L,QAAR,CAAiBgB,IAAjB,KAA0B/M,OAAO,CAAC+L,QAAR,CAAiBgB,IAAjB,EAAuBtK,IAArD,EAA2D;AACzDlG,cAAE,CAACiM,MAAH,CAAUxI,OAAO,CAAC+L,QAAR,CAAiBgB,IAAjB,EAAuBtK,IAAjC,EAAwC3F,QAAQ,IAAIC,IAApD;AACD;AACF;AACF,OAND,MAMO;AACLR,UAAE,CAACiM,MAAH,CAAUxI,OAAO,CAACyC,IAAlB,EAAyB3F,QAAQ,IAAIC,IAArC;AACD;AACF;;AACD,WAAO,IAAP;AACD;AAED;;;;;;;;;AAOAiQ,MAAI,CAAC7J,IAAD,EAAO;AACT,SAAKtC,MAAL,CAAa,+BAA8BsC,IAAI,CAAC1G,OAAL,CAAawQ,WAAY,0BAApE;;AACA,UAAMrJ,IAAI,GAAG,mBAAb;;AAEA,QAAI,CAACT,IAAI,CAACU,QAAL,CAAcC,WAAnB,EAAgC;AAC9BX,UAAI,CAACU,QAAL,CAAcE,SAAd,CAAwB,GAAxB,EAA6B;AAC3B,wBAAgB,YADW;AAE3B,0BAAkBH,IAAI,CAACI;AAFI,OAA7B;AAKD;;AACD,QAAI,CAACb,IAAI,CAACU,QAAL,CAAcI,QAAnB,EAA6B;AAC3Bd,UAAI,CAACU,QAAL,CAAcxB,GAAd,CAAkBuB,IAAlB;AACD;AACF;AAED;;;;;;;;;;;;AAUA+D,UAAQ,CAACxE,IAAD,EAAOuE,OAAO,GAAG,UAAjB,EAA6B1H,OAA7B,EAAsC;AAC5C,QAAIkN,IAAJ;;AACA,SAAKrM,MAAL,CAAa,+BAA8BsC,IAAI,CAAC1G,OAAL,CAAawQ,WAAY,KAAIvF,OAAQ,IAAhF;;AAEA,QAAI1H,OAAJ,EAAa;AACX,UAAI1D,OAAO,CAACqO,GAAR,CAAY3K,OAAZ,EAAqB,UAArB,KAAoC1D,OAAO,CAACqO,GAAR,CAAY3K,OAAO,CAAC+L,QAApB,EAA8BrE,OAA9B,CAAxC,EAAgF;AAC9EwF,YAAI,GAAGlN,OAAO,CAAC+L,QAAR,CAAiBrE,OAAjB,CAAP;AACAwF,YAAI,CAACrL,GAAL,GAAW7B,OAAO,CAAC6B,GAAnB;AACD,OAHD,MAGO;AACLqL,YAAI,GAAGlN,OAAP;AACD;AACF,KAPD,MAOO;AACLkN,UAAI,GAAG,KAAP;AACD;;AAED,QAAI,CAACA,IAAD,IAAS,CAAC5Q,OAAO,CAACuD,QAAR,CAAiBqN,IAAjB,CAAd,EAAsC;AACpC,aAAO,KAAKF,IAAL,CAAU7J,IAAV,CAAP;AACD,KAFD,MAEO,IAAInD,OAAJ,EAAa;AAClB,UAAI,KAAKxB,gBAAT,EAA2B;AACzB,YAAI,CAAC,KAAKA,gBAAL,CAAsBiF,IAAtB,CAA2BpC,MAAM,CAACqC,MAAP,CAAcP,IAAd,EAAoB,KAAKI,QAAL,CAAcJ,IAAd,CAApB,CAA3B,EAAqEnD,OAArE,CAAL,EAAoF;AAClF,iBAAO,KAAKgN,IAAL,CAAU7J,IAAV,CAAP;AACD;AACF;;AAED,UAAI,KAAKzE,iBAAL,IAA0BpC,OAAO,CAACoD,UAAR,CAAmB,KAAKhB,iBAAxB,CAA9B,EAA0E;AACxE,YAAI,KAAKA,iBAAL,CAAuByE,IAAvB,EAA6BnD,OAA7B,EAAsC0H,OAAtC,MAAmD,IAAvD,EAA6D;AAC3D,iBAAO,KAAK,CAAZ;AACD;AACF;;AAEDnL,QAAE,CAACsP,IAAH,CAAQqB,IAAI,CAACzK,IAAb,EAAmB,CAAC0J,OAAD,EAAUL,KAAV,KAAoBlP,KAAK,CAAC,MAAM;AACjD,YAAIuQ,YAAJ;;AACA,YAAIhB,OAAO,IAAI,CAACL,KAAK,CAACM,MAAN,EAAhB,EAAgC;AAC9B,iBAAO,KAAKY,IAAL,CAAU7J,IAAV,CAAP;AACD;;AAED,YAAK2I,KAAK,CAACzL,IAAN,KAAe6M,IAAI,CAAC7M,IAArB,IAA8B,CAAC,KAAKpC,cAAxC,EAAwD;AACtDiP,cAAI,CAAC7M,IAAL,GAAeyL,KAAK,CAACzL,IAArB;AACD;;AAED,YAAKyL,KAAK,CAACzL,IAAN,KAAe6M,IAAI,CAAC7M,IAArB,IAA8B,KAAKpC,cAAvC,EAAuD;AACrDkP,sBAAY,GAAG,KAAf;AACD;;AAED,eAAO,KAAKC,KAAL,CAAWjK,IAAX,EAAiBnD,OAAjB,EAA0BkN,IAA1B,EAAgCxF,OAAhC,EAAyC,IAAzC,EAAgDyF,YAAY,IAAI,KAAhE,CAAP;AACD,OAf2C,CAA5C;AAgBA,aAAO,KAAK,CAAZ;AACD;;AACD,WAAO,KAAKH,IAAL,CAAU7J,IAAV,CAAP;AACD;AAED;;;;;;;;;;;;;;;;AAcAiK,OAAK,CAACjK,IAAD,EAAOnD,OAAP,EAAgBkN,IAAhB,EAAsBxF,OAAO,GAAG,UAAhC,EAA4C2F,cAAc,GAAG,IAA7D,EAAmEC,aAAa,GAAG,KAAnF,EAA0FC,QAAQ,GAAG,KAArG,EAA4G;AAC/G,QAAIC,QAAQ,GAAG,KAAf;AACA,QAAIC,QAAQ,GAAG,KAAf;AACA,QAAIC,eAAe,GAAG,EAAtB;AACA,QAAIC,KAAJ;AACA,QAAItL,GAAJ;AACA,QAAIuL,IAAJ;AACA,QAAIT,YAAY,GAAGG,aAAnB;;AAEA,QAAInK,IAAI,CAACK,MAAL,CAAYiE,KAAZ,CAAkBE,QAAlB,IAA+BxE,IAAI,CAACK,MAAL,CAAYiE,KAAZ,CAAkBE,QAAlB,KAA+B,MAAlE,EAA2E;AACzE+F,qBAAe,GAAG,cAAlB;AACD,KAFD,MAEO;AACLA,qBAAe,GAAG,UAAlB;AACD;;AAED,UAAMG,eAAe,GAAQ,cAAaC,SAAS,CAACZ,IAAI,CAACtG,IAAL,IAAa5G,OAAO,CAAC4G,IAAtB,CAAT,CAAqCnH,OAArC,CAA6C,KAA7C,EAAoD,KAApD,CAA2D,wBAAuBsO,kBAAkB,CAACb,IAAI,CAACtG,IAAL,IAAa5G,OAAO,CAAC4G,IAAtB,CAA4B,IAA1K;AACA,UAAMoH,mBAAmB,GAAG,eAA5B;;AAEA,QAAI,CAAC7K,IAAI,CAACU,QAAL,CAAcC,WAAnB,EAAgC;AAC9BX,UAAI,CAACU,QAAL,CAAcoK,SAAd,CAAwB,qBAAxB,EAA+CP,eAAe,GAAGG,eAAlB,GAAoCG,mBAAnF;AACD;;AAED,QAAI7K,IAAI,CAAC1G,OAAL,CAAayD,OAAb,CAAqBgO,KAArB,IAA8B,CAACX,QAAnC,EAA6C;AAC3CC,cAAQ,GAAM,IAAd;AACA,YAAMW,KAAK,GAAGhL,IAAI,CAAC1G,OAAL,CAAayD,OAAb,CAAqBgO,KAArB,CAA2B1G,KAA3B,CAAiC,yBAAjC,CAAd;AACAmG,WAAK,GAAS/N,QAAQ,CAACuO,KAAK,CAAC,CAAD,CAAN,CAAtB;AACA9L,SAAG,GAAWzC,QAAQ,CAACuO,KAAK,CAAC,CAAD,CAAN,CAAtB;;AACA,UAAIC,KAAK,CAAC/L,GAAD,CAAT,EAAgB;AACdA,WAAG,GAAS6K,IAAI,CAAC7M,IAAL,GAAY,CAAxB;AACD;;AACDuN,UAAI,GAAUvL,GAAG,GAAGsL,KAApB;AACD,KATD,MASO;AACLA,WAAK,GAAG,CAAR;AACAtL,SAAG,GAAK6K,IAAI,CAAC7M,IAAL,GAAY,CAApB;AACAuN,UAAI,GAAIV,IAAI,CAAC7M,IAAb;AACD;;AAED,QAAImN,QAAQ,IAAKrK,IAAI,CAACK,MAAL,CAAYiE,KAAZ,CAAkB4G,IAAlB,IAA2BlL,IAAI,CAACK,MAAL,CAAYiE,KAAZ,CAAkB4G,IAAlB,KAA2B,MAAvE,EAAiF;AAC/EZ,cAAQ,GAAG;AAACE,aAAD;AAAQtL;AAAR,OAAX;;AACA,UAAI+L,KAAK,CAACT,KAAD,CAAL,IAAgB,CAACS,KAAK,CAAC/L,GAAD,CAA1B,EAAiC;AAC/BoL,gBAAQ,CAACE,KAAT,GAAiBtL,GAAG,GAAGuL,IAAvB;AACAH,gBAAQ,CAACpL,GAAT,GAAiBA,GAAjB;AACD;;AACD,UAAI,CAAC+L,KAAK,CAACT,KAAD,CAAN,IAAiBS,KAAK,CAAC/L,GAAD,CAA1B,EAAiC;AAC/BoL,gBAAQ,CAACE,KAAT,GAAiBA,KAAjB;AACAF,gBAAQ,CAACpL,GAAT,GAAiBsL,KAAK,GAAGC,IAAzB;AACD;;AAED,UAAKD,KAAK,GAAGC,IAAT,IAAkBV,IAAI,CAAC7M,IAA3B,EAAiC;AAAEoN,gBAAQ,CAACpL,GAAT,GAAe6K,IAAI,CAAC7M,IAAL,GAAY,CAA3B;AAA+B;;AAElE,UAAI,KAAK/C,MAAL,KAAiBmQ,QAAQ,CAACE,KAAT,IAAmBT,IAAI,CAAC7M,IAAL,GAAY,CAAhC,IAAwCoN,QAAQ,CAACpL,GAAT,GAAgB6K,IAAI,CAAC7M,IAAL,GAAY,CAApF,CAAJ,EAA8F;AAC5F8M,oBAAY,GAAG,KAAf;AACD,OAFD,MAEO;AACLA,oBAAY,GAAG,KAAf;AACD;AACF,KAlBD,MAkBO;AACLA,kBAAY,GAAG,KAAf;AACD;;AAED,UAAMmB,kBAAkB,GAAItN,KAAD,IAAW;AACpC,WAAKH,MAAL,CAAa,4BAA2BqM,IAAI,CAACzK,IAAK,KAAIiF,OAAQ,UAA9D,EAAyE1G,KAAzE;;AACA,UAAI,CAACmC,IAAI,CAACU,QAAL,CAAcI,QAAnB,EAA6B;AAC3Bd,YAAI,CAACU,QAAL,CAAcxB,GAAd,CAAkBrB,KAAK,CAAC0E,QAAN,EAAlB;AACD;AACF,KALD;;AAOA,UAAMxF,OAAO,GAAG5D,OAAO,CAACoD,UAAR,CAAmB,KAAKrB,eAAxB,IAA2C,KAAKA,eAAL,CAAqB8O,YAArB,EAAmCnN,OAAnC,EAA4CkN,IAA5C,EAAkDxF,OAAlD,CAA3C,GAAwG,KAAKrJ,eAA7H;;AAEA,QAAI,CAAC6B,OAAO,CAAC,eAAD,CAAZ,EAA+B;AAC7B,UAAI,CAACiD,IAAI,CAACU,QAAL,CAAcC,WAAnB,EAAgC;AAC9BX,YAAI,CAACU,QAAL,CAAcoK,SAAd,CAAwB,eAAxB,EAAyC,KAAKtQ,YAA9C;AACD;AACF;;AAED,SAAK,IAAI4Q,GAAT,IAAgBrO,OAAhB,EAAyB;AACvB,UAAI,CAACiD,IAAI,CAACU,QAAL,CAAcC,WAAnB,EAAgC;AAC9BX,YAAI,CAACU,QAAL,CAAcoK,SAAd,CAAwBM,GAAxB,EAA6BrO,OAAO,CAACqO,GAAD,CAApC;AACD;AACF;;AAED,UAAMC,OAAO,GAAG,CAACpD,MAAD,EAASqD,IAAT,KAAkB;AAChC,UAAI,CAACtL,IAAI,CAACU,QAAL,CAAcC,WAAf,IAA8BuJ,cAAlC,EAAkD;AAChDlK,YAAI,CAACU,QAAL,CAAcE,SAAd,CAAwB0K,IAAxB;AACD;;AAEDtL,UAAI,CAACU,QAAL,CAAcU,EAAd,CAAiB,OAAjB,EAA0B,MAAM;AAC9B,YAAI,OAAO6G,MAAM,CAAC7I,KAAd,KAAwB,UAA5B,EAAwC;AACtC6I,gBAAM,CAAC7I,KAAP;AACD;;AACD,YAAI,OAAO6I,MAAM,CAAC/I,GAAd,KAAsB,UAA1B,EAAsC;AACpC+I,gBAAM,CAAC/I,GAAP;AACD;AACF,OAPD;AASAc,UAAI,CAAC1G,OAAL,CAAa8H,EAAb,CAAgB,SAAhB,EAA2B,MAAM;AAC/BpB,YAAI,CAAC1G,OAAL,CAAaqG,OAAb,GAAuB,IAAvB;;AACA,YAAI,OAAOsI,MAAM,CAAC7I,KAAd,KAAwB,UAA5B,EAAwC;AACtC6I,gBAAM,CAAC7I,KAAP;AACD;;AACD,YAAI,OAAO6I,MAAM,CAAC/I,GAAd,KAAsB,UAA1B,EAAsC;AACpC+I,gBAAM,CAAC/I,GAAP;AACD;AACF,OARD;AAUA+I,YAAM,CAAC7G,EAAP,CAAU,MAAV,EAAkB,MAAM;AACtB,YAAI,CAACpB,IAAI,CAACU,QAAL,CAAcC,WAAnB,EAAgC;AAC9BX,cAAI,CAACU,QAAL,CAAcE,SAAd,CAAwB0K,IAAxB;AACD;AACF,OAJD,EAIGlK,EAJH,CAIM,OAJN,EAIe,MAAM;AACnB,YAAI,CAACpB,IAAI,CAACU,QAAL,CAAcI,QAAnB,EAA6B;AAC3Bd,cAAI,CAACU,QAAL,CAAcxB,GAAd;AACD;;AACD,YAAI,CAACc,IAAI,CAAC1G,OAAL,CAAaqG,OAAlB,EAA2B;AACzBK,cAAI,CAAC1G,OAAL,CAAaiS,OAAb;AACD;AACF,OAXD,EAWGnK,EAXH,CAWM,OAXN,EAWe+J,kBAXf,EAYE/J,EAZF,CAYK,KAZL,EAYY,MAAM;AAChB,YAAI,CAACpB,IAAI,CAACU,QAAL,CAAcI,QAAnB,EAA6B;AAC3Bd,cAAI,CAACU,QAAL,CAAcxB,GAAd;AACD;AACF,OAhBD,EAgBG4J,IAhBH,CAgBQ9I,IAAI,CAACU,QAhBb;AAiBD,KAzCD;;AA2CA,YAAQsJ,YAAR;AACA,WAAK,KAAL;AACE,aAAKtM,MAAL,CAAa,4BAA2BqM,IAAI,CAACzK,IAAK,KAAIiF,OAAQ,mCAA9D;;AACA,YAAI9D,IAAI,GAAG,0BAAX;;AAEA,YAAI,CAACT,IAAI,CAACU,QAAL,CAAcC,WAAnB,EAAgC;AAC9BX,cAAI,CAACU,QAAL,CAAcE,SAAd,CAAwB,GAAxB,EAA6B;AAC3B,4BAAgB,YADW;AAE3B,8BAAkBH,IAAI,CAACI;AAFI,WAA7B;AAID;;AAED,YAAI,CAACb,IAAI,CAACU,QAAL,CAAcI,QAAnB,EAA6B;AAC3Bd,cAAI,CAACU,QAAL,CAAcxB,GAAd,CAAkBuB,IAAlB;AACD;;AACD;;AACF,WAAK,KAAL;AACE,aAAKoJ,IAAL,CAAU7J,IAAV;;AACA;;AACF,WAAK,KAAL;AACE,aAAKtC,MAAL,CAAa,4BAA2BqM,IAAI,CAACzK,IAAK,KAAIiF,OAAQ,0CAA9D;;AACA,YAAI,CAACvE,IAAI,CAACU,QAAL,CAAcC,WAAnB,EAAgC;AAC9BX,cAAI,CAACU,QAAL,CAAcE,SAAd,CAAwB,GAAxB;AACD;;AACD,YAAI,CAACZ,IAAI,CAACU,QAAL,CAAcI,QAAnB,EAA6B;AAC3Bd,cAAI,CAACU,QAAL,CAAcxB,GAAd;AACD;;AACD;;AACF,WAAK,KAAL;AACE,aAAKxB,MAAL,CAAa,4BAA2BqM,IAAI,CAACzK,IAAK,KAAIiF,OAAQ,UAA9D;;AACA,YAAI,CAACvE,IAAI,CAACU,QAAL,CAAcC,WAAnB,EAAgC;AAC9BX,cAAI,CAACU,QAAL,CAAcoK,SAAd,CAAwB,eAAxB,EAA0C,SAAQR,QAAQ,CAACE,KAAM,IAAGF,QAAQ,CAACpL,GAAI,IAAG6K,IAAI,CAAC7M,IAAK,EAA9F;AACD;;AACDmO,eAAO,CAACnB,cAAc,IAAI9Q,EAAE,CAACoS,gBAAH,CAAoBzB,IAAI,CAACzK,IAAzB,EAA+B;AAACkL,eAAK,EAAEF,QAAQ,CAACE,KAAjB;AAAwBtL,aAAG,EAAEoL,QAAQ,CAACpL;AAAtC,SAA/B,CAAnB,EAA+F,GAA/F,CAAP;AACA;;AACF;AACE,aAAKxB,MAAL,CAAa,4BAA2BqM,IAAI,CAACzK,IAAK,KAAIiF,OAAQ,UAA9D;;AACA8G,eAAO,CAACnB,cAAc,IAAI9Q,EAAE,CAACoS,gBAAH,CAAoBzB,IAAI,CAACzK,IAAzB,CAAnB,EAAmD,GAAnD,CAAP;AACA;AAtCF;AAwCD;;AAlqDsD,C;;;;;;;;;;;ACjEzDpH,MAAM,CAACC,MAAP,CAAc;AAACU,SAAO,EAAC,MAAIG;AAAb,CAAd;AAAiD,IAAIyS,YAAJ;AAAiBvT,MAAM,CAACI,IAAP,CAAY,eAAZ,EAA4B;AAACmT,cAAY,CAAClT,CAAD,EAAG;AAACkT,gBAAY,GAAClT,CAAb;AAAe;;AAAhC,CAA5B,EAA8D,CAA9D;AAAiE,IAAIO,KAAJ,EAAUC,KAAV;AAAgBb,MAAM,CAACI,IAAP,CAAY,cAAZ,EAA2B;AAACQ,OAAK,CAACP,CAAD,EAAG;AAACO,SAAK,GAACP,CAAN;AAAQ,GAAlB;;AAAmBQ,OAAK,CAACR,CAAD,EAAG;AAACQ,SAAK,GAACR,CAAN;AAAQ;;AAApC,CAA3B,EAAiE,CAAjE;AAAoE,IAAImT,YAAJ,EAAiBvS,OAAjB;AAAyBjB,MAAM,CAACI,IAAP,CAAY,UAAZ,EAAuB;AAACoT,cAAY,CAACnT,CAAD,EAAG;AAACmT,gBAAY,GAACnT,CAAb;AAAe,GAAhC;;AAAiCY,SAAO,CAACZ,CAAD,EAAG;AAACY,WAAO,GAACZ,CAAR;AAAU;;AAAtD,CAAvB,EAA+E,CAA/E;AAAkF,IAAIoT,WAAJ,EAAgBC,UAAhB;AAA2B1T,MAAM,CAACI,IAAP,CAAY,aAAZ,EAA0B;AAACqT,aAAW,CAACpT,CAAD,EAAG;AAACoT,eAAW,GAACpT,CAAZ;AAAc,GAA9B;;AAA+BqT,YAAU,CAACrT,CAAD,EAAG;AAACqT,cAAU,GAACrT,CAAX;AAAa;;AAA1D,CAA1B,EAAsF,CAAtF;;AAK9U,MAAMS,mBAAN,SAAkCyS,YAAlC,CAA+C;AAC5D5R,aAAW,GAAG;AACZ;AACD;;AA0FD;;;;;;;AAOA6D,QAAM,GAAG;AACP,QAAI,KAAK1D,KAAT,EAAgB;AACd,OAACoI,OAAO,CAACyJ,IAAR,IAAgBzJ,OAAO,CAAC0J,GAAxB,IAA+B,YAAY,CAAG,CAA/C,EAAiDvO,KAAjD,CAAuD,KAAK,CAA5D,EAA+DC,SAA/D;AACD;AACF;AAED;;;;;;;;;;AAQAkI,cAAY,CAACgB,QAAD,EAAW;AACrB,UAAMjB,QAAQ,GAAGiB,QAAQ,CAACjD,IAAT,IAAiBiD,QAAQ,CAACjB,QAA3C;;AACA,QAAItM,OAAO,CAAC6C,QAAR,CAAiByJ,QAAjB,KAA+BA,QAAQ,CAAC5E,MAAT,GAAkB,CAArD,EAAyD;AACvD,aAAO,CAAC6F,QAAQ,CAACjD,IAAT,IAAiBiD,QAAQ,CAACjB,QAA3B,EAAqCnJ,OAArC,CAA6C,QAA7C,EAAuD,EAAvD,EAA2DA,OAA3D,CAAmE,SAAnE,EAA8E,GAA9E,EAAmFA,OAAnF,CAA2F,KAA3F,EAAkG,EAAlG,CAAP;AACD;;AACD,WAAO,EAAP;AACD;AAED;;;;;;;;;;AAQAuJ,SAAO,CAACJ,QAAD,EAAW;AAChB,QAAI,CAAC,CAAC,CAACA,QAAQ,CAACzD,OAAT,CAAiB,GAAjB,CAAP,EAA8B;AAC5B,YAAM2D,SAAS,GAAG,CAACF,QAAQ,CAACpB,KAAT,CAAe,GAAf,EAAoB0H,GAApB,GAA0B1H,KAA1B,CAAgC,GAAhC,EAAqC,CAArC,KAA2C,EAA5C,EAAgD2H,WAAhD,EAAlB;AACA,aAAO;AAAElG,WAAG,EAAEH,SAAP;AAAkBA,iBAAlB;AAA6BC,wBAAgB,EAAG,IAAGD,SAAU;AAA7D,OAAP;AACD;;AACD,WAAO;AAAEG,SAAG,EAAE,EAAP;AAAWH,eAAS,EAAE,EAAtB;AAA0BC,sBAAgB,EAAE;AAA5C,KAAP;AACD;AAED;;;;;;;;;AAOAQ,kBAAgB,CAACzD,IAAD,EAAO;AACrBA,QAAI,CAACsJ,OAAL,GAAgB,YAAYC,IAAZ,CAAiBvJ,IAAI,CAACvF,IAAtB,CAAhB;AACAuF,QAAI,CAACwJ,OAAL,GAAgB,YAAYD,IAAZ,CAAiBvJ,IAAI,CAACvF,IAAtB,CAAhB;AACAuF,QAAI,CAACyJ,OAAL,GAAgB,YAAYF,IAAZ,CAAiBvJ,IAAI,CAACvF,IAAtB,CAAhB;AACAuF,QAAI,CAAC0J,MAAL,GAAgB,WAAWH,IAAX,CAAgBvJ,IAAI,CAACvF,IAArB,CAAhB;AACAuF,QAAI,CAAC2J,MAAL,GAAgB,uBAAuBJ,IAAvB,CAA4BvJ,IAAI,CAACvF,IAAjC,CAAhB;AACAuF,QAAI,CAAC4J,KAAL,GAAgB,2BAA2BL,IAA3B,CAAgCvJ,IAAI,CAACvF,IAArC,CAAhB;AACD;AAED;;;;;;;;;;AAQA2I,eAAa,CAACpD,IAAD,EAAO;AAClB,UAAM6J,EAAE,GAAG;AACT/I,UAAI,EAAEd,IAAI,CAACc,IADF;AAETkC,eAAS,EAAEhD,IAAI,CAACgD,SAFP;AAGTG,SAAG,EAAEnD,IAAI,CAACgD,SAHD;AAITC,sBAAgB,EAAE,MAAMjD,IAAI,CAACgD,SAJpB;AAKTrG,UAAI,EAAEqD,IAAI,CAACrD,IALF;AAMT8D,UAAI,EAAET,IAAI,CAACS,IANF;AAOThG,UAAI,EAAEuF,IAAI,CAACvF,IAPF;AAQTuJ,UAAI,EAAEhE,IAAI,CAACvF,IARF;AAST,mBAAauF,IAAI,CAACvF,IATT;AAUTF,UAAI,EAAEyF,IAAI,CAACzF,IAVF;AAWTiD,YAAM,EAAEwC,IAAI,CAACxC,MAAL,IAAe,IAXd;AAYTyI,cAAQ,EAAE;AACRC,gBAAQ,EAAE;AACRvJ,cAAI,EAAEqD,IAAI,CAACrD,IADH;AAERpC,cAAI,EAAEyF,IAAI,CAACzF,IAFH;AAGRE,cAAI,EAAEuF,IAAI,CAACvF,IAHH;AAIRuI,mBAAS,EAAEhD,IAAI,CAACgD;AAJR;AADF,OAZD;AAoBT8G,oBAAc,EAAE9J,IAAI,CAAC8J,cAAL,IAAuB,KAAKhS,aApBnC;AAqBTiS,qBAAe,EAAE/J,IAAI,CAAC+J,eAAL,IAAwB,KAAK3R;AArBrC,KAAX,CADkB,CAyBlB;;AACA,QAAI4H,IAAI,CAACE,MAAT,EAAiB;AACf2J,QAAE,CAAC9N,GAAH,GAASiE,IAAI,CAACE,MAAd;AACD;;AAED,SAAKuD,gBAAL,CAAsBoG,EAAtB;;AACAA,MAAE,CAACtD,YAAH,GAAkBvG,IAAI,CAACuG,YAAL,IAAqB,KAAKnP,WAAL,CAAiBmE,MAAM,CAACqC,MAAP,CAAc,EAAd,EAAkBoC,IAAlB,EAAwB6J,EAAxB,CAAjB,CAAvC;AACA,WAAOA,EAAP;AACD;AAED;;;;;;;;;;;AASA1M,SAAO,CAAC6E,QAAQ,GAAG,EAAZ,EAAgBgI,OAAhB,EAAyB;AAC9B,SAAKjP,MAAL,CAAa,8BAA6B8E,IAAI,CAACC,SAAL,CAAekC,QAAf,CAAyB,KAAInC,IAAI,CAACC,SAAL,CAAekK,OAAf,CAAwB,IAA/F;;AACA7T,SAAK,CAAC6L,QAAD,EAAW5L,KAAK,CAACiM,QAAN,CAAejM,KAAK,CAACkF,KAAN,CAAYC,MAAZ,EAAoB9B,MAApB,EAA4B0B,OAA5B,EAAqCC,MAArC,EAA6C,IAA7C,CAAf,CAAX,CAAL;AACAjF,SAAK,CAAC6T,OAAD,EAAU5T,KAAK,CAACiM,QAAN,CAAe9G,MAAf,CAAV,CAAL;AAEA,UAAMY,GAAG,GAAG,KAAKxE,UAAL,CAAgBwF,OAAhB,CAAwB6E,QAAxB,EAAkCgI,OAAlC,CAAZ;;AACA,QAAI7N,GAAJ,EAAS;AACP,aAAO,IAAI8M,UAAJ,CAAe9M,GAAf,EAAoB,IAApB,CAAP;AACD;;AACD,WAAOA,GAAP;AACD;AAED;;;;;;;;;;;AASAN,MAAI,CAACmG,QAAQ,GAAG,EAAZ,EAAgBgI,OAAhB,EAAyB;AAC3B,SAAKjP,MAAL,CAAa,2BAA0B8E,IAAI,CAACC,SAAL,CAAekC,QAAf,CAAyB,KAAInC,IAAI,CAACC,SAAL,CAAekK,OAAf,CAAwB,IAA5F;;AACA7T,SAAK,CAAC6L,QAAD,EAAW5L,KAAK,CAACiM,QAAN,CAAejM,KAAK,CAACkF,KAAN,CAAYC,MAAZ,EAAoB9B,MAApB,EAA4B0B,OAA5B,EAAqCC,MAArC,EAA6C,IAA7C,CAAf,CAAX,CAAL;AACAjF,SAAK,CAAC6T,OAAD,EAAU5T,KAAK,CAACiM,QAAN,CAAe9G,MAAf,CAAV,CAAL;AAEA,WAAO,IAAIyN,WAAJ,CAAgBhH,QAAhB,EAA0BgI,OAA1B,EAAmC,IAAnC,CAAP;AACD;AAED;;;;;;;;;;AAQArG,QAAM,GAAG;AACP,SAAKhM,UAAL,CAAgBgM,MAAhB,CAAuB/I,KAAvB,CAA6B,KAAKjD,UAAlC,EAA8CkD,SAA9C;AACA,WAAO,KAAKlD,UAAZ;AACD;AAED;;;;;;;;;;;;AAUAhC,MAAI,CAACuE,OAAD,EAAU0H,OAAO,GAAG,UAApB,EAAgCqI,OAAhC,EAAyC;AAC3C,SAAKlP,MAAL,CAAa,2BAA2BvE,OAAO,CAACuD,QAAR,CAAiBG,OAAjB,IAA4BA,OAAO,CAAC6B,GAApC,GAA0C,KAAK,CAAG,KAAI6F,OAAQ,IAAtG;;AACAzL,SAAK,CAAC+D,OAAD,EAAUqB,MAAV,CAAL;;AAEA,QAAI,CAACrB,OAAL,EAAc;AACZ,aAAO,EAAP;AACD;;AACD,WAAO6O,YAAY,CAAC7O,OAAD,EAAU0H,OAAV,EAAmBqI,OAAnB,CAAnB;AACD;;AA1Q2D;;AAAzC5T,mB,CAKZ6T,S,GAAY1T,O;AALAH,mB,CAOZiB,M,GAAS;AACdyE,KAAG,EAAE;AACHtB,QAAI,EAAEhB;AADH,GADS;AAIdc,MAAI,EAAE;AACJE,QAAI,EAAEW;AADF,GAJQ;AAOd0F,MAAI,EAAE;AACJrG,QAAI,EAAEhB;AADF,GAPQ;AAUdgB,MAAI,EAAE;AACJA,QAAI,EAAEhB;AADF,GAVQ;AAadkD,MAAI,EAAE;AACJlC,QAAI,EAAEhB;AADF,GAbQ;AAgBd6P,SAAO,EAAE;AACP7O,QAAI,EAAEU;AADC,GAhBK;AAmBdqO,SAAO,EAAE;AACP/O,QAAI,EAAEU;AADC,GAnBK;AAsBdsO,SAAO,EAAE;AACPhP,QAAI,EAAEU;AADC,GAtBK;AAyBduO,QAAM,EAAE;AACNjP,QAAI,EAAEU;AADA,GAzBM;AA4BdwO,QAAM,EAAE;AACNlP,QAAI,EAAEU;AADA,GA5BM;AA+BdyO,OAAK,EAAE;AACLnP,QAAI,EAAEU;AADD,GA/BO;AAkCd6H,WAAS,EAAE;AACTvI,QAAI,EAAEhB,MADG;AAET0Q,YAAQ,EAAE;AAFD,GAlCG;AAsCdhH,KAAG,EAAE;AACH1I,QAAI,EAAEhB,MADH;AAEH0Q,YAAQ,EAAE;AAFP,GAtCS;AA0CdlH,kBAAgB,EAAE;AAChBxI,QAAI,EAAEhB,MADU;AAEhB0Q,YAAQ,EAAE;AAFM,GA1CJ;AA8CdnG,MAAI,EAAE;AACJvJ,QAAI,EAAEhB,MADF;AAEJ0Q,YAAQ,EAAE;AAFN,GA9CQ;AAkDd,eAAa;AACX1P,QAAI,EAAEhB,MADK;AAEX0Q,YAAQ,EAAE;AAFC,GAlDC;AAsDd5D,cAAY,EAAE;AACZ9L,QAAI,EAAEhB;AADM,GAtDA;AAyDdqQ,gBAAc,EAAE;AACdrP,QAAI,EAAEhB;AADQ,GAzDF;AA4DdsQ,iBAAe,EAAE;AACftP,QAAI,EAAEhB;AADS,GA5DH;AA+DdlC,QAAM,EAAE;AACNkD,QAAI,EAAEU,OADA;AAENgP,YAAQ,EAAE;AAFJ,GA/DM;AAmEd1J,MAAI,EAAE;AACJhG,QAAI,EAAEc,MADF;AAEJ6O,YAAQ,EAAE,IAFN;AAGJD,YAAQ,EAAE;AAHN,GAnEQ;AAwEd3M,QAAM,EAAE;AACN/C,QAAI,EAAEhB,MADA;AAEN0Q,YAAQ,EAAE;AAFJ,GAxEM;AA4EdE,WAAS,EAAE;AACT5P,QAAI,EAAEuG,IADG;AAETmJ,YAAQ,EAAE;AAFD,GA5EG;AAgFdlE,UAAQ,EAAE;AACRxL,QAAI,EAAEc,MADE;AAER6O,YAAQ,EAAE;AAFF;AAhFI,C;;;;;;;;;;;ACZlB7U,MAAM,CAACC,MAAP,CAAc;AAACyT,YAAU,EAAC,MAAIA,UAAhB;AAA2BD,aAAW,EAAC,MAAIA;AAA3C,CAAd;AAAuE,IAAIlT,MAAJ;AAAWP,MAAM,CAACI,IAAP,CAAY,eAAZ,EAA4B;AAACG,QAAM,CAACF,CAAD,EAAG;AAACE,UAAM,GAACF,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;;AAU3E,MAAMqT,UAAN,CAAiB;AACtB/R,aAAW,CAACoT,QAAD,EAAWC,WAAX,EAAwB;AACjC,SAAKD,QAAL,GAAmBA,QAAnB;AACA,SAAKC,WAAL,GAAmBA,WAAnB;AACAhP,UAAM,CAACqC,MAAP,CAAc,IAAd,EAAoB0M,QAApB;AACD;AAED;;;;;;;;;;AAQAlO,QAAM,CAACpF,QAAD,EAAW;AACf,SAAKuT,WAAL,CAAiBxP,MAAjB,CAAwB,2CAAxB;;AACA,QAAI,KAAKuP,QAAT,EAAmB;AACjB,WAAKC,WAAL,CAAiBnO,MAAjB,CAAwB,KAAKkO,QAAL,CAAcvO,GAAtC,EAA2C/E,QAA3C;AACD,KAFD,MAEO;AACLA,cAAQ,IAAIA,QAAQ,CAAC,IAAIlB,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAsB,cAAtB,CAAD,CAApB;AACD;;AACD,WAAO,IAAP;AACD;AAED;;;;;;;;;;;AASA/D,MAAI,CAACiM,OAAO,GAAG,UAAX,EAAuBqI,OAAvB,EAAgC;AAClC,SAAKM,WAAL,CAAiBxP,MAAjB,CAAyB,wCAAuC6G,OAAQ,IAAxE;;AACA,QAAI,KAAK0I,QAAT,EAAmB;AACjB,aAAO,KAAKC,WAAL,CAAiB5U,IAAjB,CAAsB,KAAK2U,QAA3B,EAAqC1I,OAArC,EAA8CqI,OAA9C,CAAP;AACD;;AACD,WAAO,EAAP;AACD;AAED;;;;;;;;;;AAQAnF,KAAG,CAAC0F,QAAD,EAAW;AACZ,SAAKD,WAAL,CAAiBxP,MAAjB,CAAyB,uCAAsCyP,QAAS,IAAxE;;AACA,QAAIA,QAAJ,EAAc;AACZ,aAAO,KAAKF,QAAL,CAAcE,QAAd,CAAP;AACD;;AACD,WAAO,KAAKF,QAAZ;AACD;AAED;;;;;;;;;AAOA3D,OAAK,GAAG;AACN,SAAK4D,WAAL,CAAiBxP,MAAjB,CAAwB,0CAAxB;;AACA,WAAO,CAAC,KAAKuP,QAAN,CAAP;AACD;AAED;;;;;;;;;AAOAG,MAAI,GAAG;AACL,SAAKF,WAAL,CAAiBxP,MAAjB,CAAwB,yCAAxB;;AACA,WAAOQ,MAAM,CAACqC,MAAP,CAAc,IAAd,EAAoB,KAAK2M,WAAL,CAAiB5S,UAAjB,CAA4BwF,OAA5B,CAAoC,KAAKmN,QAAL,CAAcvO,GAAlD,CAApB,CAAP;AACD;;AAhFqB;;AA4FjB,MAAMiN,WAAN,CAAkB;AACvB9R,aAAW,CAACwT,SAAS,GAAG,EAAb,EAAiBV,OAAjB,EAA0BO,WAA1B,EAAuC;AAChD,SAAKA,WAAL,GAAmBA,WAAnB;AACA,SAAKG,SAAL,GAAmBA,SAAnB;AACA,SAAKC,QAAL,GAAmB,CAAC,CAApB;AACA,SAAKxI,MAAL,GAAmB,KAAKoI,WAAL,CAAiB5S,UAAjB,CAA4BkE,IAA5B,CAAiC,KAAK6O,SAAtC,EAAiDV,OAAjD,CAAnB;AACD;AAED;;;;;;;;;AAOAlF,KAAG,GAAG;AACJ,SAAKyF,WAAL,CAAiBxP,MAAjB,CAAwB,yCAAxB;;AACA,WAAO,KAAKoH,MAAL,CAAYwE,KAAZ,EAAP;AACD;AAED;;;;;;;;;AAOAiE,SAAO,GAAG;AACR,SAAKL,WAAL,CAAiBxP,MAAjB,CAAwB,6CAAxB;;AACA,WAAO,KAAK4P,QAAL,GAAiB,KAAKxI,MAAL,CAAY3F,KAAZ,KAAsB,CAA9C;AACD;AAED;;;;;;;;;AAOA2C,MAAI,GAAG;AACL,SAAKoL,WAAL,CAAiBxP,MAAjB,CAAwB,0CAAxB;;AACA,SAAKoH,MAAL,CAAYwE,KAAZ,GAAoB,EAAE,KAAKgE,QAA3B;AACD;AAED;;;;;;;;;AAOAE,aAAW,GAAG;AACZ,SAAKN,WAAL,CAAiBxP,MAAjB,CAAwB,iDAAxB;;AACA,WAAO,KAAK4P,QAAL,KAAkB,CAAC,CAA1B;AACD;AAED;;;;;;;;;AAOAG,UAAQ,GAAG;AACT,SAAKP,WAAL,CAAiBxP,MAAjB,CAAwB,8CAAxB;;AACA,SAAKoH,MAAL,CAAYwE,KAAZ,GAAoB,EAAE,KAAKgE,QAA3B;AACD;AAED;;;;;;;;;AAOAhE,OAAK,GAAG;AACN,SAAK4D,WAAL,CAAiBxP,MAAjB,CAAwB,2CAAxB;;AACA,WAAO,KAAKoH,MAAL,CAAYwE,KAAZ,MAAuB,EAA9B;AACD;AAED;;;;;;;;;AAOAoE,OAAK,GAAG;AACN,SAAKR,WAAL,CAAiBxP,MAAjB,CAAwB,2CAAxB;;AACA,SAAK4P,QAAL,GAAgB,CAAhB;AACA,WAAO,KAAKhE,KAAL,GAAa,KAAKgE,QAAlB,CAAP;AACD;AAED;;;;;;;;;AAOAK,MAAI,GAAG;AACL,SAAKT,WAAL,CAAiBxP,MAAjB,CAAwB,0CAAxB;;AACA,SAAK4P,QAAL,GAAgB,KAAKnO,KAAL,KAAe,CAA/B;AACA,WAAO,KAAKmK,KAAL,GAAa,KAAKgE,QAAlB,CAAP;AACD;AAED;;;;;;;;;AAOAnO,OAAK,GAAG;AACN,SAAK+N,WAAL,CAAiBxP,MAAjB,CAAwB,2CAAxB;;AACA,WAAO,KAAKoH,MAAL,CAAY3F,KAAZ,EAAP;AACD;AAED;;;;;;;;;;AAQAJ,QAAM,CAACpF,QAAD,EAAW;AACf,SAAKuT,WAAL,CAAiBxP,MAAjB,CAAwB,4CAAxB;;AACA,SAAKwP,WAAL,CAAiBnO,MAAjB,CAAwB,KAAKsO,SAA7B,EAAwC1T,QAAxC;;AACA,WAAO,IAAP;AACD;AAED;;;;;;;;;;;AASAyP,SAAO,CAACzP,QAAD,EAAWiU,OAAO,GAAG,EAArB,EAAyB;AAC9B,SAAKV,WAAL,CAAiBxP,MAAjB,CAAwB,6CAAxB;;AACA,SAAKoH,MAAL,CAAYsE,OAAZ,CAAoBzP,QAApB,EAA8BiU,OAA9B;AACD;AAED;;;;;;;;;;AAQAC,MAAI,GAAG;AACL,WAAO,KAAKC,GAAL,CAAUpO,IAAD,IAAU;AACxB,aAAO,IAAIkM,UAAJ,CAAelM,IAAf,EAAqB,KAAKwN,WAA1B,CAAP;AACD,KAFM,CAAP;AAGD;AAED;;;;;;;;;;;AASAY,KAAG,CAACnU,QAAD,EAAWiU,OAAO,GAAG,EAArB,EAAyB;AAC1B,SAAKV,WAAL,CAAiBxP,MAAjB,CAAwB,yCAAxB;;AACA,WAAO,KAAKoH,MAAL,CAAYgJ,GAAZ,CAAgBnU,QAAhB,EAA0BiU,OAA1B,CAAP;AACD;AAED;;;;;;;;;AAOAG,SAAO,GAAG;AACR,SAAKb,WAAL,CAAiBxP,MAAjB,CAAwB,6CAAxB;;AACA,QAAI,KAAK4P,QAAL,GAAgB,CAApB,EAAuB;AACrB,WAAKA,QAAL,GAAgB,CAAhB;AACD;;AACD,WAAO,KAAKhE,KAAL,GAAa,KAAKgE,QAAlB,CAAP;AACD;AAED;;;;;;;;;;;AASA1O,SAAO,CAACoP,SAAD,EAAY;AACjB,SAAKd,WAAL,CAAiBxP,MAAjB,CAAwB,6CAAxB;;AACA,WAAO,KAAKoH,MAAL,CAAYlG,OAAZ,CAAoBoP,SAApB,CAAP;AACD;AAED;;;;;;;;;;;AASAC,gBAAc,CAACD,SAAD,EAAY;AACxB,SAAKd,WAAL,CAAiBxP,MAAjB,CAAwB,oDAAxB;;AACA,WAAO,KAAKoH,MAAL,CAAYmJ,cAAZ,CAA2BD,SAA3B,CAAP;AACD;;AAvNsB,C;;;;;;;;;;;ACtGzB9V,MAAM,CAACC,MAAP,CAAc;AAACc,cAAY,EAAC,MAAIA,YAAlB;AAA+BC,kBAAgB,EAAC,MAAIA,gBAApD;AAAqEwS,cAAY,EAAC,MAAIA,YAAtF;AAAmGvS,SAAO,EAAC,MAAIA;AAA/G,CAAd;AAAuI,IAAIL,KAAJ;AAAUZ,MAAM,CAACI,IAAP,CAAY,cAAZ,EAA2B;AAACQ,OAAK,CAACP,CAAD,EAAG;AAACO,SAAK,GAACP,CAAN;AAAQ;;AAAlB,CAA3B,EAA+C,CAA/C;AAEjJ,MAAMY,OAAO,GAAG;AACd+U,aAAW,CAACC,GAAD,EAAM;AACf,WAAOA,GAAG,KAAK,KAAK,CAApB;AACD,GAHa;;AAIdzR,UAAQ,CAACyR,GAAD,EAAM;AACZ,QAAI,KAAKC,OAAL,CAAaD,GAAb,KAAqB,KAAK5R,UAAL,CAAgB4R,GAAhB,CAAzB,EAA+C;AAC7C,aAAO,KAAP;AACD;;AACD,WAAOA,GAAG,KAAKjQ,MAAM,CAACiQ,GAAD,CAArB;AACD,GATa;;AAUdC,SAAO,CAACD,GAAD,EAAM;AACX,WAAOE,KAAK,CAACD,OAAN,CAAcD,GAAd,CAAP;AACD,GAZa;;AAadtS,WAAS,CAACsS,GAAD,EAAM;AACb,WAAOA,GAAG,KAAK,IAAR,IAAgBA,GAAG,KAAK,KAAxB,IAAiCjQ,MAAM,CAACoQ,SAAP,CAAiB/L,QAAjB,CAA0BjC,IAA1B,CAA+B6N,GAA/B,MAAwC,kBAAhF;AACD,GAfa;;AAgBd5R,YAAU,CAAC4R,GAAD,EAAM;AACd,WAAO,OAAOA,GAAP,KAAe,UAAf,IAA6B,KAApC;AACD,GAlBa;;AAmBdI,SAAO,CAACJ,GAAD,EAAM;AACX,QAAI,KAAKK,MAAL,CAAYL,GAAZ,CAAJ,EAAsB;AACpB,aAAO,KAAP;AACD;;AACD,QAAI,KAAKzR,QAAL,CAAcyR,GAAd,CAAJ,EAAwB;AACtB,aAAO,CAACjQ,MAAM,CAACuQ,IAAP,CAAYN,GAAZ,EAAiBtN,MAAzB;AACD;;AACD,QAAI,KAAKuN,OAAL,CAAaD,GAAb,KAAqB,KAAKnS,QAAL,CAAcmS,GAAd,CAAzB,EAA6C;AAC3C,aAAO,CAACA,GAAG,CAACtN,MAAZ;AACD;;AACD,WAAO,KAAP;AACD,GA9Ba;;AA+Bd6C,OAAK,CAACyK,GAAD,EAAM;AACT,QAAI,CAAC,KAAKzR,QAAL,CAAcyR,GAAd,CAAL,EAAyB,OAAOA,GAAP;AACzB,WAAO,KAAKC,OAAL,CAAaD,GAAb,IAAoBA,GAAG,CAAChH,KAAJ,EAApB,GAAkCjJ,MAAM,CAACqC,MAAP,CAAc,EAAd,EAAkB4N,GAAlB,CAAzC;AACD,GAlCa;;AAmCd3G,KAAG,CAACkH,IAAD,EAAOpP,IAAP,EAAa;AACd,QAAI6O,GAAG,GAAGO,IAAV;;AACA,QAAI,CAAC,KAAKhS,QAAL,CAAcyR,GAAd,CAAL,EAAyB;AACvB,aAAO,KAAP;AACD;;AACD,QAAI,CAAC,KAAKC,OAAL,CAAa9O,IAAb,CAAL,EAAyB;AACvB,aAAO,KAAK5C,QAAL,CAAcyR,GAAd,KAAsBjQ,MAAM,CAACoQ,SAAP,CAAiBK,cAAjB,CAAgCrO,IAAhC,CAAqC6N,GAArC,EAA0C7O,IAA1C,CAA7B;AACD;;AAED,UAAMuB,MAAM,GAAGvB,IAAI,CAACuB,MAApB;;AACA,SAAK,IAAI+N,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG/N,MAApB,EAA4B+N,CAAC,EAA7B,EAAiC;AAC/B,UAAI,CAAC1Q,MAAM,CAACoQ,SAAP,CAAiBK,cAAjB,CAAgCrO,IAAhC,CAAqC6N,GAArC,EAA0C7O,IAAI,CAACsP,CAAD,CAA9C,CAAL,EAAyD;AACvD,eAAO,KAAP;AACD;;AACDT,SAAG,GAAGA,GAAG,CAAC7O,IAAI,CAACsP,CAAD,CAAL,CAAT;AACD;;AACD,WAAO,CAAC,CAAC/N,MAAT;AACD,GApDa;;AAqDdiD,MAAI,CAACqK,GAAD,EAAM,GAAGM,IAAT,EAAe;AACjB,UAAMI,KAAK,GAAG3Q,MAAM,CAACqC,MAAP,CAAc,EAAd,EAAkB4N,GAAlB,CAAd;;AACA,SAAK,IAAIS,CAAC,GAAGH,IAAI,CAAC5N,MAAL,GAAc,CAA3B,EAA8B+N,CAAC,IAAI,CAAnC,EAAsCA,CAAC,EAAvC,EAA2C;AACzC,aAAOC,KAAK,CAACJ,IAAI,CAACG,CAAD,CAAL,CAAZ;AACD;;AAED,WAAOC,KAAP;AACD,GA5Da;;AA6DdC,KAAG,EAAEnL,IAAI,CAACmL,GA7DI;;AA8DdC,UAAQ,CAACC,IAAD,EAAOC,IAAP,EAAatC,OAAO,GAAG,EAAvB,EAA2B;AACjC,QAAIc,QAAQ,GAAG,CAAf;AACA,QAAIyB,OAAO,GAAG,IAAd;AACA,QAAIjP,MAAJ;AACA,UAAMkP,IAAI,GAAG,IAAb;AACA,QAAIvT,IAAJ;AACA,QAAIwT,IAAJ;;AAEA,UAAMC,KAAK,GAAG,MAAM;AAClB5B,cAAQ,GAAGd,OAAO,CAAC2C,OAAR,KAAoB,KAApB,GAA4B,CAA5B,GAAgCH,IAAI,CAACL,GAAL,EAA3C;AACAI,aAAO,GAAG,IAAV;AACAjP,YAAM,GAAG+O,IAAI,CAACzR,KAAL,CAAW3B,IAAX,EAAiBwT,IAAjB,CAAT;;AACA,UAAI,CAACF,OAAL,EAAc;AACZtT,YAAI,GAAGwT,IAAI,GAAG,IAAd;AACD;AACF,KAPD;;AASA,UAAMG,SAAS,GAAG,YAAY;AAC5B,YAAMT,GAAG,GAAGK,IAAI,CAACL,GAAL,EAAZ;AACA,UAAI,CAACrB,QAAD,IAAad,OAAO,CAAC2C,OAAR,KAAoB,KAArC,EAA4C7B,QAAQ,GAAGqB,GAAX;AAC5C,YAAMU,SAAS,GAAGP,IAAI,IAAIH,GAAG,GAAGrB,QAAV,CAAtB;AACA7R,UAAI,GAAG,IAAP;AACAwT,UAAI,GAAG5R,SAAP;;AACA,UAAIgS,SAAS,IAAI,CAAb,IAAkBA,SAAS,GAAGP,IAAlC,EAAwC;AACtC,YAAIC,OAAJ,EAAa;AACXO,sBAAY,CAACP,OAAD,CAAZ;AACAA,iBAAO,GAAG,IAAV;AACD;;AACDzB,gBAAQ,GAAGqB,GAAX;AACA7O,cAAM,GAAG+O,IAAI,CAACzR,KAAL,CAAW3B,IAAX,EAAiBwT,IAAjB,CAAT;;AACA,YAAI,CAACF,OAAL,EAAc;AACZtT,cAAI,GAAGwT,IAAI,GAAG,IAAd;AACD;AACF,OAVD,MAUO,IAAI,CAACF,OAAD,IAAYvC,OAAO,CAAC+C,QAAR,KAAqB,KAArC,EAA4C;AACjDR,eAAO,GAAGS,UAAU,CAACN,KAAD,EAAQG,SAAR,CAApB;AACD;;AACD,aAAOvP,MAAP;AACD,KApBD;;AAsBAsP,aAAS,CAACK,MAAV,GAAmB,MAAM;AACvBH,kBAAY,CAACP,OAAD,CAAZ;AACAzB,cAAQ,GAAG,CAAX;AACAyB,aAAO,GAAGtT,IAAI,GAAGwT,IAAI,GAAG,IAAxB;AACD,KAJD;;AAMA,WAAOG,SAAP;AACD;;AA5Ga,CAAhB;AA+GA,MAAMM,QAAQ,GAAG,CAAC,QAAD,EAAW,QAAX,EAAqB,MAArB,CAAjB;;AACA,KAAK,IAAIjB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGiB,QAAQ,CAAChP,MAA7B,EAAqC+N,CAAC,EAAtC,EAA0C;AACxCzV,SAAO,CAAC,OAAO0W,QAAQ,CAACjB,CAAD,CAAhB,CAAP,GAA8B,UAAUT,GAAV,EAAe;AAC3C,WAAOjQ,MAAM,CAACoQ,SAAP,CAAiB/L,QAAjB,CAA0BjC,IAA1B,CAA+B6N,GAA/B,MAAwC,aAAa0B,QAAQ,CAACjB,CAAD,CAArB,GAA2B,GAA1E;AACD,GAFD;AAGD;AAED;;;;;AAGA,MAAM3V,YAAY,GAAG,UAASkV,GAAT,EAAc;AACjC,OAAK,IAAI/C,GAAT,IAAgB+C,GAAhB,EAAqB;AACnB,QAAIhV,OAAO,CAAC6C,QAAR,CAAiBmS,GAAG,CAAC/C,GAAD,CAApB,KAA8B,CAAC,CAAC,CAAC+C,GAAG,CAAC/C,GAAD,CAAH,CAASpJ,OAAT,CAAiB,iBAAjB,CAArC,EAA0E;AACxEmM,SAAG,CAAC/C,GAAD,CAAH,GAAW+C,GAAG,CAAC/C,GAAD,CAAH,CAAS9O,OAAT,CAAiB,iBAAjB,EAAoC,EAApC,CAAX;AACA6R,SAAG,CAAC/C,GAAD,CAAH,GAAW,IAAIzH,IAAJ,CAASlH,QAAQ,CAAC0R,GAAG,CAAC/C,GAAD,CAAJ,CAAjB,CAAX;AACD,KAHD,MAGO,IAAIjS,OAAO,CAACuD,QAAR,CAAiByR,GAAG,CAAC/C,GAAD,CAApB,CAAJ,EAAgC;AACrC+C,SAAG,CAAC/C,GAAD,CAAH,GAAWnS,YAAY,CAACkV,GAAG,CAAC/C,GAAD,CAAJ,CAAvB;AACD,KAFM,MAEA,IAAIjS,OAAO,CAACiV,OAAR,CAAgBD,GAAG,CAAC/C,GAAD,CAAnB,CAAJ,EAA+B;AACpC,UAAI7S,CAAJ;;AACA,WAAK,IAAIqW,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGT,GAAG,CAAC/C,GAAD,CAAH,CAASvK,MAA7B,EAAqC+N,CAAC,EAAtC,EAA0C;AACxCrW,SAAC,GAAG4V,GAAG,CAAC/C,GAAD,CAAH,CAASwD,CAAT,CAAJ;;AACA,YAAIzV,OAAO,CAACuD,QAAR,CAAiBnE,CAAjB,CAAJ,EAAyB;AACvB4V,aAAG,CAAC/C,GAAD,CAAH,CAASwD,CAAT,IAAc3V,YAAY,CAACV,CAAD,CAA1B;AACD,SAFD,MAEO,IAAIY,OAAO,CAAC6C,QAAR,CAAiBzD,CAAjB,KAAuB,CAAC,CAAC,CAACA,CAAC,CAACyJ,OAAF,CAAU,iBAAV,CAA9B,EAA4D;AACjEzJ,WAAC,GAAGA,CAAC,CAAC+D,OAAF,CAAU,iBAAV,EAA6B,EAA7B,CAAJ;AACA6R,aAAG,CAAC/C,GAAD,CAAH,CAASwD,CAAT,IAAc,IAAIjL,IAAJ,CAASlH,QAAQ,CAAClE,CAAD,CAAjB,CAAd;AACD;AACF;AACF;AACF;;AACD,SAAO4V,GAAP;AACD,CArBD;AAuBA;;;;;AAGA,MAAMjV,gBAAgB,GAAG,UAASiV,GAAT,EAAc;AACrC,OAAK,IAAI/C,GAAT,IAAgB+C,GAAhB,EAAqB;AACnB,QAAIhV,OAAO,CAACqV,MAAR,CAAeL,GAAG,CAAC/C,GAAD,CAAlB,CAAJ,EAA8B;AAC5B+C,SAAG,CAAC/C,GAAD,CAAH,GAAY,kBAAiB,CAAC+C,GAAG,CAAC/C,GAAD,CAAM,EAAvC;AACD,KAFD,MAEO,IAAIjS,OAAO,CAACuD,QAAR,CAAiByR,GAAG,CAAC/C,GAAD,CAApB,CAAJ,EAAgC;AACrC+C,SAAG,CAAC/C,GAAD,CAAH,GAAWlS,gBAAgB,CAACiV,GAAG,CAAC/C,GAAD,CAAJ,CAA3B;AACD,KAFM,MAEA,IAAIjS,OAAO,CAACiV,OAAR,CAAgBD,GAAG,CAAC/C,GAAD,CAAnB,CAAJ,EAA+B;AACpC,UAAI7S,CAAJ;;AACA,WAAK,IAAIqW,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGT,GAAG,CAAC/C,GAAD,CAAH,CAASvK,MAA7B,EAAqC+N,CAAC,EAAtC,EAA0C;AACxCrW,SAAC,GAAG4V,GAAG,CAAC/C,GAAD,CAAH,CAASwD,CAAT,CAAJ;;AACA,YAAIzV,OAAO,CAACuD,QAAR,CAAiBnE,CAAjB,CAAJ,EAAyB;AACvB4V,aAAG,CAAC/C,GAAD,CAAH,CAASwD,CAAT,IAAc1V,gBAAgB,CAACX,CAAD,CAA9B;AACD,SAFD,MAEO,IAAIY,OAAO,CAACqV,MAAR,CAAejW,CAAf,CAAJ,EAAuB;AAC5B4V,aAAG,CAAC/C,GAAD,CAAH,CAASwD,CAAT,IAAe,kBAAiB,CAACrW,CAAE,EAAnC;AACD;AACF;AACF;AACF;;AACD,SAAO4V,GAAP;AACD,CAnBD;AAqBA;;;;;;;;;;;;AAUA,MAAMzC,YAAY,GAAG,CAAC7O,OAAD,EAAU0H,OAAO,GAAG,UAApB,EAAgCuL,QAAQ,GAAG,CAACC,yBAAyB,IAAI,EAA9B,EAAkCC,QAA7E,KAA0F;AAC7GlX,OAAK,CAAC+D,OAAD,EAAUqB,MAAV,CAAL;AACApF,OAAK,CAACyL,OAAD,EAAUnI,MAAV,CAAL;AACA,MAAIwQ,OAAO,GAAGkD,QAAd;;AAEA,MAAI,CAAC3W,OAAO,CAAC6C,QAAR,CAAiB4Q,OAAjB,CAAL,EAAgC;AAC9BA,WAAO,GAAG,CAACmD,yBAAyB,IAAI,EAA9B,EAAkCC,QAAlC,IAA8C,GAAxD;AACD;;AAED,QAAMC,KAAK,GAAGrD,OAAO,CAACtQ,OAAR,CAAgB,MAAhB,EAAwB,EAAxB,CAAd;;AACA,QAAMyN,IAAI,GAAIlN,OAAO,CAAC+L,QAAR,IAAoB/L,OAAO,CAAC+L,QAAR,CAAiBrE,OAAjB,CAArB,IAAmD1H,OAAnD,IAA8D,EAA3E;AAEA,MAAIiJ,GAAJ;;AACA,MAAI3M,OAAO,CAAC6C,QAAR,CAAiB+N,IAAI,CAACpE,SAAtB,CAAJ,EAAsC;AACpCG,OAAG,GAAI,IAAGiE,IAAI,CAACpE,SAAL,CAAerJ,OAAf,CAAuB,KAAvB,EAA8B,EAA9B,CAAkC,EAA5C;AACD,GAFD,MAEO;AACLwJ,OAAG,GAAG,EAAN;AACD;;AAED,MAAIjJ,OAAO,CAAC3C,MAAR,KAAmB,IAAvB,EAA6B;AAC3B,WAAO+V,KAAK,IAAI1L,OAAO,KAAK,UAAZ,GAA0B,GAAE1H,OAAO,CAAC4P,cAAe,IAAG5P,OAAO,CAAC6B,GAAI,GAAEoH,GAAI,EAAxE,GAA6E,GAAEjJ,OAAO,CAAC4P,cAAe,IAAGlI,OAAQ,IAAG1H,OAAO,CAAC6B,GAAI,GAAEoH,GAAI,EAA1I,CAAZ;AACD;;AACD,SAAOmK,KAAK,GAAI,GAAEpT,OAAO,CAAC4P,cAAe,IAAG5P,OAAO,CAAC6P,eAAgB,IAAG7P,OAAO,CAAC6B,GAAI,IAAG6F,OAAQ,IAAG1H,OAAO,CAAC6B,GAAI,GAAEoH,GAAI,EAAnH;AACD,CAvBD,C;;;;;;;;;;;ACpLA5N,MAAM,CAACC,MAAP,CAAc;AAACU,SAAO,EAAC,MAAID;AAAb,CAAd;AAAyC,IAAIQ,EAAJ;AAAOlB,MAAM,CAACI,IAAP,CAAY,UAAZ,EAAuB;AAACO,SAAO,CAACN,CAAD,EAAG;AAACa,MAAE,GAACb,CAAH;AAAK;;AAAjB,CAAvB,EAA0C,CAA1C;AAA6C,IAAIE,MAAJ;AAAWP,MAAM,CAACI,IAAP,CAAY,eAAZ,EAA4B;AAACG,QAAM,CAACF,CAAD,EAAG;AAACE,UAAM,GAACF,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAIY,OAAJ;AAAYjB,MAAM,CAACI,IAAP,CAAY,UAAZ,EAAuB;AAACa,SAAO,CAACZ,CAAD,EAAG;AAACY,WAAO,GAACZ,CAAR;AAAU;;AAAtB,CAAvB,EAA+C,CAA/C;;AAGzK,MAAMqB,IAAI,GAAG,MAAM,CAAE,CAArB;AAEA;;;;;;AAIA,MAAMH,KAAK,GAAKhB,MAAM,CAACiB,eAAP,CAAuBC,QAAQ,IAAIA,QAAQ,EAA3C,CAAhB;AACA,MAAMuW,OAAO,GAAG,EAAhB;AAEA;;;;;;;;;;AASe,MAAMtX,WAAN,CAAkB;AAC/BiB,aAAW,CAACyF,IAAD,EAAOsE,SAAP,EAAkBlE,IAAlB,EAAwBnF,WAAxB,EAAqC;AAC9C,SAAK+E,IAAL,GAAYA,IAAZ;AACA,SAAKsE,SAAL,GAAiBA,SAAjB;AACA,SAAKlE,IAAL,GAAYA,IAAZ;AACA,SAAKnF,WAAL,GAAmBA,WAAnB;;AACA,QAAI,CAAC,KAAK+E,IAAN,IAAc,CAACnG,OAAO,CAAC6C,QAAR,CAAiB,KAAKsD,IAAtB,CAAnB,EAAgD;AAC9C;AACD;;AAED,SAAKwH,EAAL,GAAqB,IAArB;AACA,SAAKqJ,aAAL,GAAqB,CAArB;AACA,SAAKvQ,KAAL,GAAqB,KAArB;AACA,SAAKD,OAAL,GAAqB,KAArB;;AAEA,QAAIuQ,OAAO,CAAC,KAAK5Q,IAAN,CAAP,IAAsB,CAAC4Q,OAAO,CAAC,KAAK5Q,IAAN,CAAP,CAAmBM,KAA1C,IAAmD,CAACsQ,OAAO,CAAC,KAAK5Q,IAAN,CAAP,CAAmBK,OAA3E,EAAoF;AAClF,WAAKmH,EAAL,GAAUoJ,OAAO,CAAC,KAAK5Q,IAAN,CAAP,CAAmBwH,EAA7B;AACA,WAAKqJ,aAAL,GAAqBD,OAAO,CAAC,KAAK5Q,IAAN,CAAP,CAAmB6Q,aAAxC;AACD,KAHD,MAGO;AACL/W,QAAE,CAACgX,UAAH,CAAc,KAAK9Q,IAAnB,EAA0B+Q,OAAD,IAAa;AACpC5W,aAAK,CAAC,MAAM;AACV,cAAI4W,OAAJ,EAAa;AACX,iBAAKjR,KAAL;AACA,kBAAM,IAAI3G,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAsB,2DAA2DgU,OAAjF,CAAN;AACD,WAHD,MAGO;AACLjX,cAAE,CAACkX,IAAH,CAAQ,KAAKhR,IAAb,EAAmB,IAAnB,EAAyB,KAAK/E,WAA9B,EAA2C,CAACgW,MAAD,EAASzJ,EAAT,KAAgB;AACzDrN,mBAAK,CAAC,MAAM;AACV,oBAAI8W,MAAJ,EAAY;AACV,uBAAKnR,KAAL;AACA,wBAAM,IAAI3G,MAAM,CAAC4D,KAAX,CAAiB,GAAjB,EAAsB,kEAAkEkU,MAAxF,CAAN;AACD,iBAHD,MAGO;AACL,uBAAKzJ,EAAL,GAAUA,EAAV;AACAoJ,yBAAO,CAAC,KAAK5Q,IAAN,CAAP,GAAqB,IAArB;AACD;AACF,eARI,CAAL;AASD,aAVD;AAWD;AACF,SAjBI,CAAL;AAkBD,OAnBD;AAoBD;AACF;AAED;;;;;;;;;;;AASAmH,OAAK,CAAC+J,GAAD,EAAMC,KAAN,EAAa9W,QAAb,EAAuB;AAC1B,QAAI,CAAC,KAAKgG,OAAN,IAAiB,CAAC,KAAKC,KAA3B,EAAkC;AAChC,UAAI,KAAKkH,EAAT,EAAa;AACX1N,UAAE,CAACqN,KAAH,CAAS,KAAKK,EAAd,EAAkB2J,KAAlB,EAAyB,CAAzB,EAA4BA,KAAK,CAAC5P,MAAlC,EAA0C,CAAC2P,GAAG,GAAG,CAAP,IAAY,KAAK9Q,IAAL,CAAUtF,SAAhE,EAA2E,CAACyD,KAAD,EAAQ6S,OAAR,EAAiB9I,MAAjB,KAA4B;AACrGnO,eAAK,CAAC,MAAM;AACVE,oBAAQ,IAAIA,QAAQ,CAACkE,KAAD,EAAQ6S,OAAR,EAAiB9I,MAAjB,CAApB;;AACA,gBAAI/J,KAAJ,EAAW;AACTuE,qBAAO,CAACC,IAAR,CAAa,kDAAb,EAAiExE,KAAjE;AACA,mBAAKuB,KAAL;AACD,aAHD,MAGO;AACL,gBAAE,KAAK+Q,aAAP;AACD;AACF,WARI,CAAL;AASD,SAVD;AAWD,OAZD,MAYO;AACL1X,cAAM,CAACkX,UAAP,CAAkB,MAAM;AACtB,eAAKlJ,KAAL,CAAW+J,GAAX,EAAgBC,KAAhB,EAAuB9W,QAAvB;AACD,SAFD,EAEG,EAFH;AAGD;AACF;;AACD,WAAO,KAAP;AACD;AAED;;;;;;;;;AAOAuF,KAAG,CAACvF,QAAD,EAAW;AACZ,QAAI,CAAC,KAAKgG,OAAN,IAAiB,CAAC,KAAKC,KAA3B,EAAkC;AAChC,UAAI,KAAKuQ,aAAL,KAAuB,KAAKvM,SAAhC,EAA2C;AACzCxK,UAAE,CAAC8N,KAAH,CAAS,KAAKJ,EAAd,EAAkB,MAAM;AACtBrN,eAAK,CAAC,MAAM;AACV,mBAAOyW,OAAO,CAAC,KAAK5Q,IAAN,CAAd;AACA,iBAAKM,KAAL,GAAa,IAAb;AACAjG,oBAAQ,IAAIA,QAAQ,CAAC,KAAK,CAAN,EAAS,IAAT,CAApB;AACD,WAJI,CAAL;AAKD,SAND;AAOA,eAAO,IAAP;AACD;;AAEDP,QAAE,CAACsP,IAAH,CAAQ,KAAKpJ,IAAb,EAAmB,CAACzB,KAAD,EAAQ6K,IAAR,KAAiB;AAClCjP,aAAK,CAAC,MAAM;AACV,cAAI,CAACoE,KAAD,IAAU6K,IAAd,EAAoB;AAClB,iBAAKyH,aAAL,GAAqBrU,IAAI,CAAC6U,IAAL,CAAUjI,IAAI,CAACxL,IAAL,GAAY,KAAKwC,IAAL,CAAUtF,SAAhC,CAArB;AACD;;AAED,iBAAO3B,MAAM,CAACkX,UAAP,CAAkB,MAAM;AAC7B,iBAAKzQ,GAAL,CAASvF,QAAT;AACD,WAFM,EAEJ,EAFI,CAAP;AAGD,SARI,CAAL;AASD,OAVD;AAWD,KAvBD,MAuBO;AACLA,cAAQ,IAAIA,QAAQ,CAAC,KAAK,CAAN,EAAS,KAAKiG,KAAd,CAApB;AACD;;AACD,WAAO,KAAP;AACD;AAED;;;;;;;;;AAOAR,OAAK,CAACzF,QAAD,EAAW;AACd,SAAKgG,OAAL,GAAe,IAAf;AACA,WAAOuQ,OAAO,CAAC,KAAK5Q,IAAN,CAAd;AACAlG,MAAE,CAACiM,MAAH,CAAU,KAAK/F,IAAf,EAAsB3F,QAAQ,IAAIC,IAAlC;AACA,WAAO,IAAP;AACD;AAED;;;;;;;;AAMAqF,MAAI,GAAG;AACL,SAAKU,OAAL,GAAe,IAAf;AACA,WAAOuQ,OAAO,CAAC,KAAK5Q,IAAN,CAAd;AACA,WAAO,IAAP;AACD;;AAvI8B,C","file":"/packages/ostrio_files.js","sourcesContent":["import { Mongo }           from 'meteor/mongo';\nimport { WebApp }          from 'meteor/webapp';\nimport { Meteor }          from 'meteor/meteor';\nimport { Random }          from 'meteor/random';\nimport { Cookies }         from 'meteor/ostrio:cookies';\nimport WriteStream         from './write-stream.js';\nimport { check, Match }    from 'meteor/check';\nimport FilesCollectionCore from './core.js';\nimport { fixJSONParse, fixJSONStringify, helpers } from './lib.js';\n\nimport fs       from 'fs-extra';\nimport nodeQs   from 'querystring';\nimport request  from 'request';\nimport fileType from 'file-type';\nimport nodePath from 'path';\n\n/*\n * @const {Object} bound  - Meteor.bindEnvironment (Fiber wrapper)\n * @const {Function} NOOP - No Operation function, placeholder for required callbacks\n */\nconst bound = Meteor.bindEnvironment(callback => callback());\nconst NOOP  = () => {  };\n\n/*\n * @locus Anywhere\n * @class FilesCollection\n * @param config           {Object}   - [Both]   Configuration object with next properties:\n * @param config.debug     {Boolean}  - [Both]   Turn on/of debugging and extra logging\n * @param config.schema    {Object}   - [Both]   Collection Schema\n * @param config.public    {Boolean}  - [Both]   Store files in folder accessible for proxy servers, for limits, and more - read docs\n * @param config.strict    {Boolean}  - [Server] Strict mode for partial content, if is `true` server will return `416` response code, when `range` is not specified, otherwise server return `206`\n * @param config.protected {Function} - [Server] If `true` - files will be served only to authorized users, if `function()` - you're able to check visitor's permissions in your own way function's context has:\n *  - `request`\n *  - `response`\n *  - `user()`\n *  - `userId`\n * @param config.chunkSize      {Number}  - [Both] Upload chunk size, default: 524288 bytes (0,5 Mb)\n * @param config.permissions    {Number}  - [Server] Permissions which will be set to uploaded files (octal), like: `511` or `0o755`. Default: 0644\n * @param config.parentDirPermissions {Number}  - [Server] Permissions which will be set to parent directory of uploaded files (octal), like: `611` or `0o777`. Default: 0755\n * @param config.storagePath    {String|Function}  - [Server] Storage path on file system\n * @param config.cacheControl   {String}  - [Server] Default `Cache-Control` header\n * @param config.responseHeaders {Object|Function} - [Server] Custom response headers, if function is passed, must return Object\n * @param config.throttle       {Number}  - [Server] DEPRECATED bps throttle threshold\n * @param config.downloadRoute  {String}  - [Both]   Server Route used to retrieve files\n * @param config.collection     {Mongo.Collection} - [Both] Mongo Collection Instance\n * @param config.collectionName {String}  - [Both]   Collection name\n * @param config.namingFunction {Function}- [Both]   Function which returns `String`\n * @param config.integrityCheck {Boolean} - [Server] Check file's integrity before serving to users\n * @param config.onAfterUpload  {Function}- [Server] Called right after file is ready on FS. Use to transfer file somewhere else, or do other thing with file directly\n * @param config.onAfterRemove  {Function} - [Server] Called right after file is removed. Removed objects is passed to callback\n * @param config.continueUploadTTL {Number} - [Server] Time in seconds, during upload may be continued, default 3 hours (10800 seconds)\n * @param config.onBeforeUpload {Function}- [Both]   Function which executes on server after receiving each chunk and on client right before beginning upload. Function context is `File` - so you are able to check for extension, mime-type, size and etc.:\n *  - return `true` to continue\n *  - return `false` or `String` to abort upload\n * @param config.onInitiateUpload {Function} - [Server] Function which executes on server right before upload is begin and right after `onBeforeUpload` hook. This hook is fully asynchronous.\n * @param config.onBeforeRemove {Function} - [Server] Executes before removing file on server, so you can check permissions. Return `true` to allow action and `false` to deny.\n * @param config.allowClientCode  {Boolean}  - [Both]   Allow to run `remove` from client\n * @param config.downloadCallback {Function} - [Server] Callback triggered each time file is requested, return truthy value to continue download, or falsy to abort\n * @param config.interceptDownload {Function} - [Server] Intercept download request, so you can serve file from third-party resource, arguments {http: {request: {...}, response: {...}}, fileRef: {...}}\n * @param config.disableUpload {Boolean} - Disable file upload, useful for server only solutions\n * @param config.disableDownload {Boolean} - Disable file download (serving), useful for file management only solutions\n * @param config._preCollection  {Mongo.Collection} - [Server] Mongo preCollection Instance\n * @param config._preCollectionName {String}  - [Server]  preCollection name\n * @summary Create new instance of FilesCollection\n */\nexport class FilesCollection extends FilesCollectionCore {\n  constructor(config) {\n    super();\n    let storagePath;\n    if (config) {\n      ({\n        storagePath,\n        debug: this.debug,\n        schema: this.schema,\n        public: this.public,\n        strict: this.strict,\n        chunkSize: this.chunkSize,\n        protected: this.protected,\n        collection: this.collection,\n        permissions: this.permissions,\n        cacheControl: this.cacheControl,\n        downloadRoute: this.downloadRoute,\n        onAfterUpload: this.onAfterUpload,\n        onAfterRemove: this.onAfterRemove,\n        disableUpload: this.disableUpload,\n        onBeforeRemove: this.onBeforeRemove,\n        integrityCheck: this.integrityCheck,\n        collectionName: this.collectionName,\n        onBeforeUpload: this.onBeforeUpload,\n        namingFunction: this.namingFunction,\n        responseHeaders: this.responseHeaders,\n        disableDownload: this.disableDownload,\n        allowClientCode: this.allowClientCode,\n        downloadCallback: this.downloadCallback,\n        onInitiateUpload: this.onInitiateUpload,\n        interceptDownload: this.interceptDownload,\n        continueUploadTTL: this.continueUploadTTL,\n        parentDirPermissions: this.parentDirPermissions,\n        _preCollection: this._preCollection,\n        _preCollectionName: this._preCollectionName,\n      } = config);\n    }\n\n    const self   = this;\n    new Cookies();\n\n    if (!helpers.isBoolean(this.debug)) {\n      this.debug = false;\n    }\n\n    if (!helpers.isBoolean(this.public)) {\n      this.public = false;\n    }\n\n    if (!this.protected) {\n      this.protected = false;\n    }\n\n    if (!this.chunkSize) {\n      this.chunkSize = 1024 * 512;\n    }\n\n    this.chunkSize = Math.floor(this.chunkSize / 8) * 8;\n\n    if (!helpers.isString(this.collectionName) && !this.collection) {\n      this.collectionName = 'MeteorUploadFiles';\n    }\n\n    if (!this.collection) {\n      this.collection = new Mongo.Collection(this.collectionName);\n    } else {\n      this.collectionName = this.collection._name;\n    }\n\n    this.collection.filesCollection = this;\n    check(this.collectionName, String);\n\n    if (this.public && !this.downloadRoute) {\n      throw new Meteor.Error(500, `[FilesCollection.${this.collectionName}]: \"downloadRoute\" must be precisely provided on \"public\" collections! Note: \"downloadRoute\" must be equal or be inside of your web/proxy-server (relative) root.`);\n    }\n\n    if (!helpers.isString(this.downloadRoute)) {\n      this.downloadRoute = '/cdn/storage';\n    }\n\n    this.downloadRoute = this.downloadRoute.replace(/\\/$/, '');\n\n    if (!helpers.isFunction(this.namingFunction)) {\n      this.namingFunction = false;\n    }\n\n    if (!helpers.isFunction(this.onBeforeUpload)) {\n      this.onBeforeUpload = false;\n    }\n\n    if (!helpers.isBoolean(this.allowClientCode)) {\n      this.allowClientCode = true;\n    }\n\n    if (!helpers.isFunction(this.onInitiateUpload)) {\n      this.onInitiateUpload = false;\n    }\n\n    if (!helpers.isFunction(this.interceptDownload)) {\n      this.interceptDownload = false;\n    }\n\n    if (!helpers.isBoolean(this.strict)) {\n      this.strict = true;\n    }\n\n    if (!helpers.isNumber(this.permissions)) {\n      this.permissions = parseInt('644', 8);\n    }\n\n    if (!helpers.isNumber(this.parentDirPermissions)) {\n      this.parentDirPermissions = parseInt('755', 8);\n    }\n\n    if (!helpers.isString(this.cacheControl)) {\n      this.cacheControl = 'public, max-age=31536000, s-maxage=31536000';\n    }\n\n    if (!helpers.isFunction(this.onAfterUpload)) {\n      this.onAfterUpload = false;\n    }\n\n    if (!helpers.isBoolean(this.disableUpload)) {\n      this.disableUpload = false;\n    }\n\n    if (!helpers.isFunction(this.onAfterRemove)) {\n      this.onAfterRemove = false;\n    }\n\n    if (!helpers.isFunction(this.onBeforeRemove)) {\n      this.onBeforeRemove = false;\n    }\n\n    if (!helpers.isBoolean(this.integrityCheck)) {\n      this.integrityCheck = true;\n    }\n\n    if (!helpers.isBoolean(this.disableDownload)) {\n      this.disableDownload = false;\n    }\n\n    if (!helpers.isObject(this._currentUploads)) {\n      this._currentUploads = {};\n    }\n\n    if (!helpers.isFunction(this.downloadCallback)) {\n      this.downloadCallback = false;\n    }\n\n    if (!helpers.isNumber(this.continueUploadTTL)) {\n      this.continueUploadTTL = 10800;\n    }\n\n    if (!helpers.isFunction(this.responseHeaders)) {\n      this.responseHeaders = (responseCode, fileRef, versionRef) => {\n        const headers = {};\n\n        switch (responseCode) {\n        case '206':\n          headers.Pragma               = 'private';\n          headers.Trailer              = 'expires';\n          headers['Transfer-Encoding'] = 'chunked';\n          break;\n        case '400':\n          headers['Cache-Control']     = 'no-cache';\n          break;\n        case '416':\n          headers['Content-Range']     = `bytes */${versionRef.size}`;\n          break;\n        default:\n          break;\n        }\n\n        headers.Connection       = 'keep-alive';\n        headers['Content-Type']  = versionRef.type || 'application/octet-stream';\n        headers['Accept-Ranges'] = 'bytes';\n        return headers;\n      };\n    }\n\n    if (this.public && !storagePath) {\n      throw new Meteor.Error(500, `[FilesCollection.${this.collectionName}] \"storagePath\" must be set on \"public\" collections! Note: \"storagePath\" must be equal on be inside of your web/proxy-server (absolute) root.`);\n    }\n\n    if (!storagePath) {\n      storagePath = function () {\n        return `assets${nodePath.sep}app${nodePath.sep}uploads${nodePath.sep}${self.collectionName}`;\n      };\n    }\n\n    if (helpers.isString(storagePath)) {\n      this.storagePath = () => storagePath;\n    } else {\n      this.storagePath = function () {\n        let sp = storagePath.apply(self, arguments);\n        if (!helpers.isString(sp)) {\n          throw new Meteor.Error(400, `[FilesCollection.${self.collectionName}] \"storagePath\" function must return a String!`);\n        }\n        sp = sp.replace(/\\/$/, '');\n        return nodePath.normalize(sp);\n      };\n    }\n\n    this._debug('[FilesCollection.storagePath] Set to:', this.storagePath({}));\n\n    fs.mkdirs(this.storagePath({}), { mode: this.parentDirPermissions }, (error) => {\n      if (error) {\n        throw new Meteor.Error(401, `[FilesCollection.${self.collectionName}] Path \"${this.storagePath({})}\" is not writable! ${error}`);\n      }\n    });\n\n    check(this.strict, Boolean);\n    check(this.permissions, Number);\n    check(this.storagePath, Function);\n    check(this.cacheControl, String);\n    check(this.onAfterRemove, Match.OneOf(false, Function));\n    check(this.onAfterUpload, Match.OneOf(false, Function));\n    check(this.disableUpload, Boolean);\n    check(this.integrityCheck, Boolean);\n    check(this.onBeforeRemove, Match.OneOf(false, Function));\n    check(this.disableDownload, Boolean);\n    check(this.downloadCallback, Match.OneOf(false, Function));\n    check(this.interceptDownload, Match.OneOf(false, Function));\n    check(this.continueUploadTTL, Number);\n    check(this.responseHeaders, Match.OneOf(Object, Function));\n\n    if (!this.disableUpload) {\n      if (!helpers.isString(this._preCollectionName) && !this._preCollection) {\n        this._preCollectionName = `__pre_${this.collectionName}`;\n      }\n\n      if (!this._preCollection) {\n        this._preCollection = new Mongo.Collection(this._preCollectionName);\n      } else {\n        this._preCollectionName = this._preCollection._name;\n      }\n      check(this._preCollectionName, String);\n\n      this._preCollection._ensureIndex({ createdAt: 1 }, { expireAfterSeconds: this.continueUploadTTL, background: true });\n      const _preCollectionCursor = this._preCollection.find({}, {\n        fields: {\n          _id: 1,\n          isFinished: 1\n        }\n      });\n\n      _preCollectionCursor.observe({\n        changed(doc) {\n          if (doc.isFinished) {\n            self._debug(`[FilesCollection] [_preCollectionCursor.observe] [changed]: ${doc._id}`);\n            self._preCollection.remove({_id: doc._id}, NOOP);\n          }\n        },\n        removed(doc) {\n          // Free memory after upload is done\n          // Or if upload is unfinished\n          self._debug(`[FilesCollection] [_preCollectionCursor.observe] [removed]: ${doc._id}`);\n          if (helpers.isObject(self._currentUploads[doc._id])) {\n            self._currentUploads[doc._id].stop();\n            self._currentUploads[doc._id].end();\n\n            // We can be unlucky to run into a race condition where another server removed this document before the change of `isFinished` is registered on this server.\n            // Therefore it's better to double-check with the main collection if the file is referenced there. Issue: https://github.com/VeliovGroup/Meteor-Files/issues/672\n            if (!doc.isFinished && self.collection.find({ _id: doc._id }).count() === 0) {\n              self._debug(`[FilesCollection] [_preCollectionCursor.observe] [removeUnfinishedUpload]: ${doc._id}`);\n              self._currentUploads[doc._id].abort();\n            }\n\n            delete self._currentUploads[doc._id];\n          }\n        }\n      });\n\n      this._createStream = (_id, path, opts) => {\n        this._currentUploads[_id] = new WriteStream(path, opts.fileLength, opts, this.permissions);\n      };\n\n      // This little function allows to continue upload\n      // even after server is restarted (*not on dev-stage*)\n      this._continueUpload = (_id) => {\n        if (this._currentUploads[_id] && this._currentUploads[_id].file) {\n          if (!this._currentUploads[_id].aborted && !this._currentUploads[_id].ended) {\n            return this._currentUploads[_id].file;\n          }\n          this._createStream(_id, this._currentUploads[_id].file.file.path, this._currentUploads[_id].file);\n          return this._currentUploads[_id].file;\n        }\n        const contUpld = this._preCollection.findOne({_id});\n        if (contUpld) {\n          this._createStream(_id, contUpld.file.path, contUpld);\n          return this._currentUploads[_id].file;\n        }\n        return false;\n      };\n    }\n\n    if (!this.schema) {\n      this.schema = FilesCollectionCore.schema;\n    }\n\n    check(this.debug, Boolean);\n    check(this.schema, Object);\n    check(this.public, Boolean);\n    check(this.protected, Match.OneOf(Boolean, Function));\n    check(this.chunkSize, Number);\n    check(this.downloadRoute, String);\n    check(this.namingFunction, Match.OneOf(false, Function));\n    check(this.onBeforeUpload, Match.OneOf(false, Function));\n    check(this.onInitiateUpload, Match.OneOf(false, Function));\n    check(this.allowClientCode, Boolean);\n\n    if (this.public && this.protected) {\n      throw new Meteor.Error(500, `[FilesCollection.${this.collectionName}]: Files can not be public and protected at the same time!`);\n    }\n\n    this._checkAccess = (http) => {\n      if (this.protected) {\n        let result;\n        const {user, userId} = this._getUser(http);\n\n        if (helpers.isFunction(this.protected)) {\n          let fileRef;\n          if (helpers.isObject(http.params) &&  http.params._id) {\n            fileRef = this.collection.findOne(http.params._id);\n          }\n\n          result = http ? this.protected.call(Object.assign(http, {user, userId}), (fileRef || null)) : this.protected.call({user, userId}, (fileRef || null));\n        } else {\n          result = !!userId;\n        }\n\n        if ((http && (result === true)) || !http) {\n          return true;\n        }\n\n        const rc = helpers.isNumber(result) ? result : 401;\n        this._debug('[FilesCollection._checkAccess] WARN: Access denied!');\n        if (http) {\n          const text = 'Access denied!';\n          if (!http.response.headersSent) {\n            http.response.writeHead(rc, {\n              'Content-Type': 'text/plain',\n              'Content-Length': text.length\n            });\n          }\n\n          if (!http.response.finished) {\n            http.response.end(text);\n          }\n        }\n\n        return false;\n      }\n      return true;\n    };\n\n    this._methodNames = {\n      _Abort: `_FilesCollectionAbort_${this.collectionName}`,\n      _Write: `_FilesCollectionWrite_${this.collectionName}`,\n      _Start: `_FilesCollectionStart_${this.collectionName}`,\n      _Remove: `_FilesCollectionRemove_${this.collectionName}`\n    };\n\n    this.on('_handleUpload', this._handleUpload);\n    this.on('_finishUpload', this._finishUpload);\n    this._handleUploadSync = Meteor.wrapAsync(this._handleUpload.bind(this));\n\n    if (this.disableUpload && this.disableDownload) {\n      return;\n    }\n    WebApp.connectHandlers.use((httpReq, httpResp, next) => {\n      if (!this.disableUpload && !!~httpReq._parsedUrl.path.indexOf(`${this.downloadRoute}/${this.collectionName}/__upload`)) {\n        if (httpReq.method === 'POST') {\n          const handleError = (_error) => {\n            let error = _error;\n            console.warn('[FilesCollection] [Upload] [HTTP] Exception:', error);\n            console.trace();\n\n            if (!httpResp.headersSent) {\n              httpResp.writeHead(500);\n            }\n\n            if (!httpResp.finished) {\n              if (helpers.isObject(error) && helpers.isFunction(error.toString)) {\n                error = error.toString();\n              }\n\n              if (!helpers.isString(error)) {\n                error = 'Unexpected error!';\n              }\n\n              httpResp.end(JSON.stringify({ error }));\n            }\n          };\n\n          let body = '';\n          httpReq.on('data', (data) => bound(() => {\n            body += data;\n          }));\n\n          httpReq.on('end', () => bound(() => {\n            try {\n              let opts;\n              let result;\n              let user;\n\n              if (httpReq.headers['x-mtok'] && this._getUserId(httpReq.headers['x-mtok'])) {\n                user = {\n                  userId: this._getUserId(httpReq.headers['x-mtok'])\n                };\n              } else {\n                user = this._getUser({request: httpReq, response: httpResp});\n              }\n\n              if (httpReq.headers['x-start'] !== '1') {\n                opts = {\n                  fileId: httpReq.headers['x-fileid']\n                };\n\n                if (httpReq.headers['x-eof'] === '1') {\n                  opts.eof = true;\n                } else {\n                  opts.binData = Buffer.from(body, 'base64');\n                  opts.chunkId = parseInt(httpReq.headers['x-chunkid']);\n                }\n\n                const _continueUpload = this._continueUpload(opts.fileId);\n                if (!_continueUpload) {\n                  throw new Meteor.Error(408, 'Can\\'t continue upload, session expired. Start upload again.');\n                }\n\n                ({result, opts}  = this._prepareUpload(Object.assign(opts, _continueUpload), user.userId, 'HTTP'));\n\n                if (opts.eof) {\n                  this._handleUpload(result, opts, (_error) => {\n                    let error = _error;\n                    if (error) {\n                      if (!httpResp.headersSent) {\n                        httpResp.writeHead(500);\n                      }\n\n                      if (!httpResp.finished) {\n                        if (helpers.isObject(error) && helpers.isFunction(error.toString)) {\n                          error = error.toString();\n                        }\n\n                        if (!helpers.isString(error)) {\n                          error = 'Unexpected error!';\n                        }\n\n                        httpResp.end(JSON.stringify({ error }));\n                      }\n                    }\n\n                    if (!httpResp.headersSent) {\n                      httpResp.writeHead(200);\n                    }\n\n                    if (helpers.isObject(result.file) && result.file.meta) {\n                      result.file.meta = fixJSONStringify(result.file.meta);\n                    }\n\n                    if (!httpResp.finished) {\n                      httpResp.end(JSON.stringify(result));\n                    }\n                  });\n                  return;\n                }\n\n                this.emit('_handleUpload', result, opts, NOOP);\n\n                if (!httpResp.headersSent) {\n                  httpResp.writeHead(204);\n                }\n                if (!httpResp.finished) {\n                  httpResp.end();\n                }\n              } else {\n                try {\n                  opts = JSON.parse(body);\n                } catch (jsonErr) {\n                  console.error('Can\\'t parse incoming JSON from Client on [.insert() | upload], something went wrong!', jsonErr);\n                  opts = {file: {}};\n                }\n\n                if (!helpers.isObject(opts.file)) {\n                  opts.file = {};\n                }\n\n                opts.___s = true;\n                this._debug(`[FilesCollection] [File Start HTTP] ${opts.file.name || '[no-name]'} - ${opts.fileId}`);\n                if (helpers.isObject(opts.file) && opts.file.meta) {\n                  opts.file.meta = fixJSONParse(opts.file.meta);\n                }\n\n                ({result} = this._prepareUpload(helpers.clone(opts), user.userId, 'HTTP Start Method'));\n\n                if (this.collection.findOne(result._id)) {\n                  throw new Meteor.Error(400, 'Can\\'t start upload, data substitution detected!');\n                }\n\n                opts._id       = opts.fileId;\n                opts.createdAt = new Date();\n                opts.maxLength = opts.fileLength;\n                this._preCollection.insert(helpers.omit(opts, '___s'));\n                this._createStream(result._id, result.path, helpers.omit(opts, '___s'));\n\n                if (opts.returnMeta) {\n                  if (!httpResp.headersSent) {\n                    httpResp.writeHead(200);\n                  }\n\n                  if (!httpResp.finished) {\n                    httpResp.end(JSON.stringify({\n                      uploadRoute: `${this.downloadRoute}/${this.collectionName}/__upload`,\n                      file: result\n                    }));\n                  }\n                } else {\n                  if (!httpResp.headersSent) {\n                    httpResp.writeHead(204);\n                  }\n\n                  if (!httpResp.finished) {\n                    httpResp.end();\n                  }\n                }\n              }\n            } catch (httpRespErr) {\n              handleError(httpRespErr);\n            }\n          }));\n        } else {\n          next();\n        }\n        return;\n      }\n\n      if (!this.disableDownload) {\n        let http;\n        let params;\n        let uri;\n        let uris;\n\n        if (!this.public) {\n          if (!!~httpReq._parsedUrl.path.indexOf(`${this.downloadRoute}/${this.collectionName}`)) {\n            uri = httpReq._parsedUrl.path.replace(`${this.downloadRoute}/${this.collectionName}`, '');\n            if (uri.indexOf('/') === 0) {\n              uri = uri.substring(1);\n            }\n\n            uris = uri.split('/');\n            if (uris.length === 3) {\n              params = {\n                _id: uris[0],\n                query: httpReq._parsedUrl.query ? nodeQs.parse(httpReq._parsedUrl.query) : {},\n                name: uris[2].split('?')[0],\n                version: uris[1]\n              };\n\n              http = {request: httpReq, response: httpResp, params};\n              if (this._checkAccess(http)) {\n                this.download(http, uris[1], this.collection.findOne(uris[0]));\n              }\n            } else {\n              next();\n            }\n          } else {\n            next();\n          }\n        } else {\n          if (!!~httpReq._parsedUrl.path.indexOf(`${this.downloadRoute}`)) {\n            uri = httpReq._parsedUrl.path.replace(`${this.downloadRoute}`, '');\n            if (uri.indexOf('/') === 0) {\n              uri = uri.substring(1);\n            }\n\n            uris  = uri.split('/');\n            let _file = uris[uris.length - 1];\n            if (_file) {\n              let version;\n              if (!!~_file.indexOf('-')) {\n                version = _file.split('-')[0];\n                _file   = _file.split('-')[1].split('?')[0];\n              } else {\n                version = 'original';\n                _file   = _file.split('?')[0];\n              }\n\n              params = {\n                query: httpReq._parsedUrl.query ? nodeQs.parse(httpReq._parsedUrl.query) : {},\n                file: _file,\n                _id: _file.split('.')[0],\n                version,\n                name: _file\n              };\n              http = {request: httpReq, response: httpResp, params};\n              this.download(http, version, this.collection.findOne(params._id));\n            } else {\n              next();\n            }\n          } else {\n            next();\n          }\n        }\n        return;\n      }\n      next();\n    });\n\n    if (!this.disableUpload) {\n      const _methods = {};\n\n      // Method used to remove file\n      // from Client side\n      _methods[this._methodNames._Remove] = function (selector) {\n        check(selector, Match.OneOf(String, Object));\n        self._debug(`[FilesCollection] [Unlink Method] [.remove(${selector})]`);\n\n        if (self.allowClientCode) {\n          if (self.onBeforeRemove && helpers.isFunction(self.onBeforeRemove)) {\n            const userId = this.userId;\n            const userFuncs = {\n              userId: this.userId,\n              user() {\n                if (Meteor.users) {\n                  return Meteor.users.findOne(userId);\n                }\n                return null;\n              }\n            };\n\n            if (!self.onBeforeRemove.call(userFuncs, (self.find(selector) || null))) {\n              throw new Meteor.Error(403, '[FilesCollection] [remove] Not permitted!');\n            }\n          }\n\n          const cursor = self.find(selector);\n          if (cursor.count() > 0) {\n            self.remove(selector);\n            return true;\n          }\n          throw new Meteor.Error(404, 'Cursor is empty, no files is removed');\n        } else {\n          throw new Meteor.Error(401, '[FilesCollection] [remove] Run code from client is not allowed!');\n        }\n      };\n\n\n      // Method used to receive \"first byte\" of upload\n      // and all file's meta-data, so\n      // it won't be transferred with every chunk\n      // Basically it prepares everything\n      // So user can pause/disconnect and\n      // continue upload later, during `continueUploadTTL`\n      _methods[this._methodNames._Start] = function (opts, returnMeta) {\n        check(opts, {\n          file: Object,\n          fileId: String,\n          FSName: Match.Optional(String),\n          chunkSize: Number,\n          fileLength: Number\n        });\n\n        check(returnMeta, Match.Optional(Boolean));\n\n        self._debug(`[FilesCollection] [File Start Method] ${opts.file.name} - ${opts.fileId}`);\n        opts.___s = true;\n        const { result } = self._prepareUpload(helpers.clone(opts), this.userId, 'DDP Start Method');\n\n        if (self.collection.findOne(result._id)) {\n          throw new Meteor.Error(400, 'Can\\'t start upload, data substitution detected!');\n        }\n\n        opts._id       = opts.fileId;\n        opts.createdAt = new Date();\n        opts.maxLength = opts.fileLength;\n        try {\n          self._preCollection.insert(helpers.omit(opts, '___s'));\n          self._createStream(result._id, result.path, helpers.omit(opts, '___s'));\n        } catch (e) {\n          self._debug(`[FilesCollection] [File Start Method] [EXCEPTION:] ${opts.file.name} - ${opts.fileId}`, e);\n          throw new Meteor.Error(500, 'Can\\'t start');\n        }\n\n        if (returnMeta) {\n          return {\n            uploadRoute: `${self.downloadRoute}/${self.collectionName}/__upload`,\n            file: result\n          };\n        }\n        return true;\n      };\n\n\n      // Method used to write file chunks\n      // it receives very limited amount of meta-data\n      // This method also responsible for EOF\n      _methods[this._methodNames._Write] = function (_opts) {\n        let opts = _opts;\n        let result;\n        check(opts, {\n          eof: Match.Optional(Boolean),\n          fileId: String,\n          binData: Match.Optional(String),\n          chunkId: Match.Optional(Number)\n        });\n\n        if (opts.binData) {\n          opts.binData = Buffer.from(opts.binData, 'base64');\n        }\n\n        const _continueUpload = self._continueUpload(opts.fileId);\n        if (!_continueUpload) {\n          throw new Meteor.Error(408, 'Can\\'t continue upload, session expired. Start upload again.');\n        }\n\n        this.unblock();\n        ({result, opts} = self._prepareUpload(Object.assign(opts, _continueUpload), this.userId, 'DDP'));\n\n        if (opts.eof) {\n          try {\n            return self._handleUploadSync(result, opts);\n          } catch (handleUploadErr) {\n            self._debug('[FilesCollection] [Write Method] [DDP] Exception:', handleUploadErr);\n            throw handleUploadErr;\n          }\n        } else {\n          self.emit('_handleUpload', result, opts, NOOP);\n        }\n        return true;\n      };\n\n      // Method used to Abort upload\n      // - Feeing memory by .end()ing writableStreams\n      // - Removing temporary record from @_preCollection\n      // - Removing record from @collection\n      // - .unlink()ing chunks from FS\n      _methods[this._methodNames._Abort] = function (_id) {\n        check(_id, String);\n\n        const _continueUpload = self._continueUpload(_id);\n        self._debug(`[FilesCollection] [Abort Method]: ${_id} - ${(helpers.isObject(_continueUpload.file) ? _continueUpload.file.path : '')}`);\n\n        if (self._currentUploads && self._currentUploads[_id]) {\n          self._currentUploads[_id].stop();\n          self._currentUploads[_id].abort();\n        }\n\n        if (_continueUpload) {\n          self._preCollection.remove({_id});\n          self.remove({_id});\n          if (helpers.isObject(_continueUpload.file) && _continueUpload.file.path) {\n            self.unlink({_id, path: _continueUpload.file.path});\n          }\n        }\n        return true;\n      };\n\n      Meteor.methods(_methods);\n    }\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name _prepareUpload\n   * @summary Internal method. Used to optimize received data and check upload permission\n   * @returns {Object}\n   */\n  _prepareUpload(opts = {}, userId, transport) {\n    let ctx;\n    if (!helpers.isBoolean(opts.eof)) {\n      opts.eof = false;\n    }\n\n    if (!opts.binData) {\n      opts.binData = 'EOF';\n    }\n\n    if (!helpers.isNumber(opts.chunkId)) {\n      opts.chunkId = -1;\n    }\n\n    if (!helpers.isString(opts.FSName)) {\n      opts.FSName = opts.fileId;\n    }\n\n    this._debug(`[FilesCollection] [Upload] [${transport}] Got #${opts.chunkId}/${opts.fileLength} chunks, dst: ${opts.file.name || opts.file.fileName}`);\n\n    const fileName = this._getFileName(opts.file);\n    const {extension, extensionWithDot} = this._getExt(fileName);\n\n    if (!helpers.isObject(opts.file.meta)) {\n      opts.file.meta = {};\n    }\n\n    let result       = opts.file;\n    result.name      = fileName;\n    result.meta      = opts.file.meta;\n    result.extension = extension;\n    result.ext       = extension;\n    result._id       = opts.fileId;\n    result.userId    = userId || null;\n    opts.FSName      = opts.FSName.replace(/([^a-z0-9\\-\\_]+)/gi, '-');\n    result.path      = `${this.storagePath(result)}${nodePath.sep}${opts.FSName}${extensionWithDot}`;\n    result           = Object.assign(result, this._dataToSchema(result));\n\n    if (this.onBeforeUpload && helpers.isFunction(this.onBeforeUpload)) {\n      ctx = Object.assign({\n        file: opts.file\n      }, {\n        chunkId: opts.chunkId,\n        userId: result.userId,\n        user() {\n          if (Meteor.users && result.userId) {\n            return Meteor.users.findOne(result.userId);\n          }\n          return null;\n        },\n        eof: opts.eof\n      });\n      const isUploadAllowed = this.onBeforeUpload.call(ctx, result);\n\n      if (isUploadAllowed !== true) {\n        throw new Meteor.Error(403, helpers.isString(isUploadAllowed) ? isUploadAllowed : '@onBeforeUpload() returned false');\n      } else {\n        if ((opts.___s === true) && this.onInitiateUpload && helpers.isFunction(this.onInitiateUpload)) {\n          this.onInitiateUpload.call(ctx, result);\n        }\n      }\n    } else if ((opts.___s === true) && this.onInitiateUpload && helpers.isFunction(this.onInitiateUpload)) {\n      ctx = Object.assign({\n        file: opts.file\n      }, {\n        chunkId: opts.chunkId,\n        userId: result.userId,\n        user() {\n          if (Meteor.users && result.userId) {\n            return Meteor.users.findOne(result.userId);\n          }\n          return null;\n        },\n        eof: opts.eof\n      });\n      this.onInitiateUpload.call(ctx, result);\n    }\n\n    return {result, opts};\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name _finishUpload\n   * @summary Internal method. Finish upload, close Writable stream, add record to MongoDB and flush used memory\n   * @returns {undefined}\n   */\n  _finishUpload(result, opts, cb) {\n    this._debug(`[FilesCollection] [Upload] [finish(ing)Upload] -> ${result.path}`);\n    fs.chmod(result.path, this.permissions, NOOP);\n    result.type   = this._getMimeType(opts.file);\n    result.public = this.public;\n    this._updateFileTypes(result);\n\n    this.collection.insert(helpers.clone(result), (colInsert, _id) => {\n      if (colInsert) {\n        cb && cb(colInsert);\n        this._debug('[FilesCollection] [Upload] [_finishUpload] [insert] Error:', colInsert);\n      } else {\n        this._preCollection.update({_id: opts.fileId}, {$set: {isFinished: true}}, (preUpdateError) => {\n          if (preUpdateError) {\n            cb && cb(preUpdateError);\n            this._debug('[FilesCollection] [Upload] [_finishUpload] [update] Error:', preUpdateError);\n          } else {\n            result._id = _id;\n            this._debug(`[FilesCollection] [Upload] [finish(ed)Upload] -> ${result.path}`);\n            this.onAfterUpload && this.onAfterUpload.call(this, result);\n            this.emit('afterUpload', result);\n            cb && cb(null, result);\n          }\n        });\n      }\n    });\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name _handleUpload\n   * @summary Internal method to handle upload process, pipe incoming data to Writable stream\n   * @returns {undefined}\n   */\n  _handleUpload(result, opts, cb) {\n    try {\n      if (opts.eof) {\n        this._currentUploads[result._id].end(() => {\n          this.emit('_finishUpload', result, opts, cb);\n        });\n      } else {\n        this._currentUploads[result._id].write(opts.chunkId, opts.binData, cb);\n      }\n    } catch (e) {\n      this._debug('[_handleUpload] [EXCEPTION:]', e);\n      cb && cb(e);\n    }\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollection\n   * @name _getMimeType\n   * @param {Object} fileData - File Object\n   * @summary Returns file's mime-type\n   * @returns {String}\n   */\n  _getMimeType(fileData) {\n    let mime;\n    check(fileData, Object);\n    if (helpers.isObject(fileData) && fileData.type) {\n      mime = fileData.type;\n    }\n\n    if (fileData.path && (!mime || !helpers.isString(mime))) {\n      try {\n        let buf  = Buffer.alloc(262);\n        const fd = fs.openSync(fileData.path, 'r');\n        const br = fs.readSync(fd, buf, 0, 262, 0);\n        fs.close(fd, NOOP);\n        if (br < 262) {\n          buf = buf.slice(0, br);\n        }\n        ({mime} = fileType(buf));\n      } catch (e) {\n        // We're good\n      }\n    }\n\n    if (!mime || !helpers.isString(mime)) {\n      mime = 'application/octet-stream';\n    }\n    return mime;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollection\n   * @name _getUserId\n   * @summary Returns `userId` matching the xmtok token derived from Meteor.server.sessions\n   * @returns {String}\n   */\n  _getUserId(xmtok) {\n    if (!xmtok) return null;\n\n    // throw an error upon an unexpected type of Meteor.server.sessions in order to identify breaking changes\n    if (!Meteor.server.sessions instanceof Map || !helpers.isObject(Meteor.server.sessions)) {\n      throw new Error('Received incompatible type of Meteor.server.sessions');\n    }\n\n    if (Meteor.server.sessions instanceof Map && Meteor.server.sessions.has(xmtok) && helpers.isObject(Meteor.server.sessions.get(xmtok))) {\n      // to be used with >= Meteor 1.8.1 where Meteor.server.sessions is a Map\n      return Meteor.server.sessions.get(xmtok).userId;\n    } else if (helpers.isObject(Meteor.server.sessions) && xmtok in Meteor.server.sessions && helpers.isObject(Meteor.server.sessions[xmtok])) {\n      // to be used with < Meteor 1.8.1 where Meteor.server.sessions is an Object\n      return Meteor.server.sessions[xmtok].userId;\n    }\n\n    return null;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollection\n   * @name _getUser\n   * @summary Returns object with `userId` and `user()` method which return user's object\n   * @returns {Object}\n   */\n  _getUser(http) {\n    const result = {\n      user() { return null; },\n      userId: null\n    };\n\n    if (http) {\n      let mtok = null;\n      if (http.request.headers['x-mtok']) {\n        mtok = http.request.headers['x-mtok'];\n      } else {\n        const cookie = http.request.Cookies;\n        if (cookie.has('x_mtok')) {\n          mtok = cookie.get('x_mtok');\n        }\n      }\n\n      if (mtok) {\n        const userId = this._getUserId(mtok);\n\n        if (userId) {\n          result.user   = () => Meteor.users.findOne(userId);\n          result.userId = userId;\n        }\n      }\n    }\n\n    return result;\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name write\n   * @param {Buffer} buffer - Binary File's Buffer\n   * @param {Object} opts - Object with file-data\n   * @param {String} opts.name - File name, alias: `fileName`\n   * @param {String} opts.type - File mime-type\n   * @param {Object} opts.meta - File additional meta-data\n   * @param {String} opts.userId - UserId, default *null*\n   * @param {String} opts.fileId - _id, default *null*\n   * @param {Function} callback - function(error, fileObj){...}\n   * @param {Boolean} proceedAfterUpload - Proceed onAfterUpload hook\n   * @summary Write buffer to FS and add to FilesCollection Collection\n   * @returns {FilesCollection} Instance\n   */\n  write(buffer, _opts = {}, _callback, _proceedAfterUpload) {\n    this._debug('[FilesCollection] [write()]');\n    let opts = _opts;\n    let callback = _callback;\n    let proceedAfterUpload = _proceedAfterUpload;\n\n    if (helpers.isFunction(opts)) {\n      proceedAfterUpload = callback;\n      callback = opts;\n      opts     = {};\n    } else if (helpers.isBoolean(callback)) {\n      proceedAfterUpload = callback;\n    } else if (helpers.isBoolean(opts)) {\n      proceedAfterUpload = opts;\n    }\n\n    check(opts, Match.Optional(Object));\n    check(callback, Match.Optional(Function));\n    check(proceedAfterUpload, Match.Optional(Boolean));\n\n    const fileId   = opts.fileId || Random.id();\n    const FSName   = this.namingFunction ? this.namingFunction(opts) : fileId;\n    const fileName = (opts.name || opts.fileName) ? (opts.name || opts.fileName) : FSName;\n\n    const {extension, extensionWithDot} = this._getExt(fileName);\n\n    opts.path = `${this.storagePath(opts)}${nodePath.sep}${FSName}${extensionWithDot}`;\n    opts.type = this._getMimeType(opts);\n    if (!helpers.isObject(opts.meta)) {\n      opts.meta = {};\n    }\n\n    if (!helpers.isNumber(opts.size)) {\n      opts.size = buffer.length;\n    }\n\n    const result = this._dataToSchema({\n      name: fileName,\n      path: opts.path,\n      meta: opts.meta,\n      type: opts.type,\n      size: opts.size,\n      userId: opts.userId,\n      extension\n    });\n\n    result._id = fileId;\n\n    const stream = fs.createWriteStream(opts.path, {flags: 'w', mode: this.permissions});\n    stream.end(buffer, (streamErr) => bound(() => {\n      if (streamErr) {\n        callback && callback(streamErr);\n      } else {\n        this.collection.insert(result, (insertErr, _id) => {\n          if (insertErr) {\n            callback && callback(insertErr);\n            this._debug(`[FilesCollection] [write] [insert] Error: ${fileName} -> ${this.collectionName}`, insertErr);\n          } else {\n            const fileRef = this.collection.findOne(_id);\n            callback && callback(null, fileRef);\n            if (proceedAfterUpload === true) {\n              this.onAfterUpload && this.onAfterUpload.call(this, fileRef);\n              this.emit('afterUpload', fileRef);\n            }\n            this._debug(`[FilesCollection] [write]: ${fileName} -> ${this.collectionName}`);\n          }\n        });\n      }\n    }));\n    return this;\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name load\n   * @param {String} url - URL to file\n   * @param {Object} opts - Object with file-data\n   * @param {Object} opts.headers - HTTP headers to use when requesting the file\n   * @param {String} opts.name - File name, alias: `fileName`\n   * @param {String} opts.type - File mime-type\n   * @param {Object} opts.meta - File additional meta-data\n   * @param {String} opts.userId - UserId, default *null*\n   * @param {String} opts.fileId - _id, default *null*\n   * @param {Function} callback - function(error, fileObj){...}\n   * @param {Boolean} proceedAfterUpload - Proceed onAfterUpload hook\n   * @summary Download file, write stream to FS and add to FilesCollection Collection\n   * @returns {FilesCollection} Instance\n   */\n  load(url, _opts = {}, _callback, _proceedAfterUpload) {\n    this._debug(`[FilesCollection] [load(${url}, ${JSON.stringify(_opts)}, callback)]`);\n    let opts = _opts;\n    let callback = _callback;\n    let proceedAfterUpload = _proceedAfterUpload;\n\n    if (helpers.isFunction(opts)) {\n      proceedAfterUpload = callback;\n      callback = opts;\n      opts     = {};\n    } else if (helpers.isBoolean(callback)) {\n      proceedAfterUpload = callback;\n    } else if (helpers.isBoolean(opts)) {\n      proceedAfterUpload = opts;\n    }\n\n    check(url, String);\n    check(opts, Match.Optional(Object));\n    check(callback, Match.Optional(Function));\n    check(proceedAfterUpload, Match.Optional(Boolean));\n\n    if (!helpers.isObject(opts)) {\n      opts = {};\n    }\n\n    const fileId    = opts.fileId || Random.id();\n    const FSName    = this.namingFunction ? this.namingFunction(opts) : fileId;\n    const pathParts = url.split('/');\n    const fileName  = (opts.name || opts.fileName) ? (opts.name || opts.fileName) : pathParts[pathParts.length - 1] || FSName;\n\n    const {extension, extensionWithDot} = this._getExt(fileName);\n    opts.path  = `${this.storagePath(opts)}${nodePath.sep}${FSName}${extensionWithDot}`;\n\n    const storeResult = (result, cb) => {\n      result._id = fileId;\n\n      this.collection.insert(result, (error, _id) => {\n        if (error) {\n          cb && cb(error);\n          this._debug(`[FilesCollection] [load] [insert] Error: ${fileName} -> ${this.collectionName}`, error);\n        } else {\n          const fileRef = this.collection.findOne(_id);\n          cb && cb(null, fileRef);\n          if (proceedAfterUpload === true) {\n            this.onAfterUpload && this.onAfterUpload.call(this, fileRef);\n            this.emit('afterUpload', fileRef);\n          }\n          this._debug(`[FilesCollection] [load] [insert] ${fileName} -> ${this.collectionName}`);\n        }\n      });\n    };\n\n    request.get({\n      url,\n      headers: opts.headers || {}\n    }).on('error', (error) => bound(() => {\n      callback && callback(error);\n      this._debug(`[FilesCollection] [load] [request.get(${url})] Error:`, error);\n    })).on('response', (response) => bound(() => {\n      response.on('end', () => bound(() => {\n        this._debug(`[FilesCollection] [load] Received: ${url}`);\n        const result = this._dataToSchema({\n          name: fileName,\n          path: opts.path,\n          meta: opts.meta,\n          type: opts.type || response.headers['content-type'] || this._getMimeType({path: opts.path}),\n          size: opts.size || parseInt(response.headers['content-length'] || 0),\n          userId: opts.userId,\n          extension\n        });\n\n        if (!result.size) {\n          fs.stat(opts.path, (error, stats) => bound(() => {\n            if (error) {\n              callback && callback(error);\n            } else {\n              result.versions.original.size = (result.size = stats.size);\n              storeResult(result, callback);\n            }\n          }));\n        } else {\n          storeResult(result, callback);\n        }\n      }));\n    })).pipe(fs.createWriteStream(opts.path, {flags: 'w', mode: this.permissions}));\n\n    return this;\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name addFile\n   * @param {String} path          - Path to file\n   * @param {String} opts          - [Optional] Object with file-data\n   * @param {String} opts.type     - [Optional] File mime-type\n   * @param {Object} opts.meta     - [Optional] File additional meta-data\n   * @param {String} opts.fileId   - _id, default *null*\n   * @param {Object} opts.fileName - [Optional] File name, if not specified file name and extension will be taken from path\n   * @param {String} opts.userId   - [Optional] UserId, default *null*\n   * @param {Function} callback    - [Optional] function(error, fileObj){...}\n   * @param {Boolean} proceedAfterUpload - Proceed onAfterUpload hook\n   * @summary Add file from FS to FilesCollection\n   * @returns {FilesCollection} Instance\n   */\n  addFile(path, _opts = {}, _callback, _proceedAfterUpload) {\n    this._debug(`[FilesCollection] [addFile(${path})]`);\n    let opts = _opts;\n    let callback = _callback;\n    let proceedAfterUpload = _proceedAfterUpload;\n\n    if (helpers.isFunction(opts)) {\n      proceedAfterUpload = callback;\n      callback = opts;\n      opts     = {};\n    } else if (helpers.isBoolean(callback)) {\n      proceedAfterUpload = callback;\n    } else if (helpers.isBoolean(opts)) {\n      proceedAfterUpload = opts;\n    }\n\n    if (this.public) {\n      throw new Meteor.Error(403, 'Can not run [addFile] on public collection! Just Move file to root of your server, then add record to Collection');\n    }\n\n    check(path, String);\n    check(opts, Match.Optional(Object));\n    check(callback, Match.Optional(Function));\n    check(proceedAfterUpload, Match.Optional(Boolean));\n\n    fs.stat(path, (statErr, stats) => bound(() => {\n      if (statErr) {\n        callback && callback(statErr);\n      } else if (stats.isFile()) {\n        if (!helpers.isObject(opts)) {\n          opts = {};\n        }\n        opts.path  = path;\n\n        if (!opts.fileName) {\n          const pathParts = path.split(nodePath.sep);\n          opts.fileName   = path.split(nodePath.sep)[pathParts.length - 1];\n        }\n\n        const {extension} = this._getExt(opts.fileName);\n\n        if (!helpers.isString(opts.type)) {\n          opts.type = this._getMimeType(opts);\n        }\n\n        if (!helpers.isObject(opts.meta)) {\n          opts.meta = {};\n        }\n\n        if (!helpers.isNumber(opts.size)) {\n          opts.size = stats.size;\n        }\n\n        const result = this._dataToSchema({\n          name: opts.fileName,\n          path,\n          meta: opts.meta,\n          type: opts.type,\n          size: opts.size,\n          userId: opts.userId,\n          extension,\n          _storagePath: path.replace(`${nodePath.sep}${opts.fileName}`, ''),\n          fileId: opts.fileId || null\n        });\n\n\n        this.collection.insert(result, (insertErr, _id) => {\n          if (insertErr) {\n            callback && callback(insertErr);\n            this._debug(`[FilesCollection] [addFile] [insert] Error: ${result.name} -> ${this.collectionName}`, insertErr);\n          } else {\n            const fileRef = this.collection.findOne(_id);\n            callback && callback(null, fileRef);\n            if (proceedAfterUpload === true) {\n              this.onAfterUpload && this.onAfterUpload.call(this, fileRef);\n              this.emit('afterUpload', fileRef);\n            }\n            this._debug(`[FilesCollection] [addFile]: ${result.name} -> ${this.collectionName}`);\n          }\n        });\n      } else {\n        callback && callback(new Meteor.Error(400, `[FilesCollection] [addFile(${path})]: File does not exist`));\n      }\n    }));\n    return this;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollection\n   * @name remove\n   * @param {String|Object} selector - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n   * @param {Function} callback - Callback with one `error` argument\n   * @summary Remove documents from the collection\n   * @returns {FilesCollection} Instance\n   */\n  remove(selector, callback) {\n    this._debug(`[FilesCollection] [remove(${JSON.stringify(selector)})]`);\n    if (selector === void 0) {\n      return 0;\n    }\n    check(callback, Match.Optional(Function));\n\n    const files = this.collection.find(selector);\n    if (files.count() > 0) {\n      files.forEach((file) => {\n        this.unlink(file);\n      });\n    } else {\n      callback && callback(new Meteor.Error(404, 'Cursor is empty, no files is removed'));\n      return this;\n    }\n\n    if (this.onAfterRemove) {\n      const docs = files.fetch();\n      const self = this;\n      this.collection.remove(selector, function () {\n        callback && callback.apply(this, arguments);\n        self.onAfterRemove(docs);\n      });\n    } else {\n      this.collection.remove(selector, (callback || NOOP));\n    }\n    return this;\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name deny\n   * @param {Object} rules\n   * @see  https://docs.meteor.com/api/collections.html#Mongo-Collection-deny\n   * @summary link Mongo.Collection deny methods\n   * @returns {Mongo.Collection} Instance\n   */\n  deny(rules) {\n    this.collection.deny(rules);\n    return this.collection;\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name allow\n   * @param {Object} rules\n   * @see https://docs.meteor.com/api/collections.html#Mongo-Collection-allow\n   * @summary link Mongo.Collection allow methods\n   * @returns {Mongo.Collection} Instance\n   */\n  allow(rules) {\n    this.collection.allow(rules);\n    return this.collection;\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name denyClient\n   * @see https://docs.meteor.com/api/collections.html#Mongo-Collection-deny\n   * @summary Shorthands for Mongo.Collection deny method\n   * @returns {Mongo.Collection} Instance\n   */\n  denyClient() {\n    this.collection.deny({\n      insert() { return true; },\n      update() { return true; },\n      remove() { return true; }\n    });\n    return this.collection;\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name allowClient\n   * @see https://docs.meteor.com/api/collections.html#Mongo-Collection-allow\n   * @summary Shorthands for Mongo.Collection allow method\n   * @returns {Mongo.Collection} Instance\n   */\n  allowClient() {\n    this.collection.allow({\n      insert() { return true; },\n      update() { return true; },\n      remove() { return true; }\n    });\n    return this.collection;\n  }\n\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name unlink\n   * @param {Object} fileRef - fileObj\n   * @param {String} version - [Optional] file's version\n   * @param {Function} callback - [Optional] callback function\n   * @summary Unlink files and it's versions from FS\n   * @returns {FilesCollection} Instance\n   */\n  unlink(fileRef, version, callback) {\n    this._debug(`[FilesCollection] [unlink(${fileRef._id}, ${version})]`);\n    if (version) {\n      if (helpers.isObject(fileRef.versions) && helpers.isObject(fileRef.versions[version]) && fileRef.versions[version].path) {\n        fs.unlink(fileRef.versions[version].path, (callback || NOOP));\n      }\n    } else {\n      if (helpers.isObject(fileRef.versions)) {\n        for(let vKey in fileRef.versions) {\n          if (fileRef.versions[vKey] && fileRef.versions[vKey].path) {\n            fs.unlink(fileRef.versions[vKey].path, (callback || NOOP));\n          }\n        }\n      } else {\n        fs.unlink(fileRef.path, (callback || NOOP));\n      }\n    }\n    return this;\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name _404\n   * @summary Internal method, used to return 404 error\n   * @returns {undefined}\n   */\n  _404(http) {\n    this._debug(`[FilesCollection] [download(${http.request.originalUrl})] [_404] File not found`);\n    const text = 'File Not Found :(';\n\n    if (!http.response.headersSent) {\n      http.response.writeHead(404, {\n        'Content-Type': 'text/plain',\n        'Content-Length': text.length\n      }\n      );\n    }\n    if (!http.response.finished) {\n      http.response.end(text);\n    }\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name download\n   * @param {Object} http    - Server HTTP object\n   * @param {String} version - Requested file version\n   * @param {Object} fileRef - Requested file Object\n   * @summary Initiates the HTTP response\n   * @returns {undefined}\n   */\n  download(http, version = 'original', fileRef) {\n    let vRef;\n    this._debug(`[FilesCollection] [download(${http.request.originalUrl}, ${version})]`);\n\n    if (fileRef) {\n      if (helpers.has(fileRef, 'versions') && helpers.has(fileRef.versions, version)) {\n        vRef = fileRef.versions[version];\n        vRef._id = fileRef._id;\n      } else {\n        vRef = fileRef;\n      }\n    } else {\n      vRef = false;\n    }\n\n    if (!vRef || !helpers.isObject(vRef)) {\n      return this._404(http);\n    } else if (fileRef) {\n      if (this.downloadCallback) {\n        if (!this.downloadCallback.call(Object.assign(http, this._getUser(http)), fileRef)) {\n          return this._404(http);\n        }\n      }\n\n      if (this.interceptDownload && helpers.isFunction(this.interceptDownload)) {\n        if (this.interceptDownload(http, fileRef, version) === true) {\n          return void 0;\n        }\n      }\n\n      fs.stat(vRef.path, (statErr, stats) => bound(() => {\n        let responseType;\n        if (statErr || !stats.isFile()) {\n          return this._404(http);\n        }\n\n        if ((stats.size !== vRef.size) && !this.integrityCheck) {\n          vRef.size    = stats.size;\n        }\n\n        if ((stats.size !== vRef.size) && this.integrityCheck) {\n          responseType = '400';\n        }\n\n        return this.serve(http, fileRef, vRef, version, null, (responseType || '200'));\n      }));\n      return void 0;\n    }\n    return this._404(http);\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name serve\n   * @param {Object} http    - Server HTTP object\n   * @param {Object} fileRef - Requested file Object\n   * @param {Object} vRef    - Requested file version Object\n   * @param {String} version - Requested file version\n   * @param {stream.Readable|null} readableStream - Readable stream, which serves binary file data\n   * @param {String} responseType - Response code\n   * @param {Boolean} force200 - Force 200 response code over 206\n   * @summary Handle and reply to incoming request\n   * @returns {undefined}\n   */\n  serve(http, fileRef, vRef, version = 'original', readableStream = null, _responseType = '200', force200 = false) {\n    let partiral = false;\n    let reqRange = false;\n    let dispositionType = '';\n    let start;\n    let end;\n    let take;\n    let responseType = _responseType;\n\n    if (http.params.query.download && (http.params.query.download === 'true')) {\n      dispositionType = 'attachment; ';\n    } else {\n      dispositionType = 'inline; ';\n    }\n\n    const dispositionName     = `filename=\\\"${encodeURI(vRef.name || fileRef.name).replace(/\\,/g, '%2C')}\\\"; filename*=UTF-8''${encodeURIComponent(vRef.name || fileRef.name)}; `;\n    const dispositionEncoding = 'charset=UTF-8';\n\n    if (!http.response.headersSent) {\n      http.response.setHeader('Content-Disposition', dispositionType + dispositionName + dispositionEncoding);\n    }\n\n    if (http.request.headers.range && !force200) {\n      partiral    = true;\n      const array = http.request.headers.range.split(/bytes=([0-9]*)-([0-9]*)/);\n      start       = parseInt(array[1]);\n      end         = parseInt(array[2]);\n      if (isNaN(end)) {\n        end       = vRef.size - 1;\n      }\n      take        = end - start;\n    } else {\n      start = 0;\n      end   = vRef.size - 1;\n      take  = vRef.size;\n    }\n\n    if (partiral || (http.params.query.play && (http.params.query.play === 'true'))) {\n      reqRange = {start, end};\n      if (isNaN(start) && !isNaN(end)) {\n        reqRange.start = end - take;\n        reqRange.end   = end;\n      }\n      if (!isNaN(start) && isNaN(end)) {\n        reqRange.start = start;\n        reqRange.end   = start + take;\n      }\n\n      if ((start + take) >= vRef.size) { reqRange.end = vRef.size - 1; }\n\n      if (this.strict && ((reqRange.start >= (vRef.size - 1)) || (reqRange.end > (vRef.size - 1)))) {\n        responseType = '416';\n      } else {\n        responseType = '206';\n      }\n    } else {\n      responseType = '200';\n    }\n\n    const streamErrorHandler = (error) => {\n      this._debug(`[FilesCollection] [serve(${vRef.path}, ${version})] [500]`, error);\n      if (!http.response.finished) {\n        http.response.end(error.toString());\n      }\n    };\n\n    const headers = helpers.isFunction(this.responseHeaders) ? this.responseHeaders(responseType, fileRef, vRef, version) : this.responseHeaders;\n\n    if (!headers['Cache-Control']) {\n      if (!http.response.headersSent) {\n        http.response.setHeader('Cache-Control', this.cacheControl);\n      }\n    }\n\n    for (let key in headers) {\n      if (!http.response.headersSent) {\n        http.response.setHeader(key, headers[key]);\n      }\n    }\n\n    const respond = (stream, code) => {\n      if (!http.response.headersSent && readableStream) {\n        http.response.writeHead(code);\n      }\n\n      http.response.on('close', () => {\n        if (typeof stream.abort === 'function') {\n          stream.abort();\n        }\n        if (typeof stream.end === 'function') {\n          stream.end();\n        }\n      });\n\n      http.request.on('aborted', () => {\n        http.request.aborted = true;\n        if (typeof stream.abort === 'function') {\n          stream.abort();\n        }\n        if (typeof stream.end === 'function') {\n          stream.end();\n        }\n      });\n\n      stream.on('open', () => {\n        if (!http.response.headersSent) {\n          http.response.writeHead(code);\n        }\n      }).on('abort', () => {\n        if (!http.response.finished) {\n          http.response.end();\n        }\n        if (!http.request.aborted) {\n          http.request.destroy();\n        }\n      }).on('error', streamErrorHandler\n      ).on('end', () => {\n        if (!http.response.finished) {\n          http.response.end();\n        }\n      }).pipe(http.response);\n    };\n\n    switch (responseType) {\n    case '400':\n      this._debug(`[FilesCollection] [serve(${vRef.path}, ${version})] [400] Content-Length mismatch!`);\n      var text = 'Content-Length mismatch!';\n\n      if (!http.response.headersSent) {\n        http.response.writeHead(400, {\n          'Content-Type': 'text/plain',\n          'Content-Length': text.length\n        });\n      }\n\n      if (!http.response.finished) {\n        http.response.end(text);\n      }\n      break;\n    case '404':\n      this._404(http);\n      break;\n    case '416':\n      this._debug(`[FilesCollection] [serve(${vRef.path}, ${version})] [416] Content-Range is not specified!`);\n      if (!http.response.headersSent) {\n        http.response.writeHead(416);\n      }\n      if (!http.response.finished) {\n        http.response.end();\n      }\n      break;\n    case '206':\n      this._debug(`[FilesCollection] [serve(${vRef.path}, ${version})] [206]`);\n      if (!http.response.headersSent) {\n        http.response.setHeader('Content-Range', `bytes ${reqRange.start}-${reqRange.end}/${vRef.size}`);\n      }\n      respond(readableStream || fs.createReadStream(vRef.path, {start: reqRange.start, end: reqRange.end}), 206);\n      break;\n    default:\n      this._debug(`[FilesCollection] [serve(${vRef.path}, ${version})] [200]`);\n      respond(readableStream || fs.createReadStream(vRef.path), 200);\n      break;\n    }\n  }\n}\n","import { EventEmitter }            from 'eventemitter3';\nimport { check, Match }            from 'meteor/check';\nimport { formatFleURL, helpers }   from './lib.js';\nimport { FilesCursor, FileCursor } from './cursor.js';\n\nexport default class FilesCollectionCore extends EventEmitter {\n  constructor() {\n    super();\n  }\n\n  static __helpers = helpers;\n\n  static schema = {\n    _id: {\n      type: String\n    },\n    size: {\n      type: Number\n    },\n    name: {\n      type: String\n    },\n    type: {\n      type: String\n    },\n    path: {\n      type: String\n    },\n    isVideo: {\n      type: Boolean\n    },\n    isAudio: {\n      type: Boolean\n    },\n    isImage: {\n      type: Boolean\n    },\n    isText: {\n      type: Boolean\n    },\n    isJSON: {\n      type: Boolean\n    },\n    isPDF: {\n      type: Boolean\n    },\n    extension: {\n      type: String,\n      optional: true\n    },\n    ext: {\n      type: String,\n      optional: true\n    },\n    extensionWithDot: {\n      type: String,\n      optional: true\n    },\n    mime: {\n      type: String,\n      optional: true\n    },\n    'mime-type': {\n      type: String,\n      optional: true\n    },\n    _storagePath: {\n      type: String\n    },\n    _downloadRoute: {\n      type: String\n    },\n    _collectionName: {\n      type: String\n    },\n    public: {\n      type: Boolean,\n      optional: true\n    },\n    meta: {\n      type: Object,\n      blackbox: true,\n      optional: true\n    },\n    userId: {\n      type: String,\n      optional: true\n    },\n    updatedAt: {\n      type: Date,\n      optional: true\n    },\n    versions: {\n      type: Object,\n      blackbox: true\n    }\n  };\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _debug\n   * @summary Print logs in debug mode\n   * @returns {void}\n   */\n  _debug() {\n    if (this.debug) {\n      (console.info || console.log || function () { }).apply(void 0, arguments);\n    }\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _getFileName\n   * @param {Object} fileData - File Object\n   * @summary Returns file's name\n   * @returns {String}\n   */\n  _getFileName(fileData) {\n    const fileName = fileData.name || fileData.fileName;\n    if (helpers.isString(fileName) && (fileName.length > 0)) {\n      return (fileData.name || fileData.fileName).replace(/^\\.\\.+/, '').replace(/\\.{2,}/g, '.').replace(/\\//g, '');\n    }\n    return '';\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _getExt\n   * @param {String} FileName - File name\n   * @summary Get extension from FileName\n   * @returns {Object}\n   */\n  _getExt(fileName) {\n    if (!!~fileName.indexOf('.')) {\n      const extension = (fileName.split('.').pop().split('?')[0] || '').toLowerCase();\n      return { ext: extension, extension, extensionWithDot: `.${extension}` };\n    }\n    return { ext: '', extension: '', extensionWithDot: '' };\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _updateFileTypes\n   * @param {Object} data - File data\n   * @summary Internal method. Classify file based on 'type' field\n   */\n  _updateFileTypes(data) {\n    data.isVideo  = /^video\\//i.test(data.type);\n    data.isAudio  = /^audio\\//i.test(data.type);\n    data.isImage  = /^image\\//i.test(data.type);\n    data.isText   = /^text\\//i.test(data.type);\n    data.isJSON   = /^application\\/json$/i.test(data.type);\n    data.isPDF    = /^application\\/(x-)?pdf$/i.test(data.type);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _dataToSchema\n   * @param {Object} data - File data\n   * @summary Internal method. Build object in accordance with default schema from File data\n   * @returns {Object}\n   */\n  _dataToSchema(data) {\n    const ds = {\n      name: data.name,\n      extension: data.extension,\n      ext: data.extension,\n      extensionWithDot: '.' + data.extension,\n      path: data.path,\n      meta: data.meta,\n      type: data.type,\n      mime: data.type,\n      'mime-type': data.type,\n      size: data.size,\n      userId: data.userId || null,\n      versions: {\n        original: {\n          path: data.path,\n          size: data.size,\n          type: data.type,\n          extension: data.extension\n        }\n      },\n      _downloadRoute: data._downloadRoute || this.downloadRoute,\n      _collectionName: data._collectionName || this.collectionName\n    };\n\n    //Optional fileId\n    if (data.fileId) {\n      ds._id = data.fileId;\n    }\n\n    this._updateFileTypes(ds);\n    ds._storagePath = data._storagePath || this.storagePath(Object.assign({}, data, ds));\n    return ds;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name findOne\n   * @param {String|Object} selector - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n   * @param {Object} options - Mongo-Style selector Options (http://docs.meteor.com/api/collections.html#sortspecifiers)\n   * @summary Find and return Cursor for matching document Object\n   * @returns {FileCursor} Instance\n   */\n  findOne(selector = {}, options) {\n    this._debug(`[FilesCollection] [findOne(${JSON.stringify(selector)}, ${JSON.stringify(options)})]`);\n    check(selector, Match.Optional(Match.OneOf(Object, String, Boolean, Number, null)));\n    check(options, Match.Optional(Object));\n\n    const doc = this.collection.findOne(selector, options);\n    if (doc) {\n      return new FileCursor(doc, this);\n    }\n    return doc;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name find\n   * @param {String|Object} selector - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n   * @param {Object}        options  - Mongo-Style selector Options (http://docs.meteor.com/api/collections.html#sortspecifiers)\n   * @summary Find and return Cursor for matching documents\n   * @returns {FilesCursor} Instance\n   */\n  find(selector = {}, options) {\n    this._debug(`[FilesCollection] [find(${JSON.stringify(selector)}, ${JSON.stringify(options)})]`);\n    check(selector, Match.Optional(Match.OneOf(Object, String, Boolean, Number, null)));\n    check(options, Match.Optional(Object));\n\n    return new FilesCursor(selector, options, this);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name update\n   * @see http://docs.meteor.com/#/full/update\n   * @summary link Mongo.Collection update method\n   * @returns {Mongo.Collection} Instance\n   */\n  update() {\n    this.collection.update.apply(this.collection, arguments);\n    return this.collection;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name link\n   * @param {Object} fileRef - File reference object\n   * @param {String} version - Version of file you would like to request\n   * @param {String} URIBase - [Optional] URI base, see - https://github.com/VeliovGroup/Meteor-Files/issues/626\n   * @summary Returns downloadable URL\n   * @returns {String} Empty string returned in case if file not found in DB\n   */\n  link(fileRef, version = 'original', URIBase) {\n    this._debug(`[FilesCollection] [link(${(helpers.isObject(fileRef) ? fileRef._id : void 0)}, ${version})]`);\n    check(fileRef, Object);\n\n    if (!fileRef) {\n      return '';\n    }\n    return formatFleURL(fileRef, version, URIBase);\n  }\n}\n","import { Meteor } from 'meteor/meteor';\n\n/*\n * @private\n * @locus Anywhere\n * @class FileCursor\n * @param _fileRef    {Object} - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n * @param _collection {FilesCollection} - FilesCollection Instance\n * @summary Internal class, represents each record in `FilesCursor.each()` or document returned from `.findOne()` method\n */\nexport class FileCursor {\n  constructor(_fileRef, _collection) {\n    this._fileRef    = _fileRef;\n    this._collection = _collection;\n    Object.assign(this, _fileRef);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name remove\n   * @param callback {Function} - Triggered asynchronously after item is removed or failed to be removed\n   * @summary Remove document\n   * @returns {FileCursor}\n   */\n  remove(callback) {\n    this._collection._debug('[FilesCollection] [FileCursor] [remove()]');\n    if (this._fileRef) {\n      this._collection.remove(this._fileRef._id, callback);\n    } else {\n      callback && callback(new Meteor.Error(404, 'No such file'));\n    }\n    return this;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name link\n   * @param version {String} - Name of file's subversion\n   * @param URIBase {String} - [Optional] URI base, see - https://github.com/VeliovGroup/Meteor-Files/issues/626\n   * @summary Returns downloadable URL to File\n   * @returns {String}\n   */\n  link(version = 'original', URIBase) {\n    this._collection._debug(`[FilesCollection] [FileCursor] [link(${version})]`);\n    if (this._fileRef) {\n      return this._collection.link(this._fileRef, version, URIBase);\n    }\n    return '';\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name get\n   * @param property {String} - Name of sub-object property\n   * @summary Returns current document as a plain Object, if `property` is specified - returns value of sub-object property\n   * @returns {Object|mix}\n   */\n  get(property) {\n    this._collection._debug(`[FilesCollection] [FileCursor] [get(${property})]`);\n    if (property) {\n      return this._fileRef[property];\n    }\n    return this._fileRef;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name fetch\n   * @summary Returns document as plain Object in Array\n   * @returns {[Object]}\n   */\n  fetch() {\n    this._collection._debug('[FilesCollection] [FileCursor] [fetch()]');\n    return [this._fileRef];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name with\n   * @summary Returns reactive version of current FileCursor, useful to use with `{{#with}}...{{/with}}` block template helper\n   * @returns {[Object]}\n   */\n  with() {\n    this._collection._debug('[FilesCollection] [FileCursor] [with()]');\n    return Object.assign(this, this._collection.collection.findOne(this._fileRef._id));\n  }\n}\n\n/*\n * @private\n * @locus Anywhere\n * @class FilesCursor\n * @param _selector   {String|Object}   - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n * @param options     {Object}          - Mongo-Style selector Options (http://docs.meteor.com/api/collections.html#selectors)\n * @param _collection {FilesCollection} - FilesCollection Instance\n * @summary Implementation of Cursor for FilesCollection\n */\nexport class FilesCursor {\n  constructor(_selector = {}, options, _collection) {\n    this._collection = _collection;\n    this._selector   = _selector;\n    this._current    = -1;\n    this.cursor      = this._collection.collection.find(this._selector, options);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name get\n   * @summary Returns all matching document(s) as an Array. Alias of `.fetch()`\n   * @returns {[Object]}\n   */\n  get() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [get()]');\n    return this.cursor.fetch();\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name hasNext\n   * @summary Returns `true` if there is next item available on Cursor\n   * @returns {Boolean}\n   */\n  hasNext() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [hasNext()]');\n    return this._current < (this.cursor.count() - 1);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name next\n   * @summary Returns next item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  next() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [next()]');\n    this.cursor.fetch()[++this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name hasPrevious\n   * @summary Returns `true` if there is previous item available on Cursor\n   * @returns {Boolean}\n   */\n  hasPrevious() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [hasPrevious()]');\n    return this._current !== -1;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name previous\n   * @summary Returns previous item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  previous() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [previous()]');\n    this.cursor.fetch()[--this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name fetch\n   * @summary Returns all matching document(s) as an Array.\n   * @returns {[Object]}\n   */\n  fetch() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [fetch()]');\n    return this.cursor.fetch() || [];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name first\n   * @summary Returns first item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  first() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [first()]');\n    this._current = 0;\n    return this.fetch()[this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name last\n   * @summary Returns last item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  last() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [last()]');\n    this._current = this.count() - 1;\n    return this.fetch()[this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name count\n   * @summary Returns the number of documents that match a query\n   * @returns {Number}\n   */\n  count() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [count()]');\n    return this.cursor.count();\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name remove\n   * @param callback {Function} - Triggered asynchronously after item is removed or failed to be removed\n   * @summary Removes all documents that match a query\n   * @returns {FilesCursor}\n   */\n  remove(callback) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [remove()]');\n    this._collection.remove(this._selector, callback);\n    return this;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name forEach\n   * @param callback {Function} - Function to call. It will be called with three arguments: the `file`, a 0-based index, and cursor itself\n   * @param context {Object} - An object which will be the value of `this` inside `callback`\n   * @summary Call `callback` once for each matching document, sequentially and synchronously.\n   * @returns {undefined}\n   */\n  forEach(callback, context = {}) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [forEach()]');\n    this.cursor.forEach(callback, context);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name each\n   * @summary Returns an Array of FileCursor made for each document on current cursor\n   *          Useful when using in {{#each FilesCursor#each}}...{{/each}} block template helper\n   * @returns {[FileCursor]}\n   */\n  each() {\n    return this.map((file) => {\n      return new FileCursor(file, this._collection);\n    });\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name map\n   * @param callback {Function} - Function to call. It will be called with three arguments: the `file`, a 0-based index, and cursor itself\n   * @param context {Object} - An object which will be the value of `this` inside `callback`\n   * @summary Map `callback` over all matching documents. Returns an Array.\n   * @returns {Array}\n   */\n  map(callback, context = {}) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [map()]');\n    return this.cursor.map(callback, context);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name current\n   * @summary Returns current item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  current() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [current()]');\n    if (this._current < 0) {\n      this._current = 0;\n    }\n    return this.fetch()[this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name observe\n   * @param callbacks {Object} - Functions to call to deliver the result set as it changes\n   * @summary Watch a query. Receive callbacks as the result set changes.\n   * @url http://docs.meteor.com/api/collections.html#Mongo-Cursor-observe\n   * @returns {Object} - live query handle\n   */\n  observe(callbacks) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [observe()]');\n    return this.cursor.observe(callbacks);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name observeChanges\n   * @param callbacks {Object} - Functions to call to deliver the result set as it changes\n   * @summary Watch a query. Receive callbacks as the result set changes. Only the differences between the old and new documents are passed to the callbacks.\n   * @url http://docs.meteor.com/api/collections.html#Mongo-Cursor-observeChanges\n   * @returns {Object} - live query handle\n   */\n  observeChanges(callbacks) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [observeChanges()]');\n    return this.cursor.observeChanges(callbacks);\n  }\n}\n","import { check } from 'meteor/check';\n\nconst helpers = {\n  isUndefined(obj) {\n    return obj === void 0;\n  },\n  isObject(obj) {\n    if (this.isArray(obj) || this.isFunction(obj)) {\n      return false;\n    }\n    return obj === Object(obj);\n  },\n  isArray(obj) {\n    return Array.isArray(obj);\n  },\n  isBoolean(obj) {\n    return obj === true || obj === false || Object.prototype.toString.call(obj) === '[object Boolean]';\n  },\n  isFunction(obj) {\n    return typeof obj === 'function' || false;\n  },\n  isEmpty(obj) {\n    if (this.isDate(obj)) {\n      return false;\n    }\n    if (this.isObject(obj)) {\n      return !Object.keys(obj).length;\n    }\n    if (this.isArray(obj) || this.isString(obj)) {\n      return !obj.length;\n    }\n    return false;\n  },\n  clone(obj) {\n    if (!this.isObject(obj)) return obj;\n    return this.isArray(obj) ? obj.slice() : Object.assign({}, obj);\n  },\n  has(_obj, path) {\n    let obj = _obj;\n    if (!this.isObject(obj)) {\n      return false;\n    }\n    if (!this.isArray(path)) {\n      return this.isObject(obj) && Object.prototype.hasOwnProperty.call(obj, path);\n    }\n\n    const length = path.length;\n    for (let i = 0; i < length; i++) {\n      if (!Object.prototype.hasOwnProperty.call(obj, path[i])) {\n        return false;\n      }\n      obj = obj[path[i]];\n    }\n    return !!length;\n  },\n  omit(obj, ...keys) {\n    const clear = Object.assign({}, obj);\n    for (let i = keys.length - 1; i >= 0; i--) {\n      delete clear[keys[i]];\n    }\n\n    return clear;\n  },\n  now: Date.now,\n  throttle(func, wait, options = {}) {\n    let previous = 0;\n    let timeout = null;\n    let result;\n    const that = this;\n    let self;\n    let args;\n\n    const later = () => {\n      previous = options.leading === false ? 0 : that.now();\n      timeout = null;\n      result = func.apply(self, args);\n      if (!timeout) {\n        self = args = null;\n      }\n    };\n\n    const throttled = function () {\n      const now = that.now();\n      if (!previous && options.leading === false) previous = now;\n      const remaining = wait - (now - previous);\n      self = this;\n      args = arguments;\n      if (remaining <= 0 || remaining > wait) {\n        if (timeout) {\n          clearTimeout(timeout);\n          timeout = null;\n        }\n        previous = now;\n        result = func.apply(self, args);\n        if (!timeout) {\n          self = args = null;\n        }\n      } else if (!timeout && options.trailing !== false) {\n        timeout = setTimeout(later, remaining);\n      }\n      return result;\n    };\n\n    throttled.cancel = () => {\n      clearTimeout(timeout);\n      previous = 0;\n      timeout = self = args = null;\n    };\n\n    return throttled;\n  }\n};\n\nconst _helpers = ['String', 'Number', 'Date'];\nfor (let i = 0; i < _helpers.length; i++) {\n  helpers['is' + _helpers[i]] = function (obj) {\n    return Object.prototype.toString.call(obj) === '[object ' + _helpers[i] + ']';\n  };\n}\n\n/*\n * @const {Function} fixJSONParse - Fix issue with Date parse\n */\nconst fixJSONParse = function(obj) {\n  for (let key in obj) {\n    if (helpers.isString(obj[key]) && !!~obj[key].indexOf('=--JSON-DATE--=')) {\n      obj[key] = obj[key].replace('=--JSON-DATE--=', '');\n      obj[key] = new Date(parseInt(obj[key]));\n    } else if (helpers.isObject(obj[key])) {\n      obj[key] = fixJSONParse(obj[key]);\n    } else if (helpers.isArray(obj[key])) {\n      let v;\n      for (let i = 0; i < obj[key].length; i++) {\n        v = obj[key][i];\n        if (helpers.isObject(v)) {\n          obj[key][i] = fixJSONParse(v);\n        } else if (helpers.isString(v) && !!~v.indexOf('=--JSON-DATE--=')) {\n          v = v.replace('=--JSON-DATE--=', '');\n          obj[key][i] = new Date(parseInt(v));\n        }\n      }\n    }\n  }\n  return obj;\n};\n\n/*\n * @const {Function} fixJSONStringify - Fix issue with Date stringify\n */\nconst fixJSONStringify = function(obj) {\n  for (let key in obj) {\n    if (helpers.isDate(obj[key])) {\n      obj[key] = `=--JSON-DATE--=${+obj[key]}`;\n    } else if (helpers.isObject(obj[key])) {\n      obj[key] = fixJSONStringify(obj[key]);\n    } else if (helpers.isArray(obj[key])) {\n      let v;\n      for (let i = 0; i < obj[key].length; i++) {\n        v = obj[key][i];\n        if (helpers.isObject(v)) {\n          obj[key][i] = fixJSONStringify(v);\n        } else if (helpers.isDate(v)) {\n          obj[key][i] = `=--JSON-DATE--=${+v}`;\n        }\n      }\n    }\n  }\n  return obj;\n};\n\n/*\n * @locus Anywhere\n * @private\n * @name formatFleURL\n * @param {Object} fileRef - File reference object\n * @param {String} version - [Optional] Version of file you would like build URL for\n * @param {String} URIBase - [Optional] URI base, see - https://github.com/VeliovGroup/Meteor-Files/issues/626\n * @summary Returns formatted URL for file\n * @returns {String} Downloadable link\n */\nconst formatFleURL = (fileRef, version = 'original', _URIBase = (__meteor_runtime_config__ || {}).ROOT_URL) => {\n  check(fileRef, Object);\n  check(version, String);\n  let URIBase = _URIBase;\n\n  if (!helpers.isString(URIBase)) {\n    URIBase = (__meteor_runtime_config__ || {}).ROOT_URL || '/';\n  }\n\n  const _root = URIBase.replace(/\\/+$/, '');\n  const vRef = (fileRef.versions && fileRef.versions[version]) || fileRef || {};\n\n  let ext;\n  if (helpers.isString(vRef.extension)) {\n    ext = `.${vRef.extension.replace(/^\\./, '')}`;\n  } else {\n    ext = '';\n  }\n\n  if (fileRef.public === true) {\n    return _root + (version === 'original' ? `${fileRef._downloadRoute}/${fileRef._id}${ext}` : `${fileRef._downloadRoute}/${version}-${fileRef._id}${ext}`);\n  }\n  return _root + `${fileRef._downloadRoute}/${fileRef._collectionName}/${fileRef._id}/${version}/${fileRef._id}${ext}`;\n};\n\nexport { fixJSONParse, fixJSONStringify, formatFleURL, helpers };\n","import fs          from 'fs-extra';\nimport { Meteor }  from 'meteor/meteor';\nimport { helpers } from './lib.js';\nconst NOOP = () => {};\n\n/*\n * @const {Object} bound   - Meteor.bindEnvironment (Fiber wrapper)\n * @const {Object} fdCache - File Descriptors Cache\n */\nconst bound   = Meteor.bindEnvironment(callback => callback());\nconst fdCache = {};\n\n/*\n * @private\n * @locus Server\n * @class WriteStream\n * @param path      {String} - Path to file on FS\n * @param maxLength {Number} - Max amount of chunks in stream\n * @param file      {Object} - fileRef Object\n * @summary writableStream wrapper class, makes sure chunks is written in given order. Implementation of queue stream.\n */\nexport default class WriteStream {\n  constructor(path, maxLength, file, permissions) {\n    this.path = path;\n    this.maxLength = maxLength;\n    this.file = file;\n    this.permissions = permissions;\n    if (!this.path || !helpers.isString(this.path)) {\n      return;\n    }\n\n    this.fd            = null;\n    this.writtenChunks = 0;\n    this.ended         = false;\n    this.aborted       = false;\n\n    if (fdCache[this.path] && !fdCache[this.path].ended && !fdCache[this.path].aborted) {\n      this.fd = fdCache[this.path].fd;\n      this.writtenChunks = fdCache[this.path].writtenChunks;\n    } else {\n      fs.ensureFile(this.path, (efError) => {\n        bound(() => {\n          if (efError) {\n            this.abort();\n            throw new Meteor.Error(500, '[FilesCollection] [writeStream] [ensureFile] [Error:] ' + efError);\n          } else {\n            fs.open(this.path, 'r+', this.permissions, (oError, fd) => {\n              bound(() => {\n                if (oError) {\n                  this.abort();\n                  throw new Meteor.Error(500, '[FilesCollection] [writeStream] [ensureFile] [open] [Error:] ' + oError);\n                } else {\n                  this.fd = fd;\n                  fdCache[this.path] = this;\n                }\n              });\n            });\n          }\n        });\n      });\n    }\n  }\n\n  /*\n   * @memberOf writeStream\n   * @name write\n   * @param {Number} num - Chunk position in a stream\n   * @param {Buffer} chunk - Buffer (chunk binary data)\n   * @param {Function} callback - Callback\n   * @summary Write chunk in given order\n   * @returns {Boolean} - True if chunk is sent to stream, false if chunk is set into queue\n   */\n  write(num, chunk, callback) {\n    if (!this.aborted && !this.ended) {\n      if (this.fd) {\n        fs.write(this.fd, chunk, 0, chunk.length, (num - 1) * this.file.chunkSize, (error, written, buffer) => {\n          bound(() => {\n            callback && callback(error, written, buffer);\n            if (error) {\n              console.warn('[FilesCollection] [writeStream] [write] [Error:]', error);\n              this.abort();\n            } else {\n              ++this.writtenChunks;\n            }\n          });\n        });\n      } else {\n        Meteor.setTimeout(() => {\n          this.write(num, chunk, callback);\n        }, 25);\n      }\n    }\n    return false;\n  }\n\n  /*\n   * @memberOf writeStream\n   * @name end\n   * @param {Function} callback - Callback\n   * @summary Finishes writing to writableStream, only after all chunks in queue is written\n   * @returns {Boolean} - True if stream is fulfilled, false if queue is in progress\n   */\n  end(callback) {\n    if (!this.aborted && !this.ended) {\n      if (this.writtenChunks === this.maxLength) {\n        fs.close(this.fd, () => {\n          bound(() => {\n            delete fdCache[this.path];\n            this.ended = true;\n            callback && callback(void 0, true);\n          });\n        });\n        return true;\n      }\n\n      fs.stat(this.path, (error, stat) => {\n        bound(() => {\n          if (!error && stat) {\n            this.writtenChunks = Math.ceil(stat.size / this.file.chunkSize);\n          }\n\n          return Meteor.setTimeout(() => {\n            this.end(callback);\n          }, 25);\n        });\n      });\n    } else {\n      callback && callback(void 0, this.ended);\n    }\n    return false;\n  }\n\n  /*\n   * @memberOf writeStream\n   * @name abort\n   * @param {Function} callback - Callback\n   * @summary Aborts writing to writableStream, removes created file\n   * @returns {Boolean} - True\n   */\n  abort(callback) {\n    this.aborted = true;\n    delete fdCache[this.path];\n    fs.unlink(this.path, (callback || NOOP));\n    return true;\n  }\n\n  /*\n   * @memberOf writeStream\n   * @name stop\n   * @summary Stop writing to writableStream\n   * @returns {Boolean} - True\n   */\n  stop() {\n    this.aborted = true;\n    delete fdCache[this.path];\n    return true;\n  }\n}\n"]}