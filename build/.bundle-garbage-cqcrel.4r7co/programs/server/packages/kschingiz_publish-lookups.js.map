{"version":3,"sources":["meteor://ðŸ’»app/packages/kschingiz:publish-lookups/publish-lookups.js","meteor://ðŸ’»app/packages/kschingiz:publish-lookups/lookup.js","meteor://ðŸ’»app/packages/kschingiz:publish-lookups/utils.js"],"names":["Meteor","module","link","v","PublishLookup","default","Collection","prototype","lookup","selector","options","lookups","collection","debounced","constructor","primaryObserver","undefined","lookupObservers","calculateLookupFields","republishLookups","bind","_getCollectionName","_name","lookupFields","reduce","acc","localField","sub","addedPrimaryDocIds","_documents","get","forEach","observer","stop","primaryDocsIds","Array","from","keys","primaryDocs","find","_id","$in","fields","fetch","localFieldValues","Object","doc","push","map","foreignField","joinQuery","joinedDocsCursor","observeChanges","added","id","changed","removed","_publishCursor","publishLookups","cursor","lookupFieldsKeys","changedKeys","intersection","filter","value","includes","isLookupFieldChanged","length","exportDefault","export","timeoutMs","fn","timeoutId","clearTimeout","setTimeout"],"mappings":"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","file":"/packages/kschingiz_publish-lookups.js","sourcesContent":["import { Meteor } from \"meteor/meteor\";\n\nimport PublishLookup from \"./lookup\";\n\nMeteor.Collection.prototype.lookup = function(selector, options, lookups) {\n  const collection = this;\n\n  return new PublishLookup(collection, selector, options, lookups);\n};\n","import { debounced } from \"./utils\";\n\nclass PublishLookup {\n  constructor(collection, selector, options, lookups) {\n    this.collection = collection;\n    this.selector = selector || {};\n    this.options = options || {};\n    this.lookups = lookups || [];\n    this.primaryObserver = undefined;\n    this.lookupObservers = [];\n\n    this.calculateLookupFields();\n    this.republishLookups = debounced(this.republishLookups.bind(this));\n  }\n\n  _getCollectionName() {\n    return this.collection._name;\n  }\n\n  calculateLookupFields() {\n    const lookupFields = this.lookups.reduce((acc, lookup) => {\n      const { localField } = lookup;\n\n      acc[localField] = 1;\n      return acc;\n    }, {});\n\n    this.lookupFields = lookupFields;\n  }\n\n  republishLookups() {\n    const { collection, sub, lookups, lookupFields } = this;\n\n    const addedPrimaryDocIds = sub._documents.get(collection._name);\n\n    this.lookupObservers.forEach(observer => observer.stop());\n\n    if (addedPrimaryDocIds) {\n      const primaryDocsIds = Array.from(addedPrimaryDocIds.keys());\n\n      const primaryDocs = collection\n        .find({ _id: { $in: primaryDocsIds } }, { fields: lookupFields })\n        .fetch();\n\n      const localFieldValues = Object.keys(lookupFields).reduce(\n        (acc, localField) => {\n          acc[localField] = [];\n\n          primaryDocs.forEach(doc => {\n            if (doc[localField] !== null && doc[localField] !== undefined) {\n              acc[localField].push(doc[localField]);\n            }\n          });\n\n          return acc;\n        },\n        {}\n      );\n\n      this.lookupObservers = lookups.map(\n        ({\n          collection,\n          localField,\n          foreignField,\n          selector = {},\n          options = {}\n        }) => {\n          const joinQuery = {\n            ...selector,\n            [foreignField]: { $in: localFieldValues[localField] }\n          };\n\n          const joinedDocsCursor = collection.find(joinQuery, options);\n\n          const observer = joinedDocsCursor.observeChanges({\n            added: (id, fields) => {\n              sub.added(collection._name, id, fields);\n            },\n            changed: (id, fields) => {\n              sub.changed(collection._name, id, fields);\n            },\n            removed: id => {\n              sub.removed(collection._name, id);\n            }\n          });\n\n          return observer;\n        }\n      );\n    }\n  }\n\n  _publishCursor(sub) {\n    this.sub = sub;\n\n    this.publishLookups();\n\n    return {\n      stop: this.stop.bind(this)\n    };\n  }\n\n  publishLookups() {\n    const { collection, selector, options, sub } = this;\n\n    const cursor = collection.find(selector, options);\n\n    const observer = cursor.observeChanges({\n      added: (id, fields) => {\n        sub.added(collection._name, id, fields);\n\n        this.republishLookups();\n      },\n      changed: (id, fields) => {\n        sub.changed(collection._name, id, fields);\n\n        const lookupFieldsKeys = Object.keys(this.lookupFields);\n        const changedKeys = Object.keys(fields);\n\n        const intersection = lookupFieldsKeys.filter(value =>\n          changedKeys.includes(value)\n        );\n\n        const isLookupFieldChanged = intersection.length > 0;\n\n        if (isLookupFieldChanged) {\n          this.republishLookups();\n        }\n      },\n      removed: id => {\n        sub.removed(collection._name, id);\n\n        this.republishLookups();\n      }\n    });\n\n    this.primaryObserver = observer;\n  }\n\n  stop() {\n    if (primaryObserver) {\n      this.primaryObserver.stop();\n    }\n    this.lookupObservers.forEach(observer => {\n      observer.stop();\n    });\n  }\n}\n\nexport default PublishLookup;\n","import { Meteor } from \"meteor/meteor\";\n\nconst timeoutMs = 100;\nexport const debounced = fn => {\n  let timeoutId = undefined;\n\n  return () => {\n    if (timeoutId) {\n      Meteor.clearTimeout(timeoutId);\n    }\n\n    timeoutId = Meteor.setTimeout(() => {\n      fn();\n    }, timeoutMs);\n  };\n};\n"]}